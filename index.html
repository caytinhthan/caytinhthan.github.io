<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://firebase.googleapis.com https://www.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://*.firebaseio.com https://firebase.googleapis.com https://www.gstatic.com wss://*.firebaseio.com; frame-src https://www.google.com;">
  <title>Cây Tình Thần - Chia sẻ cảm xúc</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <!-- CSS Files -->
  <link rel="stylesheet" href="assets/styles.css">
  <link rel="stylesheet" href="assets/main.css">
  <link rel="stylesheet" href="assets/header.css">
  <link rel="stylesheet" href="assets/tree.css">
  <link rel="stylesheet" href="assets/chat.css">
  <link rel="stylesheet" href="assets/modals.css">
</head>
<body>
  <!-- Header Navigation -->
  <div class="app-header">
    <div class="header-content">
      <div class="header-left">
        <a href="index.html" class="logo">
          <span class="logo-icon">🌱</span>
          <span class="logo-text">Cây Tình Thần</span>
        </a>
      </div>
      
      <div class="header-right" id="headerRight">
        <!-- Auth Container - Centralized auth state management -->
        <div class="auth-container" id="authContainer">
          <!-- When logged out -->
          <div class="auth-section" id="authSection">
            <button class="header-btn login-btn" onclick="window.location.href='login.html'">
              Đăng nhập
            </button>
            <button class="header-btn register-btn" onclick="window.location.href='register.html'">
              Đăng ký
            </button>
          </div>
          
          <!-- When logged in -->
          <div class="user-section" id="userSection" style="display: none;">
            <div class="user-info">
              <div class="user-greeting">
                <span>Xin chào, </span>
                <strong id="userDisplayName"></strong>
              </div>
              <div class="user-actions">
                <button class="header-btn settings-btn" id="settingsBtn">
                  <span>⚙️</span>
                  <span>Cài đặt</span>
                </button>
                <button class="header-btn logout-btn" id="logoutBtn">
                  <span>🚪</span>
                  <span>Đăng xuất</span>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <button class="hamburger" id="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </button>
        
        <!-- Dropdown Menu -->
        <div class="dropdown-menu" id="dropdownMenu">
          <div class="dropdown-item" id="themeToggle">
            <span class="dropdown-icon">🌙</span>
            <span class="dropdown-text">Chế độ tối</span>
          </div>
          <div class="dropdown-item" onclick="navigateToPage('profile.html')">
            <span class="dropdown-icon">👤</span>
            <span class="dropdown-text">Trang cá nhân</span>
          </div>
          <div class="dropdown-item" id="helpModalBtn">
            <span class="dropdown-icon">📖</span>
            <span class="dropdown-text">Hướng dẫn sử dụng</span>
          </div>
          <div class="dropdown-item" id="termsModalBtn">
            <span class="dropdown-icon">📜</span>
            <span class="dropdown-text">Điều khoản</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main class="layout page-transition" id="main-content">
    <!-- Panel trái -->
    <section class="panel left-panel">
      <div class="panel-header">
        <h1>🌱 Cây Thông Điệp</h1>
      </div>
      
      <p class="panel-description">Click vào cây để đặt lá tại vị trí bất kỳ, hoặc tự động thêm lá ngẫu nhiên!</p>
      
      <div class="stats-section">
        <div class="stat-card">
          <div class="stat-icon">🌿</div>
          <div class="stat-content">
            <div class="stat-number" id="counter">0</div>
            <div class="stat-label">Số lá trên cây</div>
          </div>
        </div>
      </div>
      
      <div class="controls">
        <div class="view-mode-section">
          <label class="switch-container">
            <input type="checkbox" id="viewOnlyMode">
            <span class="switch-slider"></span>
            <span class="switch-label">Chế độ chỉ xem</span>
          </label>
        </div>
        
        <div class="action-buttons" id="actionButtons">
          <button class="btn primary" id="add">
            <span class="btn-icon">🎲</span>
            <span class="btn-text">Tự động thêm</span>
          </button>
          <button class="btn secondary" id="toggleMode">
            <span class="btn-icon">🖱️</span>
            <span class="btn-text">Click để đặt</span>
          </button>
          <button class="btn tertiary" id="dragMode">
            <span class="btn-icon">✋</span>
            <span class="btn-text">Kéo thả</span>
          </button>
        </div>
      </div>
      
      <div class="additional-info">
        <div class="info-card">
          <div class="info-icon">💌</div>
          <div class="info-content">
            <h3>Gửi thông điệp yêu thương</h3>
            <p>Trước khi viết lên cây tinh thần, chúng mình mong bạn luôn nhớ rằng: đây là cây của những lời động viên, yêu thương và niềm tin. Mỗi lời bạn để lại sẽ trở thành ánh sáng nhỏ sưởi ấm trái tim một ai đó. Hãy chọn màu sắc riêng cho chiếc lá ứng với vấn đề bạn muốn gửi lời động viên nhé:</p>
            <div class="help-description">
              💸 Tài chính → Xanh lá<br>
              💕 Tình yêu → Hồng<br>
              📚 Học tập → Vàng<br>
              💼 Công việc → Xanh dương<br>
              🤝 Mối quan hệ → Tím<br>
              🌈 Khác → Xanh pastel
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Sân khấu phải -->
    <section class="stage panel" id="stage">
      <!-- Day/Night Scene -->
      <div id="scene">
        <div class="sky"></div>
        <div class="sun"></div>
        <div class="moon"></div>
        <div class="clouds"></div>
        <canvas id="stars"></canvas>
        <div class="grass"></div>
      </div>
      
      <div id="app">
        <img id="tree" src="assets/tree/tree_transparent.png" alt="Cây Tình Thần">
        <canvas id="leafCanvas"></canvas>
      </div>
      <div class="ground"></div>
      <div class="tooltip" id="tip"></div>
    </section>
  </main>

  <!-- Add/Edit Modal -->
  <div class="modal" id="addModal" role="dialog" aria-modal="true" aria-labelledby="addModalTitle">
    <div class="sheet">
      <button class="x" id="closeAddModal" aria-label="Đóng modal">✕</button>
      <h3 id="addModalTitle">🌿 Thêm lá mới</h3>
      <div class="form-section">
        <label>Thông điệp:</label>
        <textarea id="addMessage" placeholder="Nhập thông điệp..."></textarea>
      </div>
      <div class="form-section">
        <label>Tên của bạn:</label>
        <input type="text" id="addAuthor" placeholder="Nhập tên hoặc để trống (ẩn danh)">
      </div>
      <div class="form-section">
        <label class="checkbox-label">
          <input type="checkbox" id="isAnonymous">
          <span>Gửi ẩn danh</span>
        </label>
      </div>
      
      <div class="picker picker-section" id="leafPicker">
        <div class="picker-row">
          <label>Hình dáng lá</label>
          <select id="leafShape">
            <option value="oval">🍃 Oval</option>
            <option value="round">⭕ Tròn</option>
            <option value="oak">🌳 Sồi</option>
            <option value="maple">🍁 Phong</option>
            <option value="heart">💚 Trái tim</option>
            <option value="willow">🌿 Liễu</option>
            <option value="birch">🌲 Bạch dương</option>
            <option value="ginkgo">🟡 Bạch quả</option>
            <option value="elm">🌱 Du</option>
            <option value="bamboo">🎋 Tre</option>
            <option value="fern">🌿 Dương xỉ</option>
            <option value="cherry">🌸 Anh đào</option>
          </select>
        </div>

        <div class="picker-row">
          <label style="font-weight:600">Chủ đề thông điệp</label>
          <select id="leafPalette">
            <option value="0">💰 Tiền bạc → Xanh pastel</option>
            <option value="1">💕 Tình yêu → Hồng pastel</option>
            <option value="2">📚 Học tập → Vàng pastel</option>
            <option value="3">💼 Công việc → Xanh dương pastel</option>
            <option value="4">👥 Mối quan hệ → Tím pastel</option>
            <option value="5">🌟 Khác → Xanh lá pastel nhạt</option>
          </select>
        </div>

        <div class="picker-row">
          <label style="font-weight:600">Kích cỡ</label>
          <input type="range" id="leafScale" min="0.8" max="1.4" step="0.05" value="1">
        </div>

        <div class="picker-row">
          <label style="font-weight:600">Góc xoay</label>
          <input type="range" id="leafRotation" min="-25" max="25" step="1" value="0">
        </div>

        <div class="preview" id="leafPreview"></div>
      </div>
      
      <div style="display:flex;gap:12px;margin-top:20px">
        <button class="btn primary" id="saveLeaf" style="flex:1">💾 Lưu</button>
        <button class="btn secondary" id="cancelAdd" style="flex:1">❌ Hủy</button>
      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div class="modal" id="helpModal" role="dialog" aria-modal="true">
    <div class="sheet">
      <button class="x" id="closeHelpModal" aria-label="Đóng hướng dẫn">✕</button>
      <h3>❓ Hướng dẫn sử dụng</h3>
      <div class="help-content">
        <div class="help-section">
          <h4>🌿 Cách thêm lá:</h4>
          <ul>
            <li><strong>Tự động thêm:</strong> Nhấn nút "🎲 Tự động thêm" để thêm lá ở vị trí ngẫu nhiên</li>
            <li><strong>Click để đặt:</strong> Bật chế độ này và click vào cây để đặt lá chính xác</li>
          </ul>
        </div>
        <div class="help-section">
          <h4>✏️ Tương tác với lá:</h4>
          <ul>
            <li><strong>Xem thông điệp:</strong> Click vào bất kỳ chiếc lá nào để đọc nội dung</li>
            <li><strong>Kéo thả:</strong> Bật chế độ kéo thả và giữ lá để di chuyển vị trí</li>
            <li><strong>Sửa nội dung:</strong> Trong popup xem lá, bạn có thể chỉnh sửa thông điệp</li>
          </ul>
        </div>
        <div class="help-section">
          <h4>👁️ Chế độ chỉ xem:</h4>
          <p>Bật để khóa tất cả chức năng chỉnh sửa, chỉ cho phép xem thông điệp.</p>
        </div>
        <div class="help-section">
          <h4>🎨 Tùy chỉnh lá:</h4>
          <p>Khi thêm lá mới, bạn có thể chọn hình dáng, màu sắc, kích thước và góc xoay.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Terms Modal -->
  <div class="modal" id="termsModal" role="dialog" aria-modal="true">
    <div class="sheet">
      <button class="x" id="closeTermsModal" aria-label="Đóng điều khoản">✕</button>
      <h3>📜 Điều khoản</h3>
      <div class="help-content">
        <p style="line-height: 1.6; margin-bottom: 16px;">
          Trong guồng quay tất bật của cuộc sống, đôi khi chúng ta quên rằng hạnh phúc có thể đến từ những điều giản dị nhất. Dự án Peace by Piece ra đời để gửi gắm những lời yêu thương, động viên và hy vọng – như từng chiếc lá nhỏ mang trong mình thông điệp bình yên.
        </p>
        <p style="line-height: 1.6;">
          Hãy để mỗi nụ cười, mỗi lời chia sẻ trở thành một mảnh ghép góp phần tạo nên bức tranh hạnh phúc trọn vẹn. 💌
        </p>
      </div>
    </div>
  </div>

  <!-- Project Info Modal -->
  <div class="modal" id="projectInfoModal" role="dialog" aria-modal="true">
    <div class="sheet">
      <button class="x" id="closeProjectInfoModal" aria-label="Đóng thông tin dự án">✕</button>
      <h3>🌿 Cây tinh thần</h3>
      <div class="help-content">
        <p style="line-height: 1.6; margin-bottom: 16px;">
          Trong guồng quay tất bật của cuộc sống, đôi khi chúng ta quên rằng hạnh phúc có thể đến từ những điều giản dị nhất. Dự án Peace by Piece ra đời để gửi gắm những lời yêu thương, động viên và hy vọng – như từng chiếc lá nhỏ mang trong mình thông điệp bình yên.
        </p>
        <p style="line-height: 1.6;">
          Hãy để mỗi nụ cười, mỗi lời chia sẻ trở thành một mảnh ghép góp phần tạo nên bức tranh hạnh phúc trọn vẹn. 💌
        </p>
      </div>
    </div>
  </div>

  <!-- View Modal -->
  <div class="modal" id="modal" role="dialog" aria-modal="true">
    <div class="sheet">
      <button class="x" id="closeModal" aria-label="Đóng modal">✕</button>
      <h3>💌 Thông điệp</h3>
      <div class="leaf-card">
        <div class="leaf-text">
          <p id="modalText"></p>
          <p id="modalAuthor"></p>
        </div>
      </div>
      <div class="leaf-actions">
        <button id="editLeaf" class="btn green">✏️ Sửa</button>
        <button id="deleteLeaf" class="btn red" style="display: none;">🗑️ Xóa</button>
      </div>
    </div>
  </div>

  <script type="module" src="src/firebase-init.mjs"></script>
  <script type="module" src="src/auth-guard.mjs"></script>
  <script type="module" src="src/ui.mjs"></script>
  <script src="src/script.js" defer></script>
  <script type="module">
    import { initAuthGuard } from './src/auth-guard.mjs';
    import { logout } from './src/auth.mjs';
    
    initAuthGuard();
    
    // Setup logout button
    document.addEventListener('DOMContentLoaded', () => {
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try {
            await logout();
            window.location.href = 'index.html';
          } catch (error) {
            console.error('Logout error:', error);
            alert('Lỗi đăng xuất: ' + error.message);
          }
        });
      }
    });
  </script>
  <script>
    // Page transition function
    function navigateToPage(url) {
      document.body.classList.add('page-fade-out');
      setTimeout(() => {
        window.location.href = url;
      }, 250);
    }

    // Single DOMContentLoaded handler
    document.addEventListener('DOMContentLoaded', () => {
      
      // Add page transition on load
      const mainContent = document.getElementById('main-content');
      if (mainContent) {
        mainContent.classList.add('page-transition');
      }
      
      const dropdownMenu = document.getElementById('dropdownMenu');
      
      // Set up dropdown first so elements are accessible
      dropdownMenu.style.display = 'block';
      dropdownMenu.style.visibility = 'hidden';
      
      const themeToggle = document.getElementById('themeToggle');
      const helpModalBtn = document.getElementById('helpModalBtn');
      const termsModalBtn = document.getElementById('termsModalBtn');
      
      // Toggle dropdown menu - hamburger button
      const hamburger = document.getElementById('hamburger');
      if (hamburger) {
        hamburger.addEventListener('click', (e) => {
          e.stopPropagation();
          if (dropdownMenu.classList.contains('show')) {
            dropdownMenu.classList.remove('show');
          } else {
            dropdownMenu.style.visibility = 'visible';
            dropdownMenu.classList.add('show');
          }
        });
      }
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!dropdownMenu.contains(e.target) && 
            !e.target.closest('.hamburger')) {
          dropdownMenu.classList.remove('show');
        }
      });
      
      // Theme toggle functionality
      if (themeToggle) {
        const themeIcon = themeToggle.querySelector('.dropdown-icon');
        const themeText = themeToggle.querySelector('.dropdown-text');

        const updateThemeUI = () => {
          const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
          if (isDark) {
            if (themeIcon) themeIcon.textContent = '☀️';
            if (themeText) themeText.textContent = 'Chế độ sáng';
          } else {
            if (themeIcon) themeIcon.textContent = '🌙';
            if (themeText) themeText.textContent = 'Chế độ tối';
          }
        };

        // Set initial theme on page load
        const currentTheme = localStorage.getItem('theme');
        if (currentTheme === 'dark') {
          document.documentElement.setAttribute('data-theme', 'dark');
          document.documentElement.classList.add('theme-night');
          document.documentElement.classList.remove('theme-day');
        } else {
          document.documentElement.removeAttribute('data-theme');
          document.documentElement.classList.add('theme-day');
          document.documentElement.classList.remove('theme-night');
        }
        updateThemeUI();

        themeToggle.addEventListener('click', () => {
          const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
          if (isDark) {
            document.documentElement.removeAttribute('data-theme');
            document.documentElement.classList.remove('theme-night');
            document.documentElement.classList.add('theme-day');
            localStorage.setItem('theme', 'light');
          } else {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.documentElement.classList.remove('theme-day');
            document.documentElement.classList.add('theme-night');
            localStorage.setItem('theme', 'dark');
          }
          
          window.dispatchEvent(new CustomEvent('theme-change', { 
            detail: { theme: isDark ? 'light' : 'dark' } 
          }));
          
          updateThemeUI();
          dropdownMenu.classList.remove('show');
        });
      }
      
      // Help modal
      if (helpModalBtn) {
        helpModalBtn.addEventListener('click', () => {
          dropdownMenu.classList.remove('show');
          const helpModal = document.getElementById('helpModal');
          if (helpModal) {
            helpModal.style.display = 'flex';
            helpModal.classList.add('show');
            document.body.style.overflow = 'hidden';
          }
        });
      }
      
      // Terms modal  
      if (termsModalBtn) {
        termsModalBtn.addEventListener('click', () => {
          dropdownMenu.classList.remove('show');
          const termsModal = document.getElementById('termsModal');
          if (termsModal) {
            termsModal.style.display = 'flex';
            termsModal.classList.add('show');
            document.body.style.overflow = 'hidden';
          }
        });
      }

      // Modal close handlers
      const closeHelp = document.getElementById('closeHelpModal');
      const closeTerms = document.getElementById('closeTermsModal');
      const closeProject = document.getElementById('closeProjectInfoModal');
      const helpModal = document.getElementById('helpModal');
      const termsModal = document.getElementById('termsModal');
      const projectModal = document.getElementById('projectInfoModal');

      if (closeHelp && helpModal) {
        closeHelp.addEventListener('click', () => {
          helpModal.style.display = 'none';
          helpModal.classList.remove('show');
          document.body.style.overflow = 'auto';
        });
      }

      if (closeTerms && termsModal) {
        closeTerms.addEventListener('click', () => {
          termsModal.style.display = 'none';
          termsModal.classList.remove('show');
          document.body.style.overflow = 'auto';
        });
      }

      if (closeProject && projectModal) {
        closeProject.addEventListener('click', () => {
          projectModal.style.display = 'none';
          projectModal.classList.remove('show');
          document.body.style.overflow = 'auto';
        });
      }

      // Close modals when clicking outside
      [helpModal, termsModal, projectModal].forEach(modal => {
        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.style.display = 'none';
              modal.classList.remove('show');
              document.body.style.overflow = 'auto';
            }
          });
        }
      });
    });
  </script>
  
</body>
</html>