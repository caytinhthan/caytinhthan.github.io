<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://firebase.googleapis.com https://www.google.com https://www.recaptcha.net https://apis.google.com https://apis.google.com/js/ https://*.firebasedatabase.app; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://*.firebaseio.com https://firebase.googleapis.com https://identitytoolkit.googleapis.com https://content-firebaseappcheck.googleapis.com https://www.google.com https://www.recaptcha.net https://www.gstatic.com https://accounts.google.com wss://*.firebaseio.com wss://*.firebasedatabase.app https://*.firebasedatabase.app; frame-src https://www.google.com https://www.recaptcha.net https://accounts.google.com https://*.firebasedatabase.app;";>
  <title>Trang chá»§ | CÃ¢y TÃ¬nh Tháº§n - Chia sáº» cáº£m xÃºc</title>


  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <!-- CSS Files -->
  <link rel="stylesheet" href="assets/styles.css">
  <link rel="stylesheet" href="assets/main.css">
  <link rel="stylesheet" href="assets/header.css">
  <link rel="stylesheet" href="assets/tree.css">
  <link rel="stylesheet" href="assets/chat.css">
  <link rel="stylesheet" href="assets/modals.css">
  <link rel="stylesheet" href="assets/leaves.css">
</head>
<body>
  <!-- Header Navigation -->
  <div class="app-header">
    <div class="header-content">
      <div class="header-left">
        <a href="index.html" class="logo">
          <span class="logo-icon">ğŸŒ±</span>
          <span class="logo-text">CÃ¢y TÃ¬nh Tháº§n</span>
        </a>
      </div>
      
      <div class="header-right" id="headerRight">
        <!-- Auth Container - Centralized auth state management -->
        <div class="auth-container" id="authContainer">
          <!-- When logged out -->
          <div class="auth-section" id="authSection" style="display: none;">
            <button class="header-btn login-btn" onclick="window.location.href='login.html'">
              ÄÄƒng nháº­p
            </button>
            <button class="header-btn register-btn" onclick="window.location.href='register.html'">
              ÄÄƒng kÃ½
            </button>
          </div>
          
          <!-- Loading state - Hiá»‡n khi Ä‘ang check auth -->
          <div class="auth-loading" id="authLoading" style="display: flex;">
            <span style="color: #64748b; font-size: 14px;">Äang táº£i...</span>
          </div>
          
          <!-- When logged in -->
          <div class="user-section" id="userSection" style="display: none;">
            <div class="user-info">
              <div class="user-greeting">
                <span>Xin chÃ o, </span>
                <strong id="userDisplayName"></strong>
              </div>
              <div class="user-actions">
                        <button class="header-btn settings-btn" id="settingsBtn" title="Trang cÃ¡ nhÃ¢n">
                          <span>âš™ï¸</span>
                          <span>CÃ¡ nhÃ¢n</span>
                        </button>
                        <button class="header-btn logout-btn" id="logoutBtn">
                          <span>ğŸšª</span>
                          <span>ÄÄƒng xuáº¥t</span>
                        </button>
              </div>
            </div>
          </div>
        </div>
        
        <button class="hamburger" id="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </button>
        
        <!-- Dropdown Menu -->
        <div class="dropdown-menu" id="dropdownMenu">
          <div class="dropdown-item" id="themeToggle">
            <span class="dropdown-icon">ğŸŒ™</span>
            <span class="dropdown-text">Cháº¿ Ä‘á»™ tá»‘i</span>
          </div>
          <div class="dropdown-item admin-only" onclick="navigateToPage('admin.html')" style="display: none;">
            <span class="dropdown-icon">ğŸ›¡ï¸</span>
            <span class="dropdown-text">Quáº£n trá»‹ viÃªn</span>
          </div>
          <div class="dropdown-item" id="helpModalBtn">
            <span class="dropdown-icon">ğŸ“–</span>
            <span class="dropdown-text">HÆ°á»›ng dáº«n sá»­ dá»¥ng</span>
          </div>
          <div class="dropdown-item" id="termsModalBtn">
            <span class="dropdown-icon">ğŸ“œ</span>
            <span class="dropdown-text">Äiá»u khoáº£n</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main class="layout page-transition" id="main-content">
    <!-- Panel trÃ¡i -->
    <section class="panel left-panel">
      <div class="panel-header">
        <h1>ğŸŒ± CÃ¢y ThÃ´ng Äiá»‡p</h1>
      </div>
      
      <div class="panel-description">
        <p>ChÃ o báº¡n ğŸŒ¼<br>
        Náº¿u báº¡n váº«n chÆ°a cáº£m tháº¥y á»•n, vÃ  cÃ³ nhiá»u Ä‘iá»u chÆ°a thá»ƒ nÃ³i ra â€” Ä‘á»«ng chá»‹u Ä‘á»±ng má»™t mÃ¬nh nhÃ©.. ChÃºng mÃ¬nh sáº½ giÃºp báº¡n káº¿t ná»‘i trá»±c tiáº¿p vá»›i <strong>HáººM 202</strong> [Bá»˜ PHáº¬N TÆ¯ Váº¤N TÃ‚M LÃ Táº I TRÆ¯á»œNG ÄH FPT TP.HCM]. ÄÃ¢y lÃ  nÆ¡i báº¡n cÃ³ thá»ƒ thoáº£i mÃ¡i chia sáº» cáº£m xÃºc cÃ¹ng cÃ¡n bá»™ tÃ¢m lÃ½ giÃ u kinh nghiá»‡m, luÃ´n sáºµn sÃ ng láº¯ng nghe vÃ  Ä‘á»“ng hÃ nh cÃ¹ng báº¡n.</p>

        <p>Äá»«ng ngáº§n ngáº¡i má»Ÿ lÃ²ng nhÃ© â€” nháº¥n vÃ o nÃºt bÃªn dÆ°á»›i Ä‘á»ƒ báº¯t Ä‘áº§u ğŸ’›</p>

        <div style="display:flex;gap:8px;margin-top:10px;flex-direction:column;">
          <button class="btn primary" id="hemConnectBtn">CÃ³, mÃ¬nh muá»‘n Ä‘Æ°á»£c káº¿t ná»‘i</button>
          <button class="btn secondary" id="hemNotNowBtn">MÃ¬nh á»•n rá»“i</button>
        </div>

        <!-- Responses (hidden) - JS can show the appropriate block after user selection -->
        <div id="hemResponse" style="display:none;margin-top:12px;">
          <div id="hemConnectResponse" style="display:none;">
            <p>ğŸ’› Cáº£m Æ¡n báº¡n vÃ¬ Ä‘Ã£ má»Ÿ lÃ²ng. DÃ¹ báº¡n Ä‘ang tráº£i qua Ä‘iá»u gÃ¬, chÃºng mÃ¬nh luÃ´n á»Ÿ Ä‘Ã¢y giÃºp báº¡n Ä‘Æ°á»£c láº¯ng nghe vÃ  Ä‘á»“ng hÃ nh cÃ¹ng báº¡n. Báº¡n cÃ³ thá»ƒ báº¯t Ä‘áº§u cuá»™c trÃ² chuyá»‡n trá»±c tiáº¿p vá»›i cÃ¡n bá»™ tÆ° váº¥n tÃ¢m lÃ½ táº¡i Háº»m 202 nhÃ©:</p>
            <p><a href="https://www.facebook.com/phongtvtlfpthcm" target="_blank" rel="noopener">ğŸ‘‰ Káº¿t ná»‘i vá»›i Háº»m 202</a></p>
            <p><small>Háº»m 202 hoáº¡t Ä‘á»™ng theo nguyÃªn táº¯c "Tháº¥u hiá»ƒu, tÃ´n trá»ng vÃ  báº£o máº­t". Má»i cÃ¢u chuyá»‡n cá»§a báº¡n lÃ  cá»§a báº¡n, chÃºng mÃ¬nh khÃ´ng phÃ¡n xÃ©t mÃ  chá»‰ Ä‘á»“ng hÃ nh.</small></p>
          </div>

          <div id="hemNotNowResponse" style="display:none;">
            <p>ChÃºng mÃ¬nh ráº¥t vui khi biáº¿t báº¡n Ä‘ang cáº£m tháº¥y á»•n hÆ¡n ğŸŒ». Náº¿u má»™t lÃºc nÃ o Ä‘Ã³ báº¡n cÃ³ trÄƒn trá»Ÿ hay phiá»n lÃ²ng, Ä‘á»«ng ngáº§n ngáº¡i tÃ¬m Ä‘áº¿n chÃºng mÃ¬nh â€” chÃºng mÃ¬nh luÃ´n sáºµn sÃ ng há»— trá»£. ğŸ’Œ</p>
          </div>
        </div>
      </div>
      
      <div class="stats-section">
        <div class="stat-card">
          <div class="stat-icon">ğŸŒ¿</div>
          <div class="stat-content">
            <div class="stat-number" id="counter">0</div>
            <div class="stat-label">Sá»‘ lÃ¡ trÃªn cÃ¢y</div>
          </div>
        </div>
      </div>
      
      <div class="controls">
        <div class="view-mode-section">
          <label class="switch-container">
            <input type="checkbox" id="viewOnlyMode">
            <span class="switch-slider"></span>
            <span class="switch-label">Cháº¿ Ä‘á»™ chá»‰ xem</span>
          </label>
        </div>
        
        <div class="action-buttons" id="actionButtons">
          <button class="btn primary" id="add">
            <span class="btn-icon">ğŸ²</span>
            <span class="btn-text">Tá»± Ä‘á»™ng thÃªm</span>
          </button>
          <button class="btn secondary" id="toggleMode">
            <span class="btn-icon">ğŸ–±ï¸</span>
            <span class="btn-text">Click Ä‘á»ƒ Ä‘áº·t</span>
          </button>
          <button class="btn tertiary" id="dragMode">
            <span class="btn-icon">âœ‹</span>
            <span class="btn-text">KÃ©o tháº£</span>
          </button>
        </div>
      </div>
      
      <div class="additional-info">
        <div class="info-card">
          <div class="info-icon">ğŸ’Œ</div>
          <div class="info-content">
            <h3>Gá»­i thÃ´ng Ä‘iá»‡p yÃªu thÆ°Æ¡ng</h3>
            <p>TrÆ°á»›c khi viáº¿t lÃªn cÃ¢y tinh tháº§n, chÃºng mÃ¬nh mong báº¡n luÃ´n nhá»› ráº±ng: Ä‘Ã¢y lÃ  cÃ¢y cá»§a nhá»¯ng lá»i Ä‘á»™ng viÃªn, yÃªu thÆ°Æ¡ng vÃ  niá»m tin. Má»—i lá»i báº¡n Ä‘á»ƒ láº¡i sáº½ trá»Ÿ thÃ nh Ã¡nh sÃ¡ng nhá» sÆ°á»Ÿi áº¥m trÃ¡i tim má»™t ai Ä‘Ã³. HÃ£y chá»n mÃ u sáº¯c riÃªng cho chiáº¿c lÃ¡ á»©ng vá»›i váº¥n Ä‘á» báº¡n muá»‘n gá»­i lá»i Ä‘á»™ng viÃªn nhÃ©:</p>
            <!-- Color-to-topic mapping removed as requested -->
          </div>
        </div>
      </div>
    </section>

    <!-- SÃ¢n kháº¥u pháº£i -->
    <section class="stage panel" id="stage">
      <!-- Day/Night Scene -->
      <div id="scene">
        <div class="sky"></div>
        <div class="sun"></div>
        <div class="moon"></div>
        <div class="clouds"></div>
        <canvas id="stars"></canvas>
        <div class="grass"></div>
      </div>
      
      <div id="app">
        <img id="tree" src="assets/tree/tree_transparent.png" alt="CÃ¢y TÃ¬nh Tháº§n">
        <canvas id="leafCanvas"></canvas>
        <svg id="leafSvg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: auto;">
          <g id="leaves"></g>
        </svg>
      </div>
      <div class="ground"></div>
      <div class="tooltip" id="tip"></div>
    </section>
  </main>

  <!-- Logout Confirmation Modal -->
  <div class="modal" id="logoutModal" role="dialog" aria-modal="true" style="display:none;">
    <div class="sheet">
      <button class="x" id="closeLogoutModal" aria-label="ÄÃ³ng modal">âœ•</button>
      <h3>ğŸ”’ XÃ¡c nháº­n Ä‘Äƒng xuáº¥t</h3>
      <p style="color:var(--text-secondary);">Báº¡n cÃ³ cháº¯c muá»‘n Ä‘Äƒng xuáº¥t khá»i tÃ i khoáº£n cá»§a mÃ¬nh? Báº¡n sáº½ cáº§n Ä‘Äƒng nháº­p láº¡i Ä‘á»ƒ tiáº¿p tá»¥c Ä‘Äƒng lÃ¡.</p>
      <div style="display:flex;gap:12px;margin-top:18px;">
        <button class="btn red" id="confirmLogout" style="flex:1">ÄÄƒng xuáº¥t</button>
        <button class="btn secondary" id="cancelLogout" style="flex:1">Há»§y</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div class="modal" id="addModal" role="dialog" aria-modal="true" aria-labelledby="addModalTitle">
    <div class="sheet">
      <button class="x" id="closeAddModal" aria-label="ÄÃ³ng modal">âœ•</button>
      <h3 id="addModalTitle">ğŸŒ¿ ThÃªm lÃ¡ má»›i</h3>
      <div class="form-section">
        <label>ThÃ´ng Ä‘iá»‡p:</label>
        <textarea id="addMessage" placeholder="Nháº­p thÃ´ng Ä‘iá»‡p..."></textarea>
      </div>
      <div class="form-section">
        <label>TÃªn cá»§a báº¡n:</label>
        <input type="text" id="addAuthor" placeholder="Nháº­p tÃªn hoáº·c Ä‘á»ƒ trá»‘ng (áº©n danh)">
      </div>
      <div class="form-section">
        <label class="checkbox-label">
          <input type="checkbox" id="isAnonymous">
          <span>Gá»­i áº©n danh</span>
        </label>
      </div>
      <div class="form-section">
        <label class="checkbox-label">
          <input type="checkbox" id="isWithered">
          <span>ÄÄƒng lÃ¡ hÃ©o (TÃ´i cáº§n Ä‘á»™ng viÃªn)</span>
        </label>
      </div>
      <div class="form-section" id="witherTypeRow" style="display:none;">
        <label>Loáº¡i lÃ¡ hÃ©o</label>
        <select id="witherType" style="width:100%">
          <option value="dry_brown">ğŸ‚ KhÃ´ - dry_brown</option>
          <option value="transition_yellow">ğŸ Chuyá»ƒn - transition_yellow</option>
        </select>
      </div>
      
      <div class="picker picker-section" id="leafPicker">
        <div class="picker-row">
          <label>HÃ¬nh dÃ¡ng lÃ¡</label>
          <select id="leafShape">
            <option value="oval">ğŸ¥š HÃ¬nh báº§u dá»¥c</option>
            <option value="round">â­• HÃ¬nh trÃ²n</option>
            <option value="pointed">ï¿½ Nhá»n</option>
            <option value="heart">ğŸ’– HÃ¬nh tim</option>
            <option value="star">â­ HÃ¬nh sao</option>
            <option value="maple">ğŸ LÃ¡ phong</option>
            <option value="willow">ğŸŒ¿ LÃ¡ liá»…u</option>
          </select>
        </div>

        <div class="picker-row">
          <label style="font-weight:600">MÃ u sáº¯c lÃ¡</label>
          <select id="leafPalette">
            <option value="0">ğŸ’› VÃ ng</option>
            <option value="1">ï¿½ Há»“ng</option>
            <option value="2">ğŸ’š Xanh lÃ¡</option>
            <option value="3">ğŸ’™ Xanh dÆ°Æ¡ng</option>
            <option value="4">ï¿½ TÃ­m</option>
            <option value="5">â¤ï¸ Äá»</option>
          </select>
        </div>

        <div class="picker-row">
          <label>KÃ­ch thÆ°á»›c</label>
          <div style="display: flex; align-items: center; gap: 8px;">
            <input type="range" id="leafScale" min="0.7" max="1.8" step="0.1" value="1.0" style="flex: 1;">
            <span id="scaleValue" style="min-width: 35px; font-size: 12px; color: var(--text-secondary);">1.0x</span>
          </div>
        </div>

        <div class="picker-row">
          <label>Äá»™ xoay</label>
          <div style="display: flex; align-items: center; gap: 8px;">
            <input type="range" id="leafRotation" min="-45" max="45" step="5" value="0" style="flex: 1;">
            <span id="rotationValue" style="min-width: 35px; font-size: 12px; color: var(--text-secondary);">0Â°</span>
          </div>
        </div>

  <div class="preview extra-large" id="leafPreview">
          <div class="preview-label">Xem trÆ°á»›c:</div>
          <div class="preview-leaf" style="display: flex; justify-content: center; align-items: center; height: 120px; padding: 0;">
            <!-- Wrap the image so rotation/scale only affects the image itself -->
            <div class="preview-image-wrap">
              <img id="previewLeafImage" class="preview-image fill-frame" src="assets/leaves/oval/leaf_oval_yellow.png" alt="Preview" width="140" height="140" style="object-fit: contain; filter: drop-shadow(2px 2px 6px rgba(0,0,0,0.35)); transition: transform 0.12s ease, width 0.12s ease, height 0.12s ease;">
            </div>
          </div>
        </div>
      </div>
      
      <div style="display:flex;gap:12px;margin-top:20px">
        <button class="btn primary" id="saveLeaf" style="flex:1">ğŸ’¾ LÆ°u</button>
        <button class="btn secondary" id="cancelAdd" style="flex:1">âŒ Há»§y</button>
      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div class="modal" id="helpModal" role="dialog" aria-modal="true">
    <div class="sheet">
      <button class="x" id="closeHelpModal" aria-label="ÄÃ³ng hÆ°á»›ng dáº«n">âœ•</button>
      <h3>â“ HÆ°á»›ng dáº«n sá»­ dá»¥ng</h3>
      <div class="help-content">
        <div class="help-section">
          <h4>ğŸŒ¿ CÃ¡ch thÃªm lÃ¡:</h4>
          <ul>
            <li><strong>Tá»± Ä‘á»™ng thÃªm:</strong> Nháº¥n nÃºt "ğŸ² Tá»± Ä‘á»™ng thÃªm" Ä‘á»ƒ thÃªm lÃ¡ á»Ÿ vá»‹ trÃ­ ngáº«u nhiÃªn</li>
            <li><strong>Click Ä‘á»ƒ Ä‘áº·t:</strong> Báº­t cháº¿ Ä‘á»™ nÃ y vÃ  click vÃ o cÃ¢y Ä‘á»ƒ Ä‘áº·t lÃ¡ chÃ­nh xÃ¡c</li>
          </ul>
        </div>
        <div class="help-section">
          <h4>âœï¸ TÆ°Æ¡ng tÃ¡c vá»›i lÃ¡:</h4>
          <ul>
            <li><strong>Xem thÃ´ng Ä‘iá»‡p:</strong> Click vÃ o báº¥t ká»³ chiáº¿c lÃ¡ nÃ o Ä‘á»ƒ Ä‘á»c ná»™i dung</li>
            <li><strong>KÃ©o tháº£:</strong> Báº­t cháº¿ Ä‘á»™ kÃ©o tháº£ vÃ  giá»¯ lÃ¡ Ä‘á»ƒ di chuyá»ƒn vá»‹ trÃ­</li>
            <li><strong>Sá»­a ná»™i dung:</strong> Trong popup xem lÃ¡, báº¡n cÃ³ thá»ƒ chá»‰nh sá»­a thÃ´ng Ä‘iá»‡p</li>
          </ul>
        </div>
        <div class="help-section">
          <h4>ğŸ‘ï¸ Cháº¿ Ä‘á»™ chá»‰ xem:</h4>
          <p>Báº­t Ä‘á»ƒ khÃ³a táº¥t cáº£ chá»©c nÄƒng chá»‰nh sá»­a, chá»‰ cho phÃ©p xem thÃ´ng Ä‘iá»‡p.</p>
        </div>
        <div class="help-section">
          <h4>ğŸ¨ TÃ¹y chá»‰nh lÃ¡:</h4>
          <p>Khi thÃªm lÃ¡ má»›i, báº¡n cÃ³ thá»ƒ chá»n hÃ¬nh dÃ¡ng, mÃ u sáº¯c, kÃ­ch thÆ°á»›c vÃ  gÃ³c xoay.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Terms Modal -->
  <div class="modal" id="termsModal" role="dialog" aria-modal="true">
    <div class="sheet">
      <button class="x" id="closeTermsModal" aria-label="ÄÃ³ng Ä‘iá»u khoáº£n">âœ•</button>
      <h3>ğŸ“œ Äiá»u khoáº£n</h3>
      <div class="help-content">
        <p style="line-height: 1.6; margin-bottom: 16px;">
          Trong guá»“ng quay táº¥t báº­t cá»§a cuá»™c sá»‘ng, Ä‘Ã´i khi chÃºng ta quÃªn ráº±ng háº¡nh phÃºc cÃ³ thá»ƒ Ä‘áº¿n tá»« nhá»¯ng Ä‘iá»u giáº£n dá»‹ nháº¥t. Dá»± Ã¡n Peace by Piece ra Ä‘á»i Ä‘á»ƒ gá»­i gáº¯m nhá»¯ng lá»i yÃªu thÆ°Æ¡ng, Ä‘á»™ng viÃªn vÃ  hy vá»ng â€“ nhÆ° tá»«ng chiáº¿c lÃ¡ nhá» mang trong mÃ¬nh thÃ´ng Ä‘iá»‡p bÃ¬nh yÃªn.
        </p>
        <p style="line-height: 1.6;">
          HÃ£y Ä‘á»ƒ má»—i ná»¥ cÆ°á»i, má»—i lá»i chia sáº» trá»Ÿ thÃ nh má»™t máº£nh ghÃ©p gÃ³p pháº§n táº¡o nÃªn bá»©c tranh háº¡nh phÃºc trá»n váº¹n. ğŸ’Œ
        </p>
      </div>
    </div>
  </div>

  <!-- Project Info Modal -->
  <div class="modal" id="projectInfoModal" role="dialog" aria-modal="true">
    <div class="sheet">
      <button class="x" id="closeProjectInfoModal" aria-label="ÄÃ³ng thÃ´ng tin dá»± Ã¡n">âœ•</button>
      <h3>ğŸŒ¿ CÃ¢y tinh tháº§n</h3>
      <div class="help-content">
        <p style="line-height: 1.6; margin-bottom: 16px;">
          Trong guá»“ng quay táº¥t báº­t cá»§a cuá»™c sá»‘ng, Ä‘Ã´i khi chÃºng ta quÃªn ráº±ng háº¡nh phÃºc cÃ³ thá»ƒ Ä‘áº¿n tá»« nhá»¯ng Ä‘iá»u giáº£n dá»‹ nháº¥t. Dá»± Ã¡n Peace by Piece ra Ä‘á»i Ä‘á»ƒ gá»­i gáº¯m nhá»¯ng lá»i yÃªu thÆ°Æ¡ng, Ä‘á»™ng viÃªn vÃ  hy vá»ng â€“ nhÆ° tá»«ng chiáº¿c lÃ¡ nhá» mang trong mÃ¬nh thÃ´ng Ä‘iá»‡p bÃ¬nh yÃªn.
        </p>
        <p style="line-height: 1.6;">
          HÃ£y Ä‘á»ƒ má»—i ná»¥ cÆ°á»i, má»—i lá»i chia sáº» trá»Ÿ thÃ nh má»™t máº£nh ghÃ©p gÃ³p pháº§n táº¡o nÃªn bá»©c tranh háº¡nh phÃºc trá»n váº¹n. ğŸ’Œ
        </p>
      </div>
    </div>
  </div>

  <!-- View Modal -->
  <div class="modal" id="modal" role="dialog" aria-modal="true">
    <div class="sheet">
      <button class="x" id="closeModal" aria-label="ÄÃ³ng modal">âœ•</button>
      <h3>ğŸ’Œ ThÃ´ng Ä‘iá»‡p</h3>
      <div class="leaf-card">
        <div class="leaf-text">
          <p id="modalText"></p>
          <p id="modalAuthor"></p>
        </div>
      </div>
      <div class="leaf-actions">
        <div id="encourageSection" style="display:none; margin-bottom:8px;">
          <input id="encourageInput" type="text" placeholder="Gá»­i lá»i Ä‘á»™ng viÃªn..." style="width:65%; padding:6px; margin-right:8px;">
          <button id="dropLoveBtn" class="btn pink" style="vertical-align:middle">ğŸ’– Tháº£ yÃªu thÆ°Æ¡ng</button>
        </div>

        <div id="ownerRecoverSection" style="display:none; margin-bottom:8px;">
          <button id="ownerRecoverBtn" class="btn" style="background:#9AE6B4;">âœ… TÃ´i á»•n rá»“i</button>
        </div>

        <button id="editLeaf" class="btn green">âœï¸ Sá»­a</button>
        <button id="deleteLeaf" class="btn red" style="display: none;">ğŸ—‘ï¸ XÃ³a</button>
      </div>
    </div>
  </div>

  <script src="src/firebase-init.js"></script>
  <script src="src/auth.js"></script>
  <script src="src/auth-guard.js"></script>
  <script src="src/script.js" defer></script>
  <script>
    // EARLY AUTH CHECK - Cháº¡y NGAY Ä‘á»ƒ giáº£m FOUC
    (function() {
      // Inline check Ä‘á»ƒ cháº¡y nhanh nháº¥t cÃ³ thá»ƒ
      const cachedAuthKey = Object.keys(localStorage).find(key => 
        key.startsWith('firebase:authUser:')
      );
      
      if (cachedAuthKey) {
        try {
          const cachedUser = JSON.parse(localStorage.getItem(cachedAuthKey));
          if (cachedUser && cachedUser.email) {
            // Update UI ngay láº­p tá»©c
            const authLoading = document.getElementById('authLoading');
            const userSection = document.getElementById('userSection');
            const userDisplayName = document.getElementById('userDisplayName');
            
            if (authLoading) authLoading.style.display = 'none';
            if (userSection) userSection.style.display = 'block';
            if (userDisplayName) {
              userDisplayName.textContent = cachedUser.displayName || cachedUser.email.split('@')[0];
            }
          }
        } catch (e) {
          // Ignore errors
        }
      }
    })();
    
    // Setup logout button, settings button and auth state management
    document.addEventListener('DOMContentLoaded', () => {
      const logoutBtn = document.getElementById('logoutBtn');
      const settingsBtn = document.getElementById('settingsBtn');
      
      if (logoutBtn) {
        logoutBtn.addEventListener('click', (e) => {
          e.preventDefault();
          const logoutModal = document.getElementById('logoutModal');
          if (logoutModal) {
            logoutModal.style.display = 'grid';
            logoutModal.classList.add('show');
            document.body.style.overflow = 'hidden';
          }
        });

        // Modal handlers
        const confirmLogout = document.getElementById('confirmLogout');
        const cancelLogout = document.getElementById('cancelLogout');
        const closeLogoutModal = document.getElementById('closeLogoutModal');
        const logoutModal = document.getElementById('logoutModal');

        const doSignOut = async () => {
          try {
            if (window.AuthHelpers) await window.AuthHelpers.signOut();
          } catch (err) {
            console.warn('Sign out failed:', err);
          } finally {
            // Always reload to reset UI
            window.location.reload();
          }
        };

        if (confirmLogout) confirmLogout.addEventListener('click', doSignOut);
        const closeLogout = () => { if (logoutModal) { logoutModal.classList.remove('show'); setTimeout(()=> logoutModal.style.display='none', 220); document.body.style.overflow='auto'; } };
        if (cancelLogout) cancelLogout.addEventListener('click', closeLogout);
        if (closeLogoutModal) closeLogoutModal.addEventListener('click', closeLogout);
        if (logoutModal) logoutModal.addEventListener('click', (ev)=> { if (ev.target === logoutModal) closeLogout(); });
      }
      
      // Settings button - Chuyá»ƒn Ä‘áº¿n trang profile
      if (settingsBtn) {
        settingsBtn.addEventListener('click', () => {
          navigateToPage('profile.html');
        });
      }
    });
  </script>
  <script>
    // Page transition function
    function navigateToPage(url) {
      document.body.classList.add('page-fade-out');
      setTimeout(() => {
        window.location.href = url;
      }, 250);
    }

    // Single DOMContentLoaded handler
    document.addEventListener('DOMContentLoaded', () => {
      
      // Add page transition on load
      const mainContent = document.getElementById('main-content');
      if (mainContent) {
        mainContent.classList.add('page-transition');
      }
      
      const dropdownMenu = document.getElementById('dropdownMenu');
      
      // Set up dropdown first so elements are accessible
      dropdownMenu.style.display = 'block';
      dropdownMenu.style.visibility = 'hidden';
      
      const themeToggle = document.getElementById('themeToggle');
      const helpModalBtn = document.getElementById('helpModalBtn');
      const termsModalBtn = document.getElementById('termsModalBtn');
      
      // Toggle dropdown menu - hamburger button
      const hamburger = document.getElementById('hamburger');
      if (hamburger) {
        hamburger.addEventListener('click', (e) => {
          e.stopPropagation();
          if (dropdownMenu.classList.contains('show')) {
            dropdownMenu.classList.remove('show');
          } else {
            dropdownMenu.style.visibility = 'visible';
            dropdownMenu.classList.add('show');
          }
        });
      }
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!dropdownMenu.contains(e.target) && 
            !e.target.closest('.hamburger')) {
          dropdownMenu.classList.remove('show');
        }
      });
      
      // Theme toggle functionality
      if (themeToggle) {
        const themeIcon = themeToggle.querySelector('.dropdown-icon');
        const themeText = themeToggle.querySelector('.dropdown-text');

        const updateThemeUI = () => {
          const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
          if (isDark) {
            if (themeIcon) themeIcon.textContent = 'â˜€ï¸';
            if (themeText) themeText.textContent = 'Cháº¿ Ä‘á»™ sÃ¡ng';
          } else {
            if (themeIcon) themeIcon.textContent = 'ğŸŒ™';
            if (themeText) themeText.textContent = 'Cháº¿ Ä‘á»™ tá»‘i';
          }
        };

        // Set initial theme on page load
        const currentTheme = localStorage.getItem('theme');
        if (currentTheme === 'dark') {
          document.documentElement.setAttribute('data-theme', 'dark');
          document.documentElement.classList.add('theme-night');
          document.documentElement.classList.remove('theme-day');
        } else {
          document.documentElement.removeAttribute('data-theme');
          document.documentElement.classList.add('theme-day');
          document.documentElement.classList.remove('theme-night');
        }
        updateThemeUI();

        themeToggle.addEventListener('click', () => {
          const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
          if (isDark) {
            document.documentElement.removeAttribute('data-theme');
            document.documentElement.classList.remove('theme-night');
            document.documentElement.classList.add('theme-day');
            localStorage.setItem('theme', 'light');
          } else {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.documentElement.classList.remove('theme-day');
            document.documentElement.classList.add('theme-night');
            localStorage.setItem('theme', 'dark');
          }
          
          window.dispatchEvent(new CustomEvent('theme-change', { 
            detail: { theme: isDark ? 'light' : 'dark' } 
          }));
          
          updateThemeUI();
          dropdownMenu.classList.remove('show');
        });
      }
      
      // Help modal
      if (helpModalBtn) {
        helpModalBtn.addEventListener('click', () => {
          dropdownMenu.classList.remove('show');
          const helpModal = document.getElementById('helpModal');
          if (helpModal) {
            helpModal.style.display = 'flex';
            helpModal.classList.add('show');
            document.body.style.overflow = 'hidden';
          }
        });
      }
      
      // Terms modal  
      if (termsModalBtn) {
        termsModalBtn.addEventListener('click', () => {
          dropdownMenu.classList.remove('show');
          const termsModal = document.getElementById('termsModal');
          if (termsModal) {
            termsModal.style.display = 'flex';
            termsModal.classList.add('show');
            document.body.style.overflow = 'hidden';
          }
        });
      }

      // Modal close handlers
      const closeHelp = document.getElementById('closeHelpModal');
      const closeTerms = document.getElementById('closeTermsModal');
      const closeProject = document.getElementById('closeProjectInfoModal');
      const helpModal = document.getElementById('helpModal');
      const termsModal = document.getElementById('termsModal');
      const projectModal = document.getElementById('projectInfoModal');

      if (closeHelp && helpModal) {
        closeHelp.addEventListener('click', () => {
          helpModal.style.display = 'none';
          helpModal.classList.remove('show');
          document.body.style.overflow = 'auto';
        });
      }

      if (closeTerms && termsModal) {
        closeTerms.addEventListener('click', () => {
          termsModal.style.display = 'none';
          termsModal.classList.remove('show');
          document.body.style.overflow = 'auto';
        });
      }

      if (closeProject && projectModal) {
        closeProject.addEventListener('click', () => {
          projectModal.style.display = 'none';
          projectModal.classList.remove('show');
          document.body.style.overflow = 'auto';
        });
      }

      // Close modals when clicking outside
      [helpModal, termsModal, projectModal].forEach(modal => {
        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.style.display = 'none';
              modal.classList.remove('show');
              document.body.style.overflow = 'auto';
            }
          });
        }
      });
    });
  </script>
  
</body>
</html>