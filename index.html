<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cây Thông Điệp</title>
  <link rel="preload" as="image" href="tree.jpg">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="layout">
    <!-- Panel trái -->
    <section class="panel left-panel">
      <div class="panel-header">
        <h1>🌱 Cây Thông Điệp</h1>
        <div class="header-buttons">
          <button class="theme-toggle" id="themeToggle" title="Chuyển đổi chế độ sáng/tối">
            <span class="theme-icon">🌙</span>
          </button>
        </div>
      </div>
      
      <p class="panel-description">Click vào cây để đặt lá tại vị trí bất kỳ, hoặc tự động thêm lá ngẫu nhiên!</p>
      
      <div class="stats-section">
        <div class="stat-card">
          <div class="stat-icon">🌿</div>
          <div class="stat-content">
            <div class="stat-number" id="counter">0</div>
            <div class="stat-label">Số lá trên cây</div>
          </div>
        </div>
      </div>
      
      <div class="controls">
        <div class="view-mode-section">
          <label class="switch-container">
            <input type="checkbox" id="viewOnlyMode">
            <span class="switch-slider"></span>
            <span class="switch-label">Chế độ chỉ xem</span>
          </label>
        </div>
        
        <div class="action-buttons" id="actionButtons">
          <button class="btn primary" id="add">
            <span class="btn-icon">🎲</span>
            <span class="btn-text">Tự động thêm</span>
          </button>
          <button class="btn secondary" id="toggleMode">
            <span class="btn-icon">🖱️</span>
            <span class="btn-text">Click để đặt</span>
          </button>
          <button class="btn tertiary" id="dragMode">
            <span class="btn-icon">✋</span>
            <span class="btn-text">Kéo thả</span>
          </button>
        </div>
      </div>
      
      <div class="additional-info">
        <div class="info-card">
          <div class="info-icon">💌</div>
          <div class="info-content">
            <h3>Gửi thông điệp yêu thương</h3>
            <p>Trước khi viết lên cây tinh thần, chúng mình mong bạn luôn nhớ rằng: đây là cây của những lời động viên, yêu thương và niềm tin. Mỗi lời bạn để lại sẽ trở thành ánh sáng nhỏ sưởi ấm trái tim một ai đó. Hãy chọn màu sắc riêng cho chiếc lá ứng với vấn đề bạn muốn gửi lời động viên nhé:</p>
            <div style="margin-top: 12px; font-size: 0.9rem; line-height: 1.4;">
              💸 Tài chính → Xanh lá<br>
              💕 Tình yêu → Hồng<br>
              📚 Học tập → Vàng<br>
              💼 Công việc → Xanh dương<br>
              🤝 Mối quan hệ → Tím<br>
              🌈 Khác → Xanh pastel
            </div>
          </div>
        </div>
        
        <button class="btn secondary" id="helpBtn" style="width: 100%; margin-top: 16px;">
          <span class="btn-icon">📖</span>
          <span class="btn-text">Hướng dẫn sử dụng</span>
        </button>
        
        <button class="btn info" id="projectInfoBtn" style="width: 100%; margin-top: 12px;">
          <span class="btn-icon">🌿</span>
          <span class="btn-text">Thông tin dự án</span>
        </button>
      </div>
    </section>

    <!-- Sân khấu phải -->
    <section class="stage panel" id="stage">
      <svg id="treeSvg" viewBox="0 0 553 666" preserveAspectRatio="xMidYMid meet" aria-label="Cây thông điệp">
        <image href="tree.jpg" x="0" y="0" width="553" height="666" alt="Cây thông" />
        
        <!-- Nhánh vô hình để bám lá -->
        <g id="branches" stroke="#0f172a" stroke-width="3" fill="none" opacity="0">
          <path d="M278 420 C240 402 200 377 168 358 140 342 118 332 98 326" />
          <path d="M282 420 C320 398 356 376 392 358 424 342 450 328 468 320" />
          <path d="M282 362 C244 342 210 320 178 304" />
          <path d="M286 358 C324 340 358 324 392 308" />
          <path d="M286 308 C246 290 214 270 184 254" />
          <path d="M290 304 C328 288 360 272 394 256" />
          <path d="M292 260 C326 244 356 226 388 212" />
          <path d="M288 258 C252 240 220 226 190 212" />
          <path d="M294 212 C330 198 360 182 386 168" />
          <path d="M286 214 C254 200 224 186 198 174" />
          <path d="M294 172 C320 162 346 148 366 136" />
          <path d="M284 172 C256 162 230 150 208 140" />
        </g>
        
        <g id="leaves"></g>
      </svg>
      <div class="ground"></div>
      <div class="tooltip" id="tip"></div>
    </section>
  </div>

  <!-- Add/Edit Modal -->
  <div class="modal" id="addModal" role="dialog" aria-modal="true" aria-labelledby="addModalTitle">
    <div class="sheet">
      <button class="x" id="closeAddModal" aria-label="Đóng modal">✕</button>
      <h3 id="addModalTitle">🌿 Thêm lá mới</h3>
      <div style="margin:16px 0">
        <label style="display:block;margin-bottom:8px;font-weight:600">Thông điệp:</label>
        <textarea id="addMessage" placeholder="Nhập thông điệp..." style="width:100%;min-height:80px;resize:vertical;padding:12px;border-radius:8px;border:1px solid #e2e8f0"></textarea>
      </div>
      <div style="margin:16px 0">
        <label style="display:block;margin-bottom:8px;font-weight:600">Tên của bạn:</label>
        <input type="text" id="addAuthor" placeholder="Nhập tên hoặc để trống (ẩn danh)" style="width:100%;padding:12px;border-radius:8px;border:1px solid #e2e8f0">
      </div>
      <div style="margin:16px 0">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input type="checkbox" id="isAnonymous" style="transform:scale(1.2)">
          <span>Gửi ẩn danh</span>
        </label>
      </div>
      
      <div class="picker" id="leafPicker" style="margin:16px 0">
        <div class="picker-row">
          <label style="font-weight:600">Hình dáng lá</label>
          <select id="leafShape">
            <option value="oval">🍃 Oval</option>
            <option value="round">⭕ Tròn</option>
            <option value="oak">🌳 Sồi</option>
            <option value="maple">🍁 Phong</option>
            <option value="heart">💚 Trái tim</option>
            <option value="willow">🌿 Liễu</option>
            <option value="birch">🌲 Bạch dương</option>
            <option value="ginkgo">🟡 Bạch quả</option>
            <option value="elm">🌱 Du</option>
            <option value="bamboo">🎋 Tre</option>
            <option value="fern">🌿 Dương xỉ</option>
            <option value="cherry">🌸 Anh đào</option>
          </select>
        </div>

        <div class="picker-row">
          <label style="font-weight:600">Chủ đề thông điệp</label>
          <select id="leafPalette">
            <option value="0">💰 Tiền bạc → Xanh pastel</option>
            <option value="1">💕 Tình yêu → Hồng pastel</option>
            <option value="2">📚 Học tập → Vàng pastel</option>
            <option value="3">💼 Công việc → Xanh dương pastel</option>
            <option value="4">👥 Mối quan hệ → Tím pastel</option>
            <option value="5">🌟 Khác → Xanh lá pastel nhạt</option>
          </select>
        </div>

        <div class="picker-row">
          <label style="font-weight:600">Kích cỡ</label>
          <input type="range" id="leafScale" min="0.8" max="1.4" step="0.05" value="1">
        </div>

        <div class="picker-row">
          <label style="font-weight:600">Góc xoay</label>
          <input type="range" id="leafRotation" min="-25" max="25" step="1" value="0">
        </div>

        <div class="preview" id="leafPreview"></div>
      </div>
      
      <div style="display:flex;gap:12px;margin-top:20px">
        <button class="btn primary" id="saveLeaf" style="flex:1">💾 Lưu</button>
        <button class="btn secondary" id="cancelAdd" style="flex:1">❌ Hủy</button>
      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div class="modal" id="helpModal" role="dialog" aria-modal="true">
    <div class="sheet">
      <button class="x" id="closeHelpModal" aria-label="Đóng hướng dẫn">✕</button>
      <h3>❓ Hướng dẫn sử dụng</h3>
      <div class="help-content">
        <div class="help-section">
          <h4>🌿 Cách thêm lá:</h4>
          <ul>
            <li><strong>Tự động thêm:</strong> Nhấn nút "🎲 Tự động thêm" để thêm lá ở vị trí ngẫu nhiên</li>
            <li><strong>Click để đặt:</strong> Bật chế độ này và click vào cây để đặt lá chính xác</li>
          </ul>
        </div>
        <div class="help-section">
          <h4>✏️ Tương tác với lá:</h4>
          <ul>
            <li><strong>Xem thông điệp:</strong> Click vào bất kỳ chiếc lá nào để đọc nội dung</li>
            <li><strong>Kéo thả:</strong> Bật chế độ kéo thả và giữ lá để di chuyển vị trí</li>
            <li><strong>Sửa nội dung:</strong> Trong popup xem lá, bạn có thể chỉnh sửa thông điệp</li>
          </ul>
        </div>
        <div class="help-section">
          <h4>👁️ Chế độ chỉ xem:</h4>
          <p>Bật để khóa tất cả chức năng chỉnh sửa, chỉ cho phép xem thông điệp.</p>
        </div>
        <div class="help-section">
          <h4>🎨 Tùy chỉnh lá:</h4>
          <p>Khi thêm lá mới, bạn có thể chọn hình dáng, màu sắc, kích thước và góc xoay.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Project Info Modal -->
  <div class="modal" id="projectInfoModal" role="dialog" aria-modal="true">
    <div class="sheet">
      <button class="x" id="closeProjectInfoModal" aria-label="Đóng thông tin dự án">✕</button>
      <h3>🌿 Cây tinh thần</h3>
      <div class="help-content">
        <p style="line-height: 1.6; margin-bottom: 16px;">
          Trong guồng quay tất bật của cuộc sống, đôi khi chúng ta quên rằng hạnh phúc có thể đến từ những điều giản dị nhất. Dự án Peace by Piece ra đời để gửi gắm những lời yêu thương, động viên và hy vọng – như từng chiếc lá nhỏ mang trong mình thông điệp bình yên.
        </p>
        <p style="line-height: 1.6;">
          Hãy để mỗi nụ cười, mỗi lời chia sẻ trở thành một mảnh ghép góp phần tạo nên bức tranh hạnh phúc trọn vẹn. 💌
        </p>
      </div>
    </div>
  </div>

  <!-- View Modal -->
  <div class="modal" id="modal" role="dialog" aria-modal="true">
    <div class="sheet">
      <button class="x" id="closeModal" aria-label="Đóng modal">✕</button>
      <h3>💌 Thông điệp</h3>
      <div class="leaf-card">
        <div class="leaf-text">
          <p id="modalText"></p>
          <p id="modalAuthor"></p>
        </div>
      </div>
      <div class="leaf-actions">
        <button id="editLeaf" class="btn green">✏️ Sửa</button>
        <button id="deleteLeaf" class="btn red" style="display: none;">🗑️ Xóa</button>
      </div>
    </div>
  </div>

  <script type="module" src="./firebase-init.mjs"></script>
  <script src="script.js" defer></script>
</body>
</html>