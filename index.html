<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://firebase.googleapis.com https://www.google.com https://www.recaptcha.net https://apis.google.com https://apis.google.com/js/ https://*.firebasedatabase.app; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://*.firebaseio.com https://firebase.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://firebaseinstallations.googleapis.com https://www.googleapis.com https://content-firebaseappcheck.googleapis.com https://www.google.com https://www.recaptcha.net https://www.gstatic.com https://accounts.google.com wss://*.firebaseio.com wss://*.firebasedatabase.app https://*.firebasedatabase.app; frame-src https://www.google.com https://www.recaptcha.net https://accounts.google.com https://*.firebasedatabase.app;" />
    <title>Trang chá»§ | CÃ¢y Tinh Tháº§n - Chia sáº» cáº£m xÃºc</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <!-- CSS Files -->
    <link rel="stylesheet" href="assets/styles.css" />
    <link rel="stylesheet" href="assets/main.css" />
    <link rel="stylesheet" href="assets/header.css" />
    <link rel="stylesheet" href="assets/tree.css" />
    <link rel="stylesheet" href="assets/chat.css" />
    <link rel="stylesheet" href="assets/modals.css" />
    <link rel="stylesheet" href="assets/leaves.css" />
  </head>
  <body>
    <!-- Header Navigation -->
    <div class="app-header">
      <div class="header-content">
        <div class="header-left">
          <a href="index.html" class="logo">
            <span class="logo-icon">ğŸŒ±</span>
            <span class="logo-text">CÃ¢y Tinh Tháº§n</span>
          </a>
        </div>

        <div class="header-right" id="headerRight">
          <!-- Auth Container - Centralized auth state management -->
          <div class="auth-container" id="authContainer">
            <!-- When logged out -->
            <div class="auth-section" id="authSection" style="display: none">
              <button
                class="header-btn login-btn"
                onclick="window.location.href='login.html'"
              >
                ÄÄƒng nháº­p
              </button>
              <button
                class="header-btn register-btn"
                onclick="window.location.href='register.html'"
              >
                ÄÄƒng kÃ½
              </button>
            </div>

            <!-- Loading state - Hiá»‡n khi Ä‘ang check auth -->
            <div class="auth-loading" id="authLoading" style="display: flex">
              <span style="color: #64748b; font-size: 14px">Äang táº£i...</span>
            </div>

            <!-- When logged in -->
            <div class="user-section" id="userSection" style="display: none">
              <div class="user-info">
                <div class="user-greeting">
                  <span>Xin chÃ o, </span>
                  <strong id="userDisplayName"></strong>
                </div>
                <div class="user-actions">
                  <button
                    class="header-btn settings-btn"
                    id="settingsBtn"
                    title="Trang cÃ¡ nhÃ¢n"
                  >
                    <span>âš™ï¸</span>
                    <span>CÃ¡ nhÃ¢n</span>
                  </button>
                  <button class="header-btn logout-btn" id="logoutBtn">
                    <span>ğŸšª</span>
                    <span>ÄÄƒng xuáº¥t</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <button class="hamburger" id="hamburger">
            <span></span>
            <span></span>
            <span></span>
          </button>

          <!-- Dropdown Menu -->
          <div class="dropdown-menu" id="dropdownMenu">
            <div class="dropdown-item" id="themeToggle">
              <span class="dropdown-icon">ğŸŒ™</span>
              <span class="dropdown-text">Cháº¿ Ä‘á»™ tá»‘i</span>
            </div>
            <div
              class="dropdown-item admin-only"
              onclick="navigateToPage('admin.html')"
              style="display: none"
            >
              <span class="dropdown-icon">ğŸ›¡ï¸</span>
              <span class="dropdown-text">Quáº£n trá»‹ viÃªn</span>
            </div>
            <div class="dropdown-item" id="helpModalBtn">
              <span class="dropdown-icon">ğŸ“–</span>
              <span class="dropdown-text">HÆ°á»›ng dáº«n sá»­ dá»¥ng</span>
            </div>
            <div class="dropdown-item" id="termsModalBtn">
              <span class="dropdown-icon">ğŸ“œ</span>
              <span class="dropdown-text">Äiá»u khoáº£n</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <main class="layout page-transition" id="main-content">
      <!-- Panel trÃ¡i -->
      <section class="panel left-panel">
        <div class="panel-header">
          <h1>ğŸŒ± CÃ¢y Tinh Tháº§n</h1>
        </div>

        <div class="stats-section">
          <div class="stat-card">
            <div class="stat-icon">ğŸŒ¿</div>
            <div class="stat-content">
              <div class="stat-number" id="counter">0</div>
              <div class="stat-label">Sá»‘ lÃ¡ trÃªn cÃ¢y</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ğŸ’š</div>
            <div class="stat-content">
              <div class="stat-number" id="healedCounter">0</div>
              <div class="stat-label">Sá»‘ lÃ¡ Ä‘Ã£ chá»¯a lÃ nh</div>
            </div>
          </div>
        </div>

        <div class="controls">
          <div class="view-mode-section">
            <label class="switch-container">
              <input type="checkbox" id="viewOnlyMode" />
              <span class="switch-slider"></span>
              <span class="switch-label">Cháº¿ Ä‘á»™ chá»‰ xem</span>
            </label>
          </div>

          <div class="action-buttons" id="actionButtons">
            <!-- Auto-add removed: manual placement only -->
            <button class="btn secondary" id="toggleMode">
              <span class="btn-icon">ğŸ–±ï¸</span>
              <span class="btn-text">Click Ä‘á»ƒ Ä‘áº·t</span>
            </button>
            <button class="btn tertiary" id="dragMode">
              <span class="btn-icon">âœ‹</span>
              <span class="btn-text">KÃ©o tháº£</span>
            </button>
          </div>
        </div>

        <div class="additional-info">
          <div class="info-card">
            <div class="info-icon">ğŸ’Œ</div>
            <div class="info-content">
              <h3>Gá»­i thÃ´ng Ä‘iá»‡p yÃªu thÆ°Æ¡ng</h3>
              <p>
                TrÆ°á»›c khi viáº¿t lÃªn cÃ¢y tinh tháº§n, chÃºng mÃ¬nh mong báº¡n luÃ´n nhá»›
                ráº±ng: Ä‘Ã¢y lÃ  cÃ¢y cá»§a nhá»¯ng lá»i Ä‘á»™ng viÃªn, yÃªu thÆ°Æ¡ng vÃ  niá»m
                tin. Má»—i lá»i báº¡n Ä‘á»ƒ láº¡i sáº½ trá»Ÿ thÃ nh Ã¡nh sÃ¡ng nhá» sÆ°á»Ÿi áº¥m trÃ¡i
                tim má»™t ai Ä‘Ã³. HÃ£y chá»n mÃ u sáº¯c riÃªng cho chiáº¿c lÃ¡ á»©ng vá»›i váº¥n
                Ä‘á» báº¡n muá»‘n gá»­i lá»i Ä‘á»™ng viÃªn nhÃ©:
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- SÃ¢n kháº¥u pháº£i -->
      <section class="stage panel" id="stage">
        <!-- Day/Night Scene -->
        <div id="scene">
          <div class="sky"></div>
          <div class="sun"></div>
          <div class="moon"></div>
          <div class="clouds"></div>
          <canvas id="stars"></canvas>
          <div class="grass"></div>
        </div>

        <div id="app">
          <img
            id="tree"
            src="assets/tree/tree_transparent.png"
            alt="CÃ¢y Tinh Tháº§n"
          />
          <canvas id="leafCanvas"></canvas>
          <svg
            id="leafSvg"
            style="
              position: absolute;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              pointer-events: auto;
            "
          >
            <g id="leaves"></g>
          </svg>
        </div>
        <div class="ground"></div>
        <div class="tooltip" id="tip"></div>
      </section>
    </main>

    <!-- Logout Confirmation Modal -->
    <div
      class="modal"
      id="logoutModal"
      role="dialog"
      aria-modal="true"
      style="display: none"
    >
      <div class="sheet">
        <button class="x" id="closeLogoutModal" aria-label="ÄÃ³ng modal">
          âœ•
        </button>
        <h3>ğŸ”’ XÃ¡c nháº­n Ä‘Äƒng xuáº¥t</h3>
        <p style="color: var(--text-secondary)">
          Báº¡n cÃ³ cháº¯c muá»‘n Ä‘Äƒng xuáº¥t khá»i tÃ i khoáº£n cá»§a mÃ¬nh? Báº¡n sáº½ cáº§n Ä‘Äƒng
          nháº­p láº¡i Ä‘á»ƒ tiáº¿p tá»¥c Ä‘Äƒng lÃ¡.
        </p>
        <div style="display: flex; gap: 12px; margin-top: 18px">
          <button class="btn red" id="confirmLogout" style="flex: 1">
            ÄÄƒng xuáº¥t
          </button>
          <button class="btn secondary" id="cancelLogout" style="flex: 1">
            Há»§y
          </button>
        </div>
      </div>
    </div>

    <!-- Login Prompt Modal (friendly) -->
    <div class="modal" id="loginPromptModal" role="dialog" aria-modal="true" style="display:none">
      <div class="sheet" style="max-width:420px;">
        <button class="x" aria-label="ÄÃ³ng modal">âœ•</button>
        <h3>ğŸ” Báº¡n cáº§n Ä‘Äƒng nháº­p</h3>
        <p style="color:var(--text-secondary)">Äá»ƒ thÃªm hoáº·c chá»‰nh sá»­a lÃ¡ trÃªn cÃ¢y, báº¡n cáº§n Ä‘Äƒng nháº­p. Báº¡n cÃ³ thá»ƒ Ä‘Äƒng nháº­p báº±ng tÃ i khoáº£n hiá»‡n cÃ³ hoáº·c tiáº¿p tá»¥c xem dÆ°á»›i dáº¡ng khÃ¡ch.</p>
        <div style="display:flex;gap:12px;margin-top:18px;">
          <button class="btn primary login-now" style="flex:1">ÄÄƒng nháº­p</button>
          <button class="btn secondary login-cancel" style="flex:1">Tiáº¿p tá»¥c xem</button>
        </div>
      </div>
    </div>

    <!-- Add/Edit Modal -->
    <div
      class="modal"
      id="addModal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="addModalTitle"
    >
      <div class="sheet">
        <button class="x" id="closeAddModal" aria-label="ÄÃ³ng modal">âœ•</button>
        <h3 id="addModalTitle">ğŸŒ¿ ThÃªm lÃ¡ má»›i</h3>
        <div class="form-section">
          <label>ThÃ´ng Ä‘iá»‡p:</label>
          <textarea id="addMessage" placeholder="Nháº­p thÃ´ng Ä‘iá»‡p..."></textarea>
        </div>
        <div class="form-section">
          <label>TÃªn cá»§a báº¡n:</label>
          <input
            type="text"
            id="addAuthor"
            placeholder="Nháº­p tÃªn hoáº·c Ä‘á»ƒ trá»‘ng (áº©n danh)"
          />
        </div>
        <div class="form-section">
          <label class="checkbox-label">
            <input type="checkbox" id="isAnonymous" />
            <span>Gá»­i áº©n danh</span>
          </label>
        </div>        

        <div class="picker picker-section" id="leafPicker">
          <div class="picker-row">
            <label>HÃ¬nh dÃ¡ng lÃ¡</label>
            <select id="leafShape">
              <option value="normal">LÃ¡ bÃ¬nh thÆ°á»ng</option>
              <option value="withered">LÃ¡ hÃ©o Ãºa</option>
            </select>
          </div>

          <div class="picker-row">
            <label>Äá»™ xoay</label>
            <div style="display: flex; align-items: center; gap: 8px">
              <input
                type="range"
                id="leafRotation"
                min="0"
                max="360"
                step="5"
                value="0"
                style="flex: 1"
              />
              <span
                id="rotationValue"
                style="
                  min-width: 35px;
                  font-size: 12px;
                  color: var(--text-secondary);
                "
                >0Â°</span
              >
            </div>
          </div>

          <div class="preview" id="leafPreview">
            <div class="preview-label">Xem trÆ°á»›c:</div>
            <div
              class="preview-leaf"
              style="
                display: flex;
                justify-content: center;
                align-items: center;
                height: 120px;
                padding: 0;
              "
            >
              <!-- Wrap the image so rotation/scale only affects the image itself -->
              <div class="preview-image-wrap" style="position:relative;">
                <img
                  id="previewLeafImage"
                  class="preview-image fill-frame modal-leaf-image"
                  src="assets/leaves/leaf_normal.png"
                  alt="Preview"
                  width="140"
                  height="140"
                />
              </div>
            </div>
          </div>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 20px">
          <button class="btn primary" id="saveLeaf" style="flex: 1">
            ğŸ’¾ LÆ°u
          </button>
          <button class="btn secondary" id="cancelAdd" style="flex: 1">
            âŒ Há»§y
          </button>
        </div>
      </div>
    </div>

    <!-- Help Modal -->
    <div class="modal" id="helpModal" role="dialog" aria-modal="true">
      <div class="sheet">
        <button class="x" id="closeHelpModal" aria-label="ÄÃ³ng hÆ°á»›ng dáº«n">
          âœ•
        </button>
        <h3>â“ HÆ°á»›ng dáº«n sá»­ dá»¥ng</h3>
        <div class="help-content">
          <div class="help-section">
            <h4>ğŸŒ¿ CÃ¡ch thÃªm lÃ¡:</h4>
            <ul>
              <li>
                <strong>Click Ä‘á»ƒ Ä‘áº·t:</strong> Báº­t cháº¿ Ä‘á»™ nÃ y vÃ  click vÃ o cÃ¢y
                Ä‘á»ƒ Ä‘áº·t lÃ¡ cÃ¢y
              </li>
            </ul>
          </div>
          <div class="help-section">
            <h4>âœï¸ TÆ°Æ¡ng tÃ¡c vá»›i lÃ¡:</h4>
            <ul>
              <li>
                <strong>Xem thÃ´ng Ä‘iá»‡p:</strong> Click vÃ o báº¥t ká»³ chiáº¿c lÃ¡ nÃ o
                Ä‘á»ƒ Ä‘á»c ná»™i dung
              </li>
              <li>
                <strong>KÃ©o tháº£:</strong> Báº­t cháº¿ Ä‘á»™ kÃ©o tháº£ vÃ  giá»¯ lÃ¡ Ä‘á»ƒ di
                chuyá»ƒn vá»‹ trÃ­
              </li>
              <li>
                <strong>Sá»­a ná»™i dung:</strong> Trong popup xem lÃ¡, báº¡n cÃ³ thá»ƒ
                chá»‰nh sá»­a thÃ´ng Ä‘iá»‡p
              </li>
            </ul>
          </div>
          <div class="help-section">
            <h4>ğŸ‘ï¸ Cháº¿ Ä‘á»™ chá»‰ xem:</h4>
            <p>
              Báº­t Ä‘á»ƒ khÃ³a táº¥t cáº£ chá»©c nÄƒng chá»‰nh sá»­a, chá»‰ cho phÃ©p xem thÃ´ng
              Ä‘iá»‡p.
            </p>
          </div>
          <div class="help-section">
            <h4>ğŸ¨ TÃ¹y chá»‰nh lÃ¡:</h4>
            <p>
              Khi thÃªm lÃ¡ má»›i, báº¡n cÃ³ thá»ƒ chá»n loáº¡i lÃ¡ vÃ  gÃ³c xoay.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Terms Modal-->
    <div class="modal" id="termsModal" role="dialog" aria-modal="true" aria-labelledby="termsModalHeading">
      <div class="sheet" style="max-width:820px; width:96%; max-height:84vh; overflow:auto; padding:18px; box-sizing:border-box;">
        <button class="x" id="closeTermsModal" aria-label="ÄÃ³ng Ä‘iá»u khoáº£n">âœ•</button>
        <h3 id="termsModalHeading">ğŸ“œ Äiá»u Khoáº£n Sá»­ Dá»¥ng â€” CÃ¢y Tinh Tháº§n</h3>
        <div class="help-content" style="line-height:1.55; color:var(--ink);">
          <section style="margin-top:8px;">
            <h4>Lá»i Má»Ÿ Äáº§u</h4>
            <p>ChÃ o má»«ng báº¡n Ä‘áº¿n vá»›i trang web <strong>CÃ¢y Tinh Tháº§n</strong> â€“ má»™t khÃ´ng gian sá»‘ cá»§a dá»± Ã¡n cá»™ng Ä‘á»“ng <em>Peace by Piece</em>. Sá»© má»‡nh cá»§a chÃºng tÃ´i lÃ  táº¡o ra má»™t nÆ¡i an toÃ n Ä‘á»ƒ má»i ngÆ°á»i cÃ³ thá»ƒ gá»­i gáº¯m vÃ  Ä‘Ã³n nháº­n nhá»¯ng lá»i Ä‘á»™ng viÃªn, sáº» chia tÃ­ch cá»±c.</p>
            <p>Viá»‡c báº¡n gá»­i thÃ´ng Ä‘iá»‡p hoáº·c sá»­ dá»¥ng trang web nÃ y Ä‘á»“ng nghÄ©a vá»›i viá»‡c báº¡n Ä‘Ã£ Ä‘á»c, hiá»ƒu vÃ  Ä‘á»“ng Ã½ tuÃ¢n thá»§ nhá»¯ng quy Ä‘á»‹nh nÃ y.</p>
          </section>

          <section style="margin-top:12px;">
            <h4>Äiá»u 1 â€” Chuáº©n Má»±c Cá»™ng Äá»“ng - HÃ£y CÃ¹ng Nhau "LÃ m Xanh" CÃ¢y</h4>
            <p>Má»—i thÃ´ng Ä‘iá»‡p báº¡n gá»­i Ä‘i lÃ  má»™t chiáº¿c lÃ¡, gÃ³p pháº§n táº¡o nÃªn tÃ¡n cÃ¢y tinh tháº§n. Äá»ƒ tÃ¡n cÃ¢y nÃ y luÃ´n xanh tÆ°Æ¡i vÃ  lÃ  nÆ¡i trÃº áº©n an toÃ n cho tÃ¢m há»“n, chÃºng tÃ´i mong báº¡n:</p>
            <ul>
              <li><strong>Gieo Háº¡t TÃ­ch Cá»±c:</strong> HÃ£y chia sáº» nhá»¯ng lá»i Ä‘á»™ng viÃªn, nhá»¯ng cÃ¢u chuyá»‡n tÃ­ch cá»±c, hoáº·c nhá»¯ng lá»i chÃºc thiá»‡n chÃ­ vÃ  cÃ³ tÃ­nh xÃ¢y dá»±ng.</li>
              <li><strong>TÃ´n Trá»ng Sá»± KhÃ¡c Biá»‡t:</strong> Má»—i ngÆ°á»i cÃ³ má»™t cÃ¢u chuyá»‡n riÃªng. HÃ£y Ä‘á»‘i xá»­ vá»›i má»i thÃ´ng Ä‘iá»‡p báº±ng sá»± tÃ´n trá»ng, khÃ´ng phÃ¡n xÃ©t.</li>
              <li><strong>Báº£o Máº­t Tuyá»‡t Äá»‘i:</strong> NghiÃªm cáº¥m Ä‘Äƒng táº£i thÃ´ng tin cÃ¡ nhÃ¢n cá»§a báº£n thÃ¢n hoáº·c cá»§a báº¥t ká»³ ai khÃ¡c (tÃªn, sá»‘ Ä‘iá»‡n thoáº¡i, máº¡ng xÃ£ há»™i...).</li>
            </ul>
            <p><strong>Ná»™i dung bá»‹ cáº¥m</strong>: Tuyá»‡t Ä‘á»‘i khÃ´ng gá»­i cÃ¡c thÃ´ng Ä‘iá»‡p chá»©a:</p>
            <ul>
              <li>NgÃ´n tá»« gÃ¢y thÃ¹ ghÃ©t, táº¥n cÃ´ng, phÃ¢n biá»‡t Ä‘á»‘i xá»­.</li>
              <li>Ná»™i dung Ä‘e dá»a, báº¯t náº¡t, quáº¥y rá»‘i.</li>
              <li>Ná»™i dung cá»• suÃ½ hoáº·c hÆ°á»›ng dáº«n cÃ¡c hÃ nh vi tá»± háº¡i.</li>
              <li>ThÃ´ng tin sai lá»‡ch, lá»«a Ä‘áº£o, quáº£ng cÃ¡o, spam hoáº·c cÃ¡c ná»™i dung vi pháº¡m phÃ¡p luáº­t Viá»‡t Nam.</li>
            </ul>
          </section>

          <section style="margin-top:12px;">
            <h4>Äiá»u 2 â€” ChÃ­nh SÃ¡ch Quyá»n RiÃªng TÆ°</h4>
            <p><strong>Thu Tháº­p ThÃ´ng Tin:</strong> Khi báº¡n gá»­i má»™t thÃ´ng Ä‘iá»‡p lÃªn CÃ¢y Tinh Tháº§n, chÃºng tÃ´i chá»‰ thu tháº­p vÃ  hiá»ƒn thá»‹ cÃ´ng khai ná»™i dung cá»§a thÃ´ng Ä‘iá»‡p Ä‘Ã³. QuÃ¡ trÃ¬nh nÃ y hoÃ n toÃ n áº©n danh. Trang web khÃ´ng chá»§ Ä‘á»™ng thu tháº­p vÃ  khÃ´ng lÆ°u trá»¯ báº¥t ká»³ thÃ´ng tin nháº­n dáº¡ng cÃ¡ nhÃ¢n nÃ o nhÆ° tÃªn, email, hay Ä‘á»‹a chá»‰ IP khi chÆ°a Ä‘Æ°á»£c sá»± cho phÃ©p cá»§a báº¡n.</p>
            <p><strong>Sá»­ Dá»¥ng ThÃ´ng Tin:</strong> Ná»™i dung thÃ´ng Ä‘iá»‡p cá»§a báº¡n Ä‘Æ°á»£c sá»­ dá»¥ng duy nháº¥t cho má»¥c Ä‘Ã­ch hiá»ƒn thá»‹ cÃ´ng khai trÃªn CÃ¢y Tinh Tháº§n Ä‘á»ƒ lan tá»a nÄƒng lÆ°á»£ng tÃ­ch cá»±c Ä‘áº¿n cá»™ng Ä‘á»“ng.</p>
          </section>

          <section style="margin-top:12px;">
            <h4>Äiá»u 3 â€” Äiá»u Khoáº£n PhÃ¡p LÃ½</h4>
            <p><strong>KHÃ”NG THAY THáº¾ Há»– TRá»¢ CHUYÃŠN NGHIá»†P:</strong> Quan trá»ng: CÃ¢y Tinh Tháº§n lÃ  má»™t nÆ¡i há»— trá»£ tinh tháº§n dá»±a trÃªn sá»± chia sáº» Ä‘á»“ng Ä‘áº³ng, <strong>KHÃ”NG PHáº¢I</strong> lÃ  dá»‹ch vá»¥ trá»‹ liá»‡u hay tÆ° váº¥n tÃ¢m lÃ½ chuyÃªn nghiá»‡p.</p>
            <p>Náº¿u báº¡n hoáº·c ai Ä‘Ã³ báº¡n biáº¿t Ä‘ang gáº·p khá»§ng hoáº£ng tinh tháº§n hoáº·c khá»§ng hoáº£ng an toÃ n, xin hÃ£y tÃ¬m Ä‘áº¿n sá»± giÃºp Ä‘á»¡ cá»§a cÃ¡c chuyÃªn gia hoáº·c liÃªn há»‡ cÃ¡c Ä‘Æ°á»ng dÃ¢y nÃ³ng uy tÃ­n ngay láº­p tá»©c.</p>
            <p><strong>Quyá»n cá»§a Dá»± Ãn:</strong> ChÃºng tÃ´i cÃ³ toÃ n quyá»n kiá»ƒm duyá»‡t vÃ  xÃ³a bá» báº¥t ká»³ thÃ´ng Ä‘iá»‡p nÃ o vi pháº¡m cÃ¡c chuáº©n má»±c cá»™ng Ä‘á»“ng mÃ  khÃ´ng cáº§n thÃ´ng bÃ¡o trÆ°á»›c.</p>
          </section>

          <section style="margin-top:12px;">
            <h4>Äiá»u 4 â€” LiÃªn Há»‡ vÃ  BÃ¡o CÃ¡o</h4>
            <p>Náº¿u báº¡n phÃ¡t hiá»‡n má»™t thÃ´ng Ä‘iá»‡p vi pháº¡m hoáº·c cÃ³ báº¥t ká»³ tháº¯c máº¯c nÃ o, vui lÃ²ng liÃªn há»‡ vá»›i chÃºng tÃ´i qua:</p>
            <p><strong>Email:</strong> <a href="mailto:hkdaty.kng@gmail.com">hkdaty.kng@gmail.com</a></p>
          </section>

          <section style="margin-top:14px;font-size:13px;color:var(--muted);">
            <p>Cáº£m Æ¡n báº¡n Ä‘Ã£ cÃ¹ng chÃºng tÃ´i vun Ä‘áº¯p nÃªn CÃ¢y Tinh Tháº§n nÃ y.</p>
            <p><em>PhiÃªn báº£n Ä‘iá»u khoáº£n: v1 â€¢ NgÃ y hiá»‡u lá»±c: 2025-10-25</em></p>
          </section>
        </div>
      </div>
    </div>

    <!-- Project Info Modal -->
    <div class="modal" id="projectInfoModal" role="dialog" aria-modal="true">
      <div class="sheet">
        <button
          class="x"
          id="closeProjectInfoModal"
          aria-label="ÄÃ³ng thÃ´ng tin dá»± Ã¡n"
        >
          âœ•
        </button>
        <h3>ğŸŒ¿ CÃ¢y tinh tháº§n</h3>
        <div class="help-content">
          <p style="line-height: 1.6; margin-bottom: 16px">
            Trong guá»“ng quay táº¥t báº­t cá»§a cuá»™c sá»‘ng, Ä‘Ã´i khi chÃºng ta quÃªn ráº±ng
            háº¡nh phÃºc cÃ³ thá»ƒ Ä‘áº¿n tá»« nhá»¯ng Ä‘iá»u giáº£n dá»‹ nháº¥t. Dá»± Ã¡n Peace by
            Piece ra Ä‘á»i Ä‘á»ƒ gá»­i gáº¯m nhá»¯ng lá»i yÃªu thÆ°Æ¡ng, Ä‘á»™ng viÃªn vÃ  hy vá»ng â€“
            nhÆ° tá»«ng chiáº¿c lÃ¡ nhá» mang trong mÃ¬nh thÃ´ng Ä‘iá»‡p bÃ¬nh yÃªn.
          </p>
          <p style="line-height: 1.6">
            HÃ£y Ä‘á»ƒ má»—i ná»¥ cÆ°á»i, má»—i lá»i chia sáº» trá»Ÿ thÃ nh má»™t máº£nh ghÃ©p gÃ³p pháº§n
            táº¡o nÃªn bá»©c tranh háº¡nh phÃºc trá»n váº¹n. ğŸ’Œ
          </p>
        </div>
      </div>
    </div>

    <!-- View Modal -->
    <div class="modal" id="modal" role="dialog" aria-modal="true">
      <div class="sheet">
        <button class="x" id="closeModal" aria-label="ÄÃ³ng modal">âœ•</button>
        <h3>ğŸ’Œ ThÃ´ng Ä‘iá»‡p</h3>
        <div class="leaf-card">
          <div class="leaf-preview">
            <img id="modalLeafImage" class="modal-leaf-image" src="" alt="Leaf preview" />
          </div>
          <div class="leaf-text">
            <p id="modalText"></p>
            <p id="modalAuthor"></p>
          </div>
        </div>
        <div class="leaf-actions">
          <div id="encourageSection" style="display: none; margin-bottom: 8px">
            <input
              id="encourageInput"
              type="text"
              placeholder="Gá»­i lá»i Ä‘á»™ng viÃªn..."
              style="width: 65%; padding: 6px; margin-right: 8px"
            />
            <button
              id="dropLoveBtn"
              class="btn pink"
              style="vertical-align: middle"
            >
              ğŸ’– Tháº£ yÃªu thÆ°Æ¡ng
            </button>
          </div>

          <!-- List of encouragers - only visible to leaf owner -->
          <div id="encouragersList" style="display: none; margin-bottom: 8px;">
            <h4 style="margin:0 0 8px 0; font-size:13px">Nhá»¯ng ngÆ°á»i Ä‘Ã£ an á»§i</h4>
            <div id="encouragersItems" style="display:flex;flex-direction:column;gap:6px;max-height:200px;overflow:auto;padding-right:6px"></div>
          </div>

          <div
            id="ownerRecoverSection"
            style="display: none; margin-bottom: 8px"
          >
            <button
              id="ownerRecoverBtn"
              class="btn"
              style="background: #9ae6b4"
            >
              âœ… TÃ´i á»•n rá»“i
            </button>
          </div>

          <button id="editLeaf" class="btn green">âœï¸ Sá»­a</button>
          <button id="deleteLeaf" class="btn red" style="display: none">
            ğŸ—‘ï¸ XÃ³a
          </button>
        </div>
      </div>
    </div>

    <!-- Support Floating Button & Modal (HáººM 202) -->
    <button id="supportFloatingBtn" aria-haspopup="dialog" aria-controls="supportModal" style="position:fixed;right:18px;bottom:20px;z-index:12000;background:#ffb703;color:#082032;border:none;padding:12px 14px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.18);font-weight:700;cursor:pointer;">Há»— trá»£</button>

    <div class="modal" id="supportModal" role="dialog" aria-modal="true" style="display:none">
      <div class="sheet" style="max-width:520px;">
        <button class="x" id="supportCloseBtn" aria-label="ÄÃ³ng modal">âœ•</button>
        <h3>ChÃ o báº¡n ğŸŒ¼</h3>
        <div id="supportContent" style="line-height:1.5;color:var(--text-secondary);">
          <p>
            Náº¿u báº¡n váº«n chÆ°a cáº£m tháº¥y á»•n, vÃ  cÃ³ nhiá»u Ä‘iá»u chÆ°a thá»ƒ nÃ³i ra â€” Ä‘á»«ng chá»‹u Ä‘á»±ng má»™t mÃ¬nh nhÃ©.. ChÃºng mÃ¬nh sáº½ giÃºp báº¡n káº¿t ná»‘i trá»±c tiáº¿p vá»›i <strong>HáººM 202 [ Bá»˜ PHáº¬N TÆ¯ Váº¤N TÃ‚M LÃ Táº I TRÆ¯á»œNG ÄH FPT TP.HCM]</strong>. ÄÃ¢y lÃ  nÆ¡i báº¡n cÃ³ thá»ƒ thoáº£i mÃ¡i chia sáº» cáº£m xÃºc cÃ¹ng cÃ¡n bá»™ tÃ¢m lÃ½ giÃ u kinh nghiá»‡m, luÃ´n sáºµn sÃ ng láº¯ng nghe vÃ  Ä‘á»“ng hÃ nh cÃ¹ng báº¡n.
            Äá»«ng ngáº§n ngáº¡i má»Ÿ lÃ²ng nhÃ© â€” nháº¥n vÃ o nÃºt bÃªn dÆ°á»›i Ä‘á»ƒ báº¯t Ä‘áº§u ğŸ’›
          </p>
        </div>
        <div style="display:flex;gap:10px;margin-top:18px;">
          <button id="supportYesBtn" class="btn primary" style="flex:1">CÃ³, mÃ¬nh muá»‘n Ä‘Æ°á»£c káº¿t ná»‘i</button>
          <button id="supportNoBtn" class="btn secondary" style="flex:1">MÃ¬nh á»•n rá»“i</button>
        </div>
        <!-- follow-up content will appear in a separate modal to avoid stacking -->
        <!-- (supportFollow removed - follow-ups are separate modals) -->
      </div>
    </div>
    
    <!-- Support: follow-up modal when user wants connection -->
    <div class="modal" id="supportConnectModal" role="dialog" aria-modal="true" style="display:none">
      <div class="sheet" style="max-width:520px;">
        <button class="x" id="supportConnectClose" aria-label="ÄÃ³ng modal">âœ•</button>
        <h3>Cáº£m Æ¡n báº¡n ğŸ’›</h3>
        <div style="line-height:1.5;color:var(--text-secondary);">
          <p>ChÃºng mÃ¬nh sáº½ dáº«n báº¡n Ä‘áº¿n Ä‘Æ°á»ng liÃªn káº¿t Ä‘á»ƒ káº¿t ná»‘i trá»±c tiáº¿p vá»›i Háº»m 202 â€” nÆ¡i cÃ³ cÃ¡n bá»™ tÆ° váº¥n sáºµn sÃ ng láº¯ng nghe.</p>
          <p><strong>Háº»m 202</strong> hoáº¡t Ä‘á»™ng dÆ°á»›i nguyÃªn táº¯c Æ°u tiÃªn báº£o máº­t vÃ  tÃ´n trá»ng. Má»i cuá»™c trÃ² chuyá»‡n Ä‘á»u Ä‘Æ°á»£c giá»¯ kÃ­n.</p>
          <div style="margin-top:12px;display:flex;gap:8px;">
            <button class="btn primary" id="supportOpenLinkModalBtn">Má»Ÿ liÃªn káº¿t káº¿t ná»‘i</button>
            <button class="btn secondary" id="supportConnectCloseBtn">ÄÃ³ng</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Support: simple thank-you modal when user says they're OK -->
    <div class="modal" id="supportThanksModal" role="dialog" aria-modal="true" style="display:none">
      <div class="sheet" style="max-width:520px;">
        <button class="x" id="supportThanksClose" aria-label="ÄÃ³ng modal">âœ•</button>
        <h3>Ráº¥t tá»‘t ğŸŒ»</h3>
        <div style="line-height:1.5;color:var(--text-secondary);">
          <p>Ráº¥t má»«ng khi biáº¿t báº¡n Ä‘ang á»•n. Náº¿u sau nÃ y báº¡n cáº§n, Háº»m 202 vÃ  cá»™ng Ä‘á»“ng luÃ´n á»Ÿ Ä‘Ã¢y Ä‘á»ƒ láº¯ng nghe.</p>
          <div style="margin-top:12px;"><button class="btn secondary" id="supportThanksOkBtn">ÄÃ³ng</button></div>
        </div>
      </div>
    </div>

    <script src="src/firebase-init.js"></script>
    <script src="src/auth.js"></script>
    <script src="src/auth-guard.js"></script>
    <script src="src/script.js" defer></script>
    <script src="src/modals.js"></script>
    <script>
      // EARLY AUTH CHECK - Cháº¡y NGAY Ä‘á»ƒ giáº£m FOUC
      (function () {
        // Inline check Ä‘á»ƒ cháº¡y nhanh nháº¥t cÃ³ thá»ƒ
        const cachedAuthKey = Object.keys(localStorage).find((key) =>
          key.startsWith("firebase:authUser:")
        );

        if (cachedAuthKey) {
          try {
            const cachedUser = JSON.parse(localStorage.getItem(cachedAuthKey));
            if (cachedUser && cachedUser.email) {
              // Update UI ngay láº­p tá»©c
              const authLoading = document.getElementById("authLoading");
              const userSection = document.getElementById("userSection");
              const userDisplayName =
                document.getElementById("userDisplayName");

              if (authLoading) authLoading.style.display = "none";
              if (userSection) userSection.style.display = "block";
              if (userDisplayName) {
                userDisplayName.textContent =
                  cachedUser.displayName || cachedUser.email.split("@")[0];
              }
            }
          } catch (e) {
            // Ignore errors
          }
        }
      })();

      // Setup logout button, settings button and auth state management
      document.addEventListener("DOMContentLoaded", () => {
        const logoutBtn = document.getElementById("logoutBtn");
        const settingsBtn = document.getElementById("settingsBtn");

        if (logoutBtn) {
          logoutBtn.addEventListener("click", (e) => {
            e.preventDefault();
            const logoutModal = document.getElementById("logoutModal");
            if (logoutModal) {
              logoutModal.style.display = "grid";
              logoutModal.classList.add("show");
              document.body.style.overflow = "hidden";
            }
          });

          // Modal handlers
          const confirmLogout = document.getElementById("confirmLogout");
          const cancelLogout = document.getElementById("cancelLogout");
          const closeLogoutModal = document.getElementById("closeLogoutModal");
          const logoutModal = document.getElementById("logoutModal");

          const doSignOut = async () => {
            try {
              if (window.AuthHelpers) await window.AuthHelpers.signOut();
            } catch (err) {
              console.warn("Sign out failed:", err);
            } finally {
              // Always reload to reset UI
              window.location.reload();
            }
          };

          if (confirmLogout) confirmLogout.addEventListener("click", doSignOut);
          const closeLogout = () => {
            if (logoutModal) {
              logoutModal.classList.remove("show");
              setTimeout(() => (logoutModal.style.display = "none"), 220);
              document.body.style.overflow = "auto";
            }
          };
          if (cancelLogout) cancelLogout.addEventListener("click", closeLogout);
          if (closeLogoutModal)
            closeLogoutModal.addEventListener("click", closeLogout);
          if (logoutModal)
            logoutModal.addEventListener("click", (ev) => {
              if (ev.target === logoutModal) closeLogout();
            });
        }

        // Settings button - Chuyá»ƒn Ä‘áº¿n trang profile
        if (settingsBtn) {
          settingsBtn.addEventListener("click", () => {
            navigateToPage("profile.html");
          });
        }
      });
    </script>
    <script>
      // Page transition function
      function navigateToPage(url) {
        document.body.classList.add("page-fade-out");
        setTimeout(() => {
          window.location.href = url;
        }, 250);
      }

      // Single DOMContentLoaded handler
      document.addEventListener("DOMContentLoaded", () => {
        // Ensure shared modals (terms/privacy) are available on this page
        if (window.ensureSharedModals) window.ensureSharedModals();
        // Add page transition on load
        const mainContent = document.getElementById("main-content");
        if (mainContent) {
          mainContent.classList.add("page-transition");
        }

        const dropdownMenu = document.getElementById("dropdownMenu");

        // Set up dropdown first so elements are accessible
        dropdownMenu.style.display = "block";
        dropdownMenu.style.visibility = "hidden";

        const themeToggle = document.getElementById("themeToggle");
        const helpModalBtn = document.getElementById("helpModalBtn");
        const termsModalBtn = document.getElementById("termsModalBtn");

        // Toggle dropdown menu - hamburger button
        const hamburger = document.getElementById("hamburger");
        if (hamburger) {
          hamburger.addEventListener("click", (e) => {
            e.stopPropagation();
            if (dropdownMenu.classList.contains("show")) {
              dropdownMenu.classList.remove("show");
            } else {
              dropdownMenu.style.visibility = "visible";
              dropdownMenu.classList.add("show");
            }
          });
        }

        // Close dropdown when clicking outside
        document.addEventListener("click", (e) => {
          if (
            !dropdownMenu.contains(e.target) &&
            !e.target.closest(".hamburger")
          ) {
            dropdownMenu.classList.remove("show");
          }
        });

        // Theme toggle functionality
        if (themeToggle) {
          const themeIcon = themeToggle.querySelector(".dropdown-icon");
          const themeText = themeToggle.querySelector(".dropdown-text");

          const updateThemeUI = () => {
            const isDark =
              document.documentElement.getAttribute("data-theme") === "dark";
            if (isDark) {
              if (themeIcon) themeIcon.textContent = "â˜€ï¸";
              if (themeText) themeText.textContent = "Cháº¿ Ä‘á»™ sÃ¡ng";
            } else {
              if (themeIcon) themeIcon.textContent = "ğŸŒ™";
              if (themeText) themeText.textContent = "Cháº¿ Ä‘á»™ tá»‘i";
            }
          };

          // Set initial theme on page load
          const currentTheme = localStorage.getItem("theme");
          if (currentTheme === "dark") {
            document.documentElement.setAttribute("data-theme", "dark");
            document.documentElement.classList.add("theme-night");
            document.documentElement.classList.remove("theme-day");
          } else {
            document.documentElement.removeAttribute("data-theme");
            document.documentElement.classList.add("theme-day");
            document.documentElement.classList.remove("theme-night");
          }
          updateThemeUI();

          themeToggle.addEventListener("click", () => {
            const isDark =
              document.documentElement.getAttribute("data-theme") === "dark";
            if (isDark) {
              document.documentElement.removeAttribute("data-theme");
              document.documentElement.classList.remove("theme-night");
              document.documentElement.classList.add("theme-day");
              localStorage.setItem("theme", "light");
            } else {
              document.documentElement.setAttribute("data-theme", "dark");
              document.documentElement.classList.remove("theme-day");
              document.documentElement.classList.add("theme-night");
              localStorage.setItem("theme", "dark");
            }

            window.dispatchEvent(
              new CustomEvent("theme-change", {
                detail: { theme: isDark ? "light" : "dark" },
              })
            );

            updateThemeUI();
            dropdownMenu.classList.remove("show");
          });
        }

        // Help modal
        if (helpModalBtn) {
          helpModalBtn.addEventListener("click", () => {
            dropdownMenu.classList.remove("show");
            const helpModal = document.getElementById("helpModal");
            if (helpModal) {
              helpModal.style.display = "flex";
              helpModal.classList.add("show");
              document.body.style.overflow = "hidden";
            }
          });
        }

        // Terms modal
        if (termsModalBtn) {
          termsModalBtn.addEventListener("click", () => {
            dropdownMenu.classList.remove("show");
            const termsModal = document.getElementById("termsModal");
            if (termsModal) {
              termsModal.style.display = "flex";
              termsModal.classList.add("show");
              document.body.style.overflow = "hidden";
            }
          });
        }

        // Modal close handlers
        const closeHelp = document.getElementById("closeHelpModal");
        const closeTerms = document.getElementById("closeTermsModal");
        const closeProject = document.getElementById("closeProjectInfoModal");
        const helpModal = document.getElementById("helpModal");
        const termsModal = document.getElementById("termsModal");
        const projectModal = document.getElementById("projectInfoModal");

        if (closeHelp && helpModal) {
          closeHelp.addEventListener("click", () => {
            helpModal.style.display = "none";
            helpModal.classList.remove("show");
            document.body.style.overflow = "auto";
          });
        }

        if (closeTerms && termsModal) {
          closeTerms.addEventListener("click", () => {
            termsModal.style.display = "none";
            termsModal.classList.remove("show");
            document.body.style.overflow = "auto";
          });
        }

        if (closeProject && projectModal) {
          closeProject.addEventListener("click", () => {
            projectModal.style.display = "none";
            projectModal.classList.remove("show");
            document.body.style.overflow = "auto";
          });
        }

        // Close modals when clicking outside
        [helpModal, termsModal, projectModal].forEach((modal) => {
          if (modal) {
            modal.addEventListener("click", (e) => {
              if (e.target === modal) {
                modal.style.display = "none";
                modal.classList.remove("show");
                document.body.style.overflow = "auto";
              }
            });
          }
        });

          // Support floating button (HáººM 202) handlers
          (function setupSupportFlow(){
            const supportBtn = document.getElementById('supportFloatingBtn');
            const supportModal = document.getElementById('supportModal');
            const supportClose = document.getElementById('supportCloseBtn');
            const supportYes = document.getElementById('supportYesBtn');
            const supportNo = document.getElementById('supportNoBtn');

            function openSupportModal(){
              if (!supportModal) return;
              supportModal.style.display = 'flex';
              supportModal.classList.add('show');
              document.body.style.overflow = 'hidden';
              // reset follow area (handled in separate modals)
            }

            function closeSupportModal(){
              if (!supportModal) return;
              supportModal.classList.remove('show');
              setTimeout(()=> supportModal.style.display = 'none', 220);
              document.body.style.overflow = 'auto';
            }

            if (supportBtn) supportBtn.addEventListener('click', openSupportModal);
            if (supportClose) supportClose.addEventListener('click', closeSupportModal);

            if (supportYes) supportYes.addEventListener('click', (e)=>{
              // Close the current support modal and open the connect modal after it hides
              closeSupportModal();
              setTimeout(()=>{
                const connect = document.getElementById('supportConnectModal');
                if (!connect) return;
                connect.style.display = 'flex';
                connect.classList.add('show');
                document.body.style.overflow = 'hidden';
              }, 260);
            });

            if (supportNo) supportNo.addEventListener('click', ()=>{
              // Close current modal then show a short thank-you modal
              closeSupportModal();
              setTimeout(()=>{
                const thanks = document.getElementById('supportThanksModal');
                if (!thanks) return;
                thanks.style.display = 'flex';
                thanks.classList.add('show');
                document.body.style.overflow = 'hidden';
              }, 260);
            });

            // Wire follow-up modals (connect / thanks) close buttons and actions
            // Connect modal
            const supportConnectModal = document.getElementById('supportConnectModal');
            const supportConnectClose = document.getElementById('supportConnectClose');
            const supportConnectCloseBtn = document.getElementById('supportConnectCloseBtn');
            const supportOpenLinkModalBtn = document.getElementById('supportOpenLinkModalBtn');
            function closeConnectModal(){
              if (!supportConnectModal) return;
              supportConnectModal.classList.remove('show');
              setTimeout(()=> supportConnectModal.style.display = 'none', 220);
              document.body.style.overflow = 'auto';
              try { supportBtn?.focus(); } catch(e){}
            }
            if (supportConnectClose) supportConnectClose.addEventListener('click', closeConnectModal);
            if (supportConnectCloseBtn) supportConnectCloseBtn.addEventListener('click', closeConnectModal);
            if (supportOpenLinkModalBtn) supportOpenLinkModalBtn.addEventListener('click', ()=>{
              window.open('https://www.facebook.com/phongtvtlfpthcm','_blank','noopener');
              closeConnectModal();
            });
            if (supportConnectModal) supportConnectModal.addEventListener('click',(e)=>{ if (e.target === supportConnectModal) closeConnectModal(); });

            // Thanks modal
            const supportThanksModal = document.getElementById('supportThanksModal');
            const supportThanksClose = document.getElementById('supportThanksClose');
            const supportThanksOkBtn = document.getElementById('supportThanksOkBtn');
            function closeThanksModal(){
              if (!supportThanksModal) return;
              supportThanksModal.classList.remove('show');
              setTimeout(()=> supportThanksModal.style.display = 'none', 220);
              document.body.style.overflow = 'auto';
              try { supportBtn?.focus(); } catch(e){}
            }
            if (supportThanksClose) supportThanksClose.addEventListener('click', closeThanksModal);
            if (supportThanksOkBtn) supportThanksOkBtn.addEventListener('click', closeThanksModal);
            if (supportThanksModal) supportThanksModal.addEventListener('click',(e)=>{ if (e.target === supportThanksModal) closeThanksModal(); });
          })();
      });
    </script>
  </body>
</html>
