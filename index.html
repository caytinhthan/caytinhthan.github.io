<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://firebase.googleapis.com https://www.google.com https://www.recaptcha.net https://apis.google.com https://apis.google.com/js/ https://*.firebasedatabase.app; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://*.firebaseio.com https://firebase.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://firebaseinstallations.googleapis.com https://www.googleapis.com https://content-firebaseappcheck.googleapis.com https://www.google.com https://www.recaptcha.net https://www.gstatic.com https://accounts.google.com wss://*.firebaseio.com wss://*.firebasedatabase.app https://*.firebasedatabase.app; frame-src https://www.google.com https://www.recaptcha.net https://accounts.google.com https://*.firebasedatabase.app;" />
    <title>Trang chủ | Cây Tinh Thần - Chia sẻ cảm xúc</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <!-- CSS Files -->
    <link rel="stylesheet" href="assets/styles.css" />
    <link rel="stylesheet" href="assets/main.css" />
    <link rel="stylesheet" href="assets/header.css" />
    <link rel="stylesheet" href="assets/tree.css" />
    <link rel="stylesheet" href="assets/chat.css" />
    <link rel="stylesheet" href="assets/modals.css" />
    <link rel="stylesheet" href="assets/leaves.css" />
  </head>
  <body>
    <!-- Header Navigation -->
    <div class="app-header">
      <div class="header-content">
        <div class="header-left">
          <a href="index.html" class="logo">
            <span class="logo-icon">🌱</span>
            <span class="logo-text">Cây Tinh Thần</span>
          </a>
        </div>

        <div class="header-right" id="headerRight">
          <!-- Auth Container - Centralized auth state management -->
          <div class="auth-container" id="authContainer">
            <!-- When logged out -->
            <div class="auth-section" id="authSection" style="display: none">
              <button
                class="header-btn login-btn"
                onclick="window.location.href='login.html'"
              >
                Đăng nhập
              </button>
              <button
                class="header-btn register-btn"
                onclick="window.location.href='register.html'"
              >
                Đăng ký
              </button>
            </div>

            <!-- Loading state - Hiện khi đang check auth -->
            <div class="auth-loading" id="authLoading" style="display: flex">
              <span style="color: #64748b; font-size: 14px">Đang tải...</span>
            </div>

            <!-- When logged in -->
            <div class="user-section" id="userSection" style="display: none">
              <div class="user-info">
                <div class="user-greeting">
                  <span>Xin chào, </span>
                  <strong id="userDisplayName"></strong>
                </div>
                <div class="user-actions">
                  <button
                    class="header-btn settings-btn"
                    id="settingsBtn"
                    title="Trang cá nhân"
                  >
                    <span>⚙️</span>
                    <span>Cá nhân</span>
                  </button>
                  <button class="header-btn logout-btn" id="logoutBtn">
                    <span>🚪</span>
                    <span>Đăng xuất</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <button class="hamburger" id="hamburger">
            <span></span>
            <span></span>
            <span></span>
          </button>

          <!-- Dropdown Menu -->
          <div class="dropdown-menu" id="dropdownMenu">
            <div class="dropdown-item" id="themeToggle">
              <span class="dropdown-icon">🌙</span>
              <span class="dropdown-text">Chế độ tối</span>
            </div>
            <div
              class="dropdown-item admin-only"
              onclick="navigateToPage('admin.html')"
              style="display: none"
            >
              <span class="dropdown-icon">🛡️</span>
              <span class="dropdown-text">Quản trị viên</span>
            </div>
            <div class="dropdown-item" id="helpModalBtn">
              <span class="dropdown-icon">📖</span>
              <span class="dropdown-text">Hướng dẫn sử dụng</span>
            </div>
            <div class="dropdown-item" id="termsModalBtn">
              <span class="dropdown-icon">📜</span>
              <span class="dropdown-text">Điều khoản</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <main class="layout page-transition" id="main-content">
      <!-- Panel trái -->
      <section class="panel left-panel">
        <div class="panel-header">
          <h1>🌱 Cây Tinh Thần</h1>
        </div>

        <div class="stats-section">
          <div class="stat-card">
            <div class="stat-icon">🌿</div>
            <div class="stat-content">
              <div class="stat-number" id="counter">0</div>
              <div class="stat-label">Số lá trên cây</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">💚</div>
            <div class="stat-content">
              <div class="stat-number" id="healedCounter">0</div>
              <div class="stat-label">Số lá đã chữa lành</div>
            </div>
          </div>
        </div>

        <div class="controls">
          <div class="view-mode-section">
            <label class="switch-container">
              <input type="checkbox" id="viewOnlyMode" />
              <span class="switch-slider"></span>
              <span class="switch-label">Chế độ chỉ xem</span>
            </label>
          </div>

          <div class="action-buttons" id="actionButtons">
            <!-- Auto-add removed: manual placement only -->
            <button class="btn secondary" id="toggleMode">
              <span class="btn-icon">🖱️</span>
              <span class="btn-text">Click để đặt</span>
            </button>
            <button class="btn tertiary" id="dragMode">
              <span class="btn-icon">✋</span>
              <span class="btn-text">Kéo thả</span>
            </button>
          </div>
        </div>

        <div class="additional-info">
          <div class="info-card">
            <div class="info-icon">💌</div>
            <div class="info-content">
              <h3>Gửi thông điệp yêu thương</h3>
              <p>
                Trước khi viết lên cây tinh thần, chúng mình mong bạn luôn nhớ
                rằng: đây là cây của những lời động viên, yêu thương và niềm
                tin. Mỗi lời bạn để lại sẽ trở thành ánh sáng nhỏ sưởi ấm trái
                tim một ai đó. Hãy chọn màu sắc riêng cho chiếc lá ứng với vấn
                đề bạn muốn gửi lời động viên nhé:
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- Sân khấu phải -->
      <section class="stage panel" id="stage">
        <!-- Day/Night Scene -->
        <div id="scene">
          <div class="sky"></div>
          <div class="sun"></div>
          <div class="moon"></div>
          <div class="clouds"></div>
          <canvas id="stars"></canvas>
          <div class="grass"></div>
        </div>

        <div id="app">
          <img
            id="tree"
            src="assets/tree/tree_transparent.png"
            alt="Cây Tinh Thần"
          />
          <canvas id="leafCanvas"></canvas>
          <svg
            id="leafSvg"
            style="
              position: absolute;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              pointer-events: auto;
            "
          >
            <g id="leaves"></g>
          </svg>
        </div>
        <div class="ground"></div>
        <div class="tooltip" id="tip"></div>
      </section>
    </main>

    <!-- Logout Confirmation Modal -->
    <div
      class="modal"
      id="logoutModal"
      role="dialog"
      aria-modal="true"
      style="display: none"
    >
      <div class="sheet">
        <button class="x" id="closeLogoutModal" aria-label="Đóng modal">
          ✕
        </button>
        <h3>🔒 Xác nhận đăng xuất</h3>
        <p style="color: var(--text-secondary)">
          Bạn có chắc muốn đăng xuất khỏi tài khoản của mình? Bạn sẽ cần đăng
          nhập lại để tiếp tục đăng lá.
        </p>
        <div style="display: flex; gap: 12px; margin-top: 18px">
          <button class="btn red" id="confirmLogout" style="flex: 1">
            Đăng xuất
          </button>
          <button class="btn secondary" id="cancelLogout" style="flex: 1">
            Hủy
          </button>
        </div>
      </div>
    </div>

    <!-- Login Prompt Modal (friendly) -->
    <div class="modal" id="loginPromptModal" role="dialog" aria-modal="true" style="display:none">
      <div class="sheet" style="max-width:420px;">
        <button class="x" aria-label="Đóng modal">✕</button>
        <h3>🔐 Bạn cần đăng nhập</h3>
        <p style="color:var(--text-secondary)">Để thêm hoặc chỉnh sửa lá trên cây, bạn cần đăng nhập. Bạn có thể đăng nhập bằng tài khoản hiện có hoặc tiếp tục xem dưới dạng khách.</p>
        <div style="display:flex;gap:12px;margin-top:18px;">
          <button class="btn primary login-now" style="flex:1">Đăng nhập</button>
          <button class="btn secondary login-cancel" style="flex:1">Tiếp tục xem</button>
        </div>
      </div>
    </div>

    <!-- Add/Edit Modal -->
    <div
      class="modal"
      id="addModal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="addModalTitle"
    >
      <div class="sheet">
        <button class="x" id="closeAddModal" aria-label="Đóng modal">✕</button>
        <h3 id="addModalTitle">🌿 Thêm lá mới</h3>
        <div class="form-section">
          <label>Thông điệp:</label>
          <textarea id="addMessage" placeholder="Nhập thông điệp..."></textarea>
        </div>
        <div class="form-section">
          <label>Tên của bạn:</label>
          <input
            type="text"
            id="addAuthor"
            placeholder="Nhập tên hoặc để trống (ẩn danh)"
          />
        </div>
        <div class="form-section">
          <label class="checkbox-label">
            <input type="checkbox" id="isAnonymous" />
            <span>Gửi ẩn danh</span>
          </label>
        </div>        

        <div class="picker picker-section" id="leafPicker">
          <div class="picker-row">
            <label>Hình dáng lá</label>
            <select id="leafShape">
              <option value="normal">Lá bình thường</option>
              <option value="withered">Lá héo úa</option>
            </select>
          </div>

          <div class="picker-row">
            <label>Độ xoay</label>
            <div style="display: flex; align-items: center; gap: 8px">
              <input
                type="range"
                id="leafRotation"
                min="0"
                max="360"
                step="5"
                value="0"
                style="flex: 1"
              />
              <span
                id="rotationValue"
                style="
                  min-width: 35px;
                  font-size: 12px;
                  color: var(--text-secondary);
                "
                >0°</span
              >
            </div>
          </div>

          <div class="preview" id="leafPreview">
            <div class="preview-label">Xem trước:</div>
            <div
              class="preview-leaf"
              style="
                display: flex;
                justify-content: center;
                align-items: center;
                height: 120px;
                padding: 0;
              "
            >
              <!-- Wrap the image so rotation/scale only affects the image itself -->
              <div class="preview-image-wrap" style="position:relative;">
                <img
                  id="previewLeafImage"
                  class="preview-image fill-frame modal-leaf-image"
                  src="assets/leaves/leaf_normal.png"
                  alt="Preview"
                  width="140"
                  height="140"
                />
              </div>
            </div>
          </div>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 20px">
          <button class="btn primary" id="saveLeaf" style="flex: 1">
            💾 Lưu
          </button>
          <button class="btn secondary" id="cancelAdd" style="flex: 1">
            ❌ Hủy
          </button>
        </div>
      </div>
    </div>

    <!-- Help Modal -->
    <div class="modal" id="helpModal" role="dialog" aria-modal="true">
      <div class="sheet">
        <button class="x" id="closeHelpModal" aria-label="Đóng hướng dẫn">
          ✕
        </button>
        <h3>❓ Hướng dẫn sử dụng</h3>
        <div class="help-content">
          <div class="help-section">
            <h4>🌿 Cách thêm lá:</h4>
            <ul>
              <li>
                <strong>Click để đặt:</strong> Bật chế độ này và click vào cây
                để đặt lá cây
              </li>
            </ul>
          </div>
          <div class="help-section">
            <h4>✏️ Tương tác với lá:</h4>
            <ul>
              <li>
                <strong>Xem thông điệp:</strong> Click vào bất kỳ chiếc lá nào
                để đọc nội dung
              </li>
              <li>
                <strong>Kéo thả:</strong> Bật chế độ kéo thả và giữ lá để di
                chuyển vị trí
              </li>
              <li>
                <strong>Sửa nội dung:</strong> Trong popup xem lá, bạn có thể
                chỉnh sửa thông điệp
              </li>
            </ul>
          </div>
          <div class="help-section">
            <h4>👁️ Chế độ chỉ xem:</h4>
            <p>
              Bật để khóa tất cả chức năng chỉnh sửa, chỉ cho phép xem thông
              điệp.
            </p>
          </div>
          <div class="help-section">
            <h4>🎨 Tùy chỉnh lá:</h4>
            <p>
              Khi thêm lá mới, bạn có thể chọn loại lá và góc xoay.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Terms Modal-->
    <div class="modal" id="termsModal" role="dialog" aria-modal="true" aria-labelledby="termsModalHeading">
      <div class="sheet" style="max-width:820px; width:96%; max-height:84vh; overflow:auto; padding:18px; box-sizing:border-box;">
        <button class="x" id="closeTermsModal" aria-label="Đóng điều khoản">✕</button>
        <h3 id="termsModalHeading">📜 Điều Khoản Sử Dụng — Cây Tinh Thần</h3>
        <div class="help-content" style="line-height:1.55; color:var(--ink);">
          <section style="margin-top:8px;">
            <h4>Lời Mở Đầu</h4>
            <p>Chào mừng bạn đến với trang web <strong>Cây Tinh Thần</strong> – một không gian số của dự án cộng đồng <em>Peace by Piece</em>. Sứ mệnh của chúng tôi là tạo ra một nơi an toàn để mọi người có thể gửi gắm và đón nhận những lời động viên, sẻ chia tích cực.</p>
            <p>Việc bạn gửi thông điệp hoặc sử dụng trang web này đồng nghĩa với việc bạn đã đọc, hiểu và đồng ý tuân thủ những quy định này.</p>
          </section>

          <section style="margin-top:12px;">
            <h4>Điều 1 — Chuẩn Mực Cộng Đồng - Hãy Cùng Nhau "Làm Xanh" Cây</h4>
            <p>Mỗi thông điệp bạn gửi đi là một chiếc lá, góp phần tạo nên tán cây tinh thần. Để tán cây này luôn xanh tươi và là nơi trú ẩn an toàn cho tâm hồn, chúng tôi mong bạn:</p>
            <ul>
              <li><strong>Gieo Hạt Tích Cực:</strong> Hãy chia sẻ những lời động viên, những câu chuyện tích cực, hoặc những lời chúc thiện chí và có tính xây dựng.</li>
              <li><strong>Tôn Trọng Sự Khác Biệt:</strong> Mỗi người có một câu chuyện riêng. Hãy đối xử với mọi thông điệp bằng sự tôn trọng, không phán xét.</li>
              <li><strong>Bảo Mật Tuyệt Đối:</strong> Nghiêm cấm đăng tải thông tin cá nhân của bản thân hoặc của bất kỳ ai khác (tên, số điện thoại, mạng xã hội...).</li>
            </ul>
            <p><strong>Nội dung bị cấm</strong>: Tuyệt đối không gửi các thông điệp chứa:</p>
            <ul>
              <li>Ngôn từ gây thù ghét, tấn công, phân biệt đối xử.</li>
              <li>Nội dung đe dọa, bắt nạt, quấy rối.</li>
              <li>Nội dung cổ suý hoặc hướng dẫn các hành vi tự hại.</li>
              <li>Thông tin sai lệch, lừa đảo, quảng cáo, spam hoặc các nội dung vi phạm pháp luật Việt Nam.</li>
            </ul>
          </section>

          <section style="margin-top:12px;">
            <h4>Điều 2 — Chính Sách Quyền Riêng Tư</h4>
            <p><strong>Thu Thập Thông Tin:</strong> Khi bạn gửi một thông điệp lên Cây Tinh Thần, chúng tôi chỉ thu thập và hiển thị công khai nội dung của thông điệp đó. Quá trình này hoàn toàn ẩn danh. Trang web không chủ động thu thập và không lưu trữ bất kỳ thông tin nhận dạng cá nhân nào như tên, email, hay địa chỉ IP khi chưa được sự cho phép của bạn.</p>
            <p><strong>Sử Dụng Thông Tin:</strong> Nội dung thông điệp của bạn được sử dụng duy nhất cho mục đích hiển thị công khai trên Cây Tinh Thần để lan tỏa năng lượng tích cực đến cộng đồng.</p>
          </section>

          <section style="margin-top:12px;">
            <h4>Điều 3 — Điều Khoản Pháp Lý</h4>
            <p><strong>KHÔNG THAY THẾ HỖ TRỢ CHUYÊN NGHIỆP:</strong> Quan trọng: Cây Tinh Thần là một nơi hỗ trợ tinh thần dựa trên sự chia sẻ đồng đẳng, <strong>KHÔNG PHẢI</strong> là dịch vụ trị liệu hay tư vấn tâm lý chuyên nghiệp.</p>
            <p>Nếu bạn hoặc ai đó bạn biết đang gặp khủng hoảng tinh thần hoặc khủng hoảng an toàn, xin hãy tìm đến sự giúp đỡ của các chuyên gia hoặc liên hệ các đường dây nóng uy tín ngay lập tức.</p>
            <p><strong>Quyền của Dự Án:</strong> Chúng tôi có toàn quyền kiểm duyệt và xóa bỏ bất kỳ thông điệp nào vi phạm các chuẩn mực cộng đồng mà không cần thông báo trước.</p>
          </section>

          <section style="margin-top:12px;">
            <h4>Điều 4 — Liên Hệ và Báo Cáo</h4>
            <p>Nếu bạn phát hiện một thông điệp vi phạm hoặc có bất kỳ thắc mắc nào, vui lòng liên hệ với chúng tôi qua:</p>
            <p><strong>Email:</strong> <a href="mailto:hkdaty.kng@gmail.com">hkdaty.kng@gmail.com</a></p>
          </section>

          <section style="margin-top:14px;font-size:13px;color:var(--muted);">
            <p>Cảm ơn bạn đã cùng chúng tôi vun đắp nên Cây Tinh Thần này.</p>
            <p><em>Phiên bản điều khoản: v1 • Ngày hiệu lực: 2025-10-25</em></p>
          </section>
        </div>
      </div>
    </div>

    <!-- Project Info Modal -->
    <div class="modal" id="projectInfoModal" role="dialog" aria-modal="true">
      <div class="sheet">
        <button
          class="x"
          id="closeProjectInfoModal"
          aria-label="Đóng thông tin dự án"
        >
          ✕
        </button>
        <h3>🌿 Cây tinh thần</h3>
        <div class="help-content">
          <p style="line-height: 1.6; margin-bottom: 16px">
            Trong guồng quay tất bật của cuộc sống, đôi khi chúng ta quên rằng
            hạnh phúc có thể đến từ những điều giản dị nhất. Dự án Peace by
            Piece ra đời để gửi gắm những lời yêu thương, động viên và hy vọng –
            như từng chiếc lá nhỏ mang trong mình thông điệp bình yên.
          </p>
          <p style="line-height: 1.6">
            Hãy để mỗi nụ cười, mỗi lời chia sẻ trở thành một mảnh ghép góp phần
            tạo nên bức tranh hạnh phúc trọn vẹn. 💌
          </p>
        </div>
      </div>
    </div>

    <!-- View Modal -->
    <div class="modal" id="modal" role="dialog" aria-modal="true">
      <div class="sheet">
        <button class="x" id="closeModal" aria-label="Đóng modal">✕</button>
        <h3>💌 Thông điệp</h3>
        <div class="leaf-card">
          <div class="leaf-preview">
            <img id="modalLeafImage" class="modal-leaf-image" src="" alt="Leaf preview" />
          </div>
          <div class="leaf-text">
            <p id="modalText"></p>
            <p id="modalAuthor"></p>
          </div>
        </div>
        <div class="leaf-actions">
          <div id="encourageSection" style="display: none; margin-bottom: 8px">
            <input
              id="encourageInput"
              type="text"
              placeholder="Gửi lời động viên..."
              style="width: 65%; padding: 6px; margin-right: 8px"
            />
            <button
              id="dropLoveBtn"
              class="btn pink"
              style="vertical-align: middle"
            >
              💖 Thả yêu thương
            </button>
          </div>

          <!-- List of encouragers - only visible to leaf owner -->
          <div id="encouragersList" style="display: none; margin-bottom: 8px;">
            <h4 style="margin:0 0 8px 0; font-size:13px">Những người đã an ủi</h4>
            <div id="encouragersItems" style="display:flex;flex-direction:column;gap:6px;max-height:200px;overflow:auto;padding-right:6px"></div>
          </div>

          <div
            id="ownerRecoverSection"
            style="display: none; margin-bottom: 8px"
          >
            <button
              id="ownerRecoverBtn"
              class="btn"
              style="background: #9ae6b4"
            >
              ✅ Tôi ổn rồi
            </button>
          </div>

          <button id="editLeaf" class="btn green">✏️ Sửa</button>
          <button id="deleteLeaf" class="btn red" style="display: none">
            🗑️ Xóa
          </button>
        </div>
      </div>
    </div>

    <!-- Support Floating Button & Modal (HẺM 202) -->
    <button id="supportFloatingBtn" aria-haspopup="dialog" aria-controls="supportModal" style="position:fixed;right:18px;bottom:20px;z-index:12000;background:#ffb703;color:#082032;border:none;padding:12px 14px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.18);font-weight:700;cursor:pointer;">Hỗ trợ</button>

    <div class="modal" id="supportModal" role="dialog" aria-modal="true" style="display:none">
      <div class="sheet" style="max-width:520px;">
        <button class="x" id="supportCloseBtn" aria-label="Đóng modal">✕</button>
        <h3>Chào bạn 🌼</h3>
        <div id="supportContent" style="line-height:1.5;color:var(--text-secondary);">
          <p>
            Nếu bạn vẫn chưa cảm thấy ổn, và có nhiều điều chưa thể nói ra — đừng chịu đựng một mình nhé.. Chúng mình sẽ giúp bạn kết nối trực tiếp với <strong>HẺM 202 [ BỘ PHẬN TƯ VẤN TÂM LÝ TẠI TRƯỜNG ĐH FPT TP.HCM]</strong>. Đây là nơi bạn có thể thoải mái chia sẻ cảm xúc cùng cán bộ tâm lý giàu kinh nghiệm, luôn sẵn sàng lắng nghe và đồng hành cùng bạn.
            Đừng ngần ngại mở lòng nhé — nhấn vào nút bên dưới để bắt đầu 💛
          </p>
        </div>
        <div style="display:flex;gap:10px;margin-top:18px;">
          <button id="supportYesBtn" class="btn primary" style="flex:1">Có, mình muốn được kết nối</button>
          <button id="supportNoBtn" class="btn secondary" style="flex:1">Mình ổn rồi</button>
        </div>
        <!-- follow-up content will appear in a separate modal to avoid stacking -->
        <!-- (supportFollow removed - follow-ups are separate modals) -->
      </div>
    </div>
    
    <!-- Support: follow-up modal when user wants connection -->
    <div class="modal" id="supportConnectModal" role="dialog" aria-modal="true" style="display:none">
      <div class="sheet" style="max-width:520px;">
        <button class="x" id="supportConnectClose" aria-label="Đóng modal">✕</button>
        <h3>Cảm ơn bạn 💛</h3>
        <div style="line-height:1.5;color:var(--text-secondary);">
          <p>Chúng mình sẽ dẫn bạn đến đường liên kết để kết nối trực tiếp với Hẻm 202 — nơi có cán bộ tư vấn sẵn sàng lắng nghe.</p>
          <p><strong>Hẻm 202</strong> hoạt động dưới nguyên tắc ưu tiên bảo mật và tôn trọng. Mọi cuộc trò chuyện đều được giữ kín.</p>
          <div style="margin-top:12px;display:flex;gap:8px;">
            <button class="btn primary" id="supportOpenLinkModalBtn">Mở liên kết kết nối</button>
            <button class="btn secondary" id="supportConnectCloseBtn">Đóng</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Support: simple thank-you modal when user says they're OK -->
    <div class="modal" id="supportThanksModal" role="dialog" aria-modal="true" style="display:none">
      <div class="sheet" style="max-width:520px;">
        <button class="x" id="supportThanksClose" aria-label="Đóng modal">✕</button>
        <h3>Rất tốt 🌻</h3>
        <div style="line-height:1.5;color:var(--text-secondary);">
          <p>Rất mừng khi biết bạn đang ổn. Nếu sau này bạn cần, Hẻm 202 và cộng đồng luôn ở đây để lắng nghe.</p>
          <div style="margin-top:12px;"><button class="btn secondary" id="supportThanksOkBtn">Đóng</button></div>
        </div>
      </div>
    </div>

    <script src="src/firebase-init.js"></script>
    <script src="src/auth.js"></script>
    <script src="src/auth-guard.js"></script>
    <script src="src/script.js" defer></script>
    <script src="src/modals.js"></script>
    <script>
      // EARLY AUTH CHECK - Chạy NGAY để giảm FOUC
      (function () {
        // Inline check để chạy nhanh nhất có thể
        const cachedAuthKey = Object.keys(localStorage).find((key) =>
          key.startsWith("firebase:authUser:")
        );

        if (cachedAuthKey) {
          try {
            const cachedUser = JSON.parse(localStorage.getItem(cachedAuthKey));
            if (cachedUser && cachedUser.email) {
              // Update UI ngay lập tức
              const authLoading = document.getElementById("authLoading");
              const userSection = document.getElementById("userSection");
              const userDisplayName =
                document.getElementById("userDisplayName");

              if (authLoading) authLoading.style.display = "none";
              if (userSection) userSection.style.display = "block";
              if (userDisplayName) {
                userDisplayName.textContent =
                  cachedUser.displayName || cachedUser.email.split("@")[0];
              }
            }
          } catch (e) {
            // Ignore errors
          }
        }
      })();

      // Setup logout button, settings button and auth state management
      document.addEventListener("DOMContentLoaded", () => {
        const logoutBtn = document.getElementById("logoutBtn");
        const settingsBtn = document.getElementById("settingsBtn");

        if (logoutBtn) {
          logoutBtn.addEventListener("click", (e) => {
            e.preventDefault();
            const logoutModal = document.getElementById("logoutModal");
            if (logoutModal) {
              logoutModal.style.display = "grid";
              logoutModal.classList.add("show");
              document.body.style.overflow = "hidden";
            }
          });

          // Modal handlers
          const confirmLogout = document.getElementById("confirmLogout");
          const cancelLogout = document.getElementById("cancelLogout");
          const closeLogoutModal = document.getElementById("closeLogoutModal");
          const logoutModal = document.getElementById("logoutModal");

          const doSignOut = async () => {
            try {
              if (window.AuthHelpers) await window.AuthHelpers.signOut();
            } catch (err) {
              console.warn("Sign out failed:", err);
            } finally {
              // Always reload to reset UI
              window.location.reload();
            }
          };

          if (confirmLogout) confirmLogout.addEventListener("click", doSignOut);
          const closeLogout = () => {
            if (logoutModal) {
              logoutModal.classList.remove("show");
              setTimeout(() => (logoutModal.style.display = "none"), 220);
              document.body.style.overflow = "auto";
            }
          };
          if (cancelLogout) cancelLogout.addEventListener("click", closeLogout);
          if (closeLogoutModal)
            closeLogoutModal.addEventListener("click", closeLogout);
          if (logoutModal)
            logoutModal.addEventListener("click", (ev) => {
              if (ev.target === logoutModal) closeLogout();
            });
        }

        // Settings button - Chuyển đến trang profile
        if (settingsBtn) {
          settingsBtn.addEventListener("click", () => {
            navigateToPage("profile.html");
          });
        }
      });
    </script>
    <script>
      // Page transition function
      function navigateToPage(url) {
        document.body.classList.add("page-fade-out");
        setTimeout(() => {
          window.location.href = url;
        }, 250);
      }

      // Single DOMContentLoaded handler
      document.addEventListener("DOMContentLoaded", () => {
        // Ensure shared modals (terms/privacy) are available on this page
        if (window.ensureSharedModals) window.ensureSharedModals();
        // Add page transition on load
        const mainContent = document.getElementById("main-content");
        if (mainContent) {
          mainContent.classList.add("page-transition");
        }

        const dropdownMenu = document.getElementById("dropdownMenu");

        // Set up dropdown first so elements are accessible
        dropdownMenu.style.display = "block";
        dropdownMenu.style.visibility = "hidden";

        const themeToggle = document.getElementById("themeToggle");
        const helpModalBtn = document.getElementById("helpModalBtn");
        const termsModalBtn = document.getElementById("termsModalBtn");

        // Toggle dropdown menu - hamburger button
        const hamburger = document.getElementById("hamburger");
        if (hamburger) {
          hamburger.addEventListener("click", (e) => {
            e.stopPropagation();
            if (dropdownMenu.classList.contains("show")) {
              dropdownMenu.classList.remove("show");
            } else {
              dropdownMenu.style.visibility = "visible";
              dropdownMenu.classList.add("show");
            }
          });
        }

        // Close dropdown when clicking outside
        document.addEventListener("click", (e) => {
          if (
            !dropdownMenu.contains(e.target) &&
            !e.target.closest(".hamburger")
          ) {
            dropdownMenu.classList.remove("show");
          }
        });

        // Theme toggle functionality
        if (themeToggle) {
          const themeIcon = themeToggle.querySelector(".dropdown-icon");
          const themeText = themeToggle.querySelector(".dropdown-text");

          const updateThemeUI = () => {
            const isDark =
              document.documentElement.getAttribute("data-theme") === "dark";
            if (isDark) {
              if (themeIcon) themeIcon.textContent = "☀️";
              if (themeText) themeText.textContent = "Chế độ sáng";
            } else {
              if (themeIcon) themeIcon.textContent = "🌙";
              if (themeText) themeText.textContent = "Chế độ tối";
            }
          };

          // Set initial theme on page load
          const currentTheme = localStorage.getItem("theme");
          if (currentTheme === "dark") {
            document.documentElement.setAttribute("data-theme", "dark");
            document.documentElement.classList.add("theme-night");
            document.documentElement.classList.remove("theme-day");
          } else {
            document.documentElement.removeAttribute("data-theme");
            document.documentElement.classList.add("theme-day");
            document.documentElement.classList.remove("theme-night");
          }
          updateThemeUI();

          themeToggle.addEventListener("click", () => {
            const isDark =
              document.documentElement.getAttribute("data-theme") === "dark";
            if (isDark) {
              document.documentElement.removeAttribute("data-theme");
              document.documentElement.classList.remove("theme-night");
              document.documentElement.classList.add("theme-day");
              localStorage.setItem("theme", "light");
            } else {
              document.documentElement.setAttribute("data-theme", "dark");
              document.documentElement.classList.remove("theme-day");
              document.documentElement.classList.add("theme-night");
              localStorage.setItem("theme", "dark");
            }

            window.dispatchEvent(
              new CustomEvent("theme-change", {
                detail: { theme: isDark ? "light" : "dark" },
              })
            );

            updateThemeUI();
            dropdownMenu.classList.remove("show");
          });
        }

        // Help modal
        if (helpModalBtn) {
          helpModalBtn.addEventListener("click", () => {
            dropdownMenu.classList.remove("show");
            const helpModal = document.getElementById("helpModal");
            if (helpModal) {
              helpModal.style.display = "flex";
              helpModal.classList.add("show");
              document.body.style.overflow = "hidden";
            }
          });
        }

        // Terms modal
        if (termsModalBtn) {
          termsModalBtn.addEventListener("click", () => {
            dropdownMenu.classList.remove("show");
            const termsModal = document.getElementById("termsModal");
            if (termsModal) {
              termsModal.style.display = "flex";
              termsModal.classList.add("show");
              document.body.style.overflow = "hidden";
            }
          });
        }

        // Modal close handlers
        const closeHelp = document.getElementById("closeHelpModal");
        const closeTerms = document.getElementById("closeTermsModal");
        const closeProject = document.getElementById("closeProjectInfoModal");
        const helpModal = document.getElementById("helpModal");
        const termsModal = document.getElementById("termsModal");
        const projectModal = document.getElementById("projectInfoModal");

        if (closeHelp && helpModal) {
          closeHelp.addEventListener("click", () => {
            helpModal.style.display = "none";
            helpModal.classList.remove("show");
            document.body.style.overflow = "auto";
          });
        }

        if (closeTerms && termsModal) {
          closeTerms.addEventListener("click", () => {
            termsModal.style.display = "none";
            termsModal.classList.remove("show");
            document.body.style.overflow = "auto";
          });
        }

        if (closeProject && projectModal) {
          closeProject.addEventListener("click", () => {
            projectModal.style.display = "none";
            projectModal.classList.remove("show");
            document.body.style.overflow = "auto";
          });
        }

        // Close modals when clicking outside
        [helpModal, termsModal, projectModal].forEach((modal) => {
          if (modal) {
            modal.addEventListener("click", (e) => {
              if (e.target === modal) {
                modal.style.display = "none";
                modal.classList.remove("show");
                document.body.style.overflow = "auto";
              }
            });
          }
        });

          // Support floating button (HẺM 202) handlers
          (function setupSupportFlow(){
            const supportBtn = document.getElementById('supportFloatingBtn');
            const supportModal = document.getElementById('supportModal');
            const supportClose = document.getElementById('supportCloseBtn');
            const supportYes = document.getElementById('supportYesBtn');
            const supportNo = document.getElementById('supportNoBtn');

            function openSupportModal(){
              if (!supportModal) return;
              supportModal.style.display = 'flex';
              supportModal.classList.add('show');
              document.body.style.overflow = 'hidden';
              // reset follow area (handled in separate modals)
            }

            function closeSupportModal(){
              if (!supportModal) return;
              supportModal.classList.remove('show');
              setTimeout(()=> supportModal.style.display = 'none', 220);
              document.body.style.overflow = 'auto';
            }

            if (supportBtn) supportBtn.addEventListener('click', openSupportModal);
            if (supportClose) supportClose.addEventListener('click', closeSupportModal);

            if (supportYes) supportYes.addEventListener('click', (e)=>{
              // Close the current support modal and open the connect modal after it hides
              closeSupportModal();
              setTimeout(()=>{
                const connect = document.getElementById('supportConnectModal');
                if (!connect) return;
                connect.style.display = 'flex';
                connect.classList.add('show');
                document.body.style.overflow = 'hidden';
              }, 260);
            });

            if (supportNo) supportNo.addEventListener('click', ()=>{
              // Close current modal then show a short thank-you modal
              closeSupportModal();
              setTimeout(()=>{
                const thanks = document.getElementById('supportThanksModal');
                if (!thanks) return;
                thanks.style.display = 'flex';
                thanks.classList.add('show');
                document.body.style.overflow = 'hidden';
              }, 260);
            });

            // Wire follow-up modals (connect / thanks) close buttons and actions
            // Connect modal
            const supportConnectModal = document.getElementById('supportConnectModal');
            const supportConnectClose = document.getElementById('supportConnectClose');
            const supportConnectCloseBtn = document.getElementById('supportConnectCloseBtn');
            const supportOpenLinkModalBtn = document.getElementById('supportOpenLinkModalBtn');
            function closeConnectModal(){
              if (!supportConnectModal) return;
              supportConnectModal.classList.remove('show');
              setTimeout(()=> supportConnectModal.style.display = 'none', 220);
              document.body.style.overflow = 'auto';
              try { supportBtn?.focus(); } catch(e){}
            }
            if (supportConnectClose) supportConnectClose.addEventListener('click', closeConnectModal);
            if (supportConnectCloseBtn) supportConnectCloseBtn.addEventListener('click', closeConnectModal);
            if (supportOpenLinkModalBtn) supportOpenLinkModalBtn.addEventListener('click', ()=>{
              window.open('https://www.facebook.com/phongtvtlfpthcm','_blank','noopener');
              closeConnectModal();
            });
            if (supportConnectModal) supportConnectModal.addEventListener('click',(e)=>{ if (e.target === supportConnectModal) closeConnectModal(); });

            // Thanks modal
            const supportThanksModal = document.getElementById('supportThanksModal');
            const supportThanksClose = document.getElementById('supportThanksClose');
            const supportThanksOkBtn = document.getElementById('supportThanksOkBtn');
            function closeThanksModal(){
              if (!supportThanksModal) return;
              supportThanksModal.classList.remove('show');
              setTimeout(()=> supportThanksModal.style.display = 'none', 220);
              document.body.style.overflow = 'auto';
              try { supportBtn?.focus(); } catch(e){}
            }
            if (supportThanksClose) supportThanksClose.addEventListener('click', closeThanksModal);
            if (supportThanksOkBtn) supportThanksOkBtn.addEventListener('click', closeThanksModal);
            if (supportThanksModal) supportThanksModal.addEventListener('click',(e)=>{ if (e.target === supportThanksModal) closeThanksModal(); });
          })();
      });
    </script>
  </body>
</html>
