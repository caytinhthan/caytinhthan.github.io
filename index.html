<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://firebase.googleapis.com https://www.google.com https://www.recaptcha.net https://apis.google.com https://apis.google.com/js/ https://*.firebasedatabase.app; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://*.firebaseio.com https://firebase.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://firebaseinstallations.googleapis.com https://www.googleapis.com https://content-firebaseappcheck.googleapis.com https://www.google.com https://www.recaptcha.net https://www.gstatic.com https://accounts.google.com wss://*.firebaseio.com wss://*.firebasedatabase.app https://*.firebasedatabase.app; frame-src https://www.google.com https://www.recaptcha.net https://accounts.google.com https://*.firebasedatabase.app;" />
    <title>Trang chแปง | Cรขy Tรฌnh Thแบงn - Chia sแบป cแบฃm xรบc</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <!-- CSS Files -->
    <link rel="stylesheet" href="assets/styles.css" />
    <link rel="stylesheet" href="assets/main.css" />
    <link rel="stylesheet" href="assets/header.css" />
    <link rel="stylesheet" href="assets/tree.css" />
    <link rel="stylesheet" href="assets/chat.css" />
    <link rel="stylesheet" href="assets/modals.css" />
    <link rel="stylesheet" href="assets/leaves.css" />
  </head>
  <body>
    <!-- Header Navigation -->
    <div class="app-header">
      <div class="header-content">
        <div class="header-left">
          <a href="index.html" class="logo">
            <span class="logo-icon">๐ฑ</span>
            <span class="logo-text">Cรขy Tรฌnh Thแบงn</span>
          </a>
        </div>

        <div class="header-right" id="headerRight">
          <!-- Auth Container - Centralized auth state management -->
          <div class="auth-container" id="authContainer">
            <!-- When logged out -->
            <div class="auth-section" id="authSection" style="display: none">
              <button
                class="header-btn login-btn"
                onclick="window.location.href='login.html'"
              >
                ฤฤng nhแบญp
              </button>
              <button
                class="header-btn register-btn"
                onclick="window.location.href='register.html'"
              >
                ฤฤng kรฝ
              </button>
            </div>

            <!-- Loading state - Hiแปn khi ฤang check auth -->
            <div class="auth-loading" id="authLoading" style="display: flex">
              <span style="color: #64748b; font-size: 14px">ฤang tแบฃi...</span>
            </div>

            <!-- When logged in -->
            <div class="user-section" id="userSection" style="display: none">
              <div class="user-info">
                <div class="user-greeting">
                  <span>Xin chรo, </span>
                  <strong id="userDisplayName"></strong>
                </div>
                <div class="user-actions">
                  <button
                    class="header-btn settings-btn"
                    id="settingsBtn"
                    title="Trang cรก nhรขn"
                  >
                    <span>โ๏ธ</span>
                    <span>Cรก nhรขn</span>
                  </button>
                  <button class="header-btn logout-btn" id="logoutBtn">
                    <span>๐ช</span>
                    <span>ฤฤng xuแบฅt</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <button class="hamburger" id="hamburger">
            <span></span>
            <span></span>
            <span></span>
          </button>

          <!-- Dropdown Menu -->
          <div class="dropdown-menu" id="dropdownMenu">
            <div class="dropdown-item" id="themeToggle">
              <span class="dropdown-icon">๐</span>
              <span class="dropdown-text">Chแบฟ ฤแป tแปi</span>
            </div>
            <div
              class="dropdown-item admin-only"
              onclick="navigateToPage('admin.html')"
              style="display: none"
            >
              <span class="dropdown-icon">๐ก๏ธ</span>
              <span class="dropdown-text">Quแบฃn trแป viรชn</span>
            </div>
            <div class="dropdown-item" id="helpModalBtn">
              <span class="dropdown-icon">๐</span>
              <span class="dropdown-text">Hฦฐแปng dแบซn sแปญ dแปฅng</span>
            </div>
            <div class="dropdown-item" id="termsModalBtn">
              <span class="dropdown-icon">๐</span>
              <span class="dropdown-text">ฤiแปu khoแบฃn</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <main class="layout page-transition" id="main-content">
      <!-- Panel trรกi -->
      <section class="panel left-panel">
        <div class="panel-header">
          <h1>๐ฑ Cรขy Tinh Thแบงn</h1>
        </div>

        <div class="stats-section">
          <div class="stat-card">
            <div class="stat-icon">๐ฟ</div>
            <div class="stat-content">
              <div class="stat-number" id="counter">0</div>
              <div class="stat-label">Sแป lรก trรชn cรขy</div>
            </div>
          </div>
        </div>

        <div class="controls">
          <div class="view-mode-section">
            <label class="switch-container">
              <input type="checkbox" id="viewOnlyMode" />
              <span class="switch-slider"></span>
              <span class="switch-label">Chแบฟ ฤแป chแป xem</span>
            </label>
          </div>

          <div class="action-buttons" id="actionButtons">
            <!-- Auto-add removed: manual placement only -->
            <button class="btn secondary" id="toggleMode">
              <span class="btn-icon">๐ฑ๏ธ</span>
              <span class="btn-text">Click ฤแป ฤแบทt</span>
            </button>
            <button class="btn tertiary" id="dragMode">
              <span class="btn-icon">โ</span>
              <span class="btn-text">Kรฉo thแบฃ</span>
            </button>
          </div>
        </div>

        <div class="additional-info">
          <div class="info-card">
            <div class="info-icon">๐</div>
            <div class="info-content">
              <h3>Gแปญi thรดng ฤiแปp yรชu thฦฐฦกng</h3>
              <p>
                Trฦฐแปc khi viแบฟt lรชn cรขy tinh thแบงn, chรบng mรฌnh mong bแบกn luรดn nhแป
                rแบฑng: ฤรขy lร cรขy cแปงa nhแปฏng lแปi ฤแปng viรชn, yรชu thฦฐฦกng vร niแปm
                tin. Mแปi lแปi bแบกn ฤแป lแบกi sแบฝ trแป thรnh รกnh sรกng nhแป sฦฐแปi แบฅm trรกi
                tim mแปt ai ฤรณ. Hรฃy chแปn mรu sแบฏc riรชng cho chiแบฟc lรก แปฉng vแปi vแบฅn
                ฤแป bแบกn muแปn gแปญi lแปi ฤแปng viรชn nhรฉ:
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- Sรขn khแบฅu phแบฃi -->
      <section class="stage panel" id="stage">
        <!-- Day/Night Scene -->
        <div id="scene">
          <div class="sky"></div>
          <div class="sun"></div>
          <div class="moon"></div>
          <div class="clouds"></div>
          <canvas id="stars"></canvas>
          <div class="grass"></div>
        </div>

        <div id="app">
          <img
            id="tree"
            src="assets/tree/tree_transparent.png"
            alt="Cรขy Tรฌnh Thแบงn"
          />
          <canvas id="leafCanvas"></canvas>
          <svg
            id="leafSvg"
            style="
              position: absolute;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              pointer-events: auto;
            "
          >
            <g id="leaves"></g>
          </svg>
        </div>
        <div class="ground"></div>
        <div class="tooltip" id="tip"></div>
      </section>
    </main>

    <!-- Logout Confirmation Modal -->
    <div
      class="modal"
      id="logoutModal"
      role="dialog"
      aria-modal="true"
      style="display: none"
    >
      <div class="sheet">
        <button class="x" id="closeLogoutModal" aria-label="ฤรณng modal">
          โ
        </button>
        <h3>๐ Xรกc nhแบญn ฤฤng xuแบฅt</h3>
        <p style="color: var(--text-secondary)">
          Bแบกn cรณ chแบฏc muแปn ฤฤng xuแบฅt khแปi tรi khoแบฃn cแปงa mรฌnh? Bแบกn sแบฝ cแบงn ฤฤng
          nhแบญp lแบกi ฤแป tiแบฟp tแปฅc ฤฤng lรก.
        </p>
        <div style="display: flex; gap: 12px; margin-top: 18px">
          <button class="btn red" id="confirmLogout" style="flex: 1">
            ฤฤng xuแบฅt
          </button>
          <button class="btn secondary" id="cancelLogout" style="flex: 1">
            Hแปงy
          </button>
        </div>
      </div>
    </div>

    <!-- Login Prompt Modal (friendly) -->
    <div class="modal" id="loginPromptModal" role="dialog" aria-modal="true" style="display:none">
      <div class="sheet" style="max-width:420px;">
        <button class="x" aria-label="ฤรณng modal">โ</button>
        <h3>๐ Bแบกn cแบงn ฤฤng nhแบญp</h3>
        <p style="color:var(--text-secondary)">ฤแป thรชm hoแบทc chแปnh sแปญa lรก trรชn cรขy, bแบกn cแบงn ฤฤng nhแบญp. Bแบกn cรณ thแป ฤฤng nhแบญp bแบฑng tรi khoแบฃn hiแปn cรณ hoแบทc tiแบฟp tแปฅc xem dฦฐแปi dแบกng khรกch.</p>
        <div style="display:flex;gap:12px;margin-top:18px;">
          <button class="btn primary login-now" style="flex:1">ฤฤng nhแบญp</button>
          <button class="btn secondary login-cancel" style="flex:1">Tiแบฟp tแปฅc xem</button>
        </div>
      </div>
    </div>

    <!-- Add/Edit Modal -->
    <div
      class="modal"
      id="addModal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="addModalTitle"
    >
      <div class="sheet">
        <button class="x" id="closeAddModal" aria-label="ฤรณng modal">โ</button>
        <h3 id="addModalTitle">๐ฟ Thรชm lรก mแปi</h3>
        <div class="form-section">
          <label>Thรดng ฤiแปp:</label>
          <textarea id="addMessage" placeholder="Nhแบญp thรดng ฤiแปp..."></textarea>
        </div>
        <div class="form-section">
          <label>Tรชn cแปงa bแบกn:</label>
          <input
            type="text"
            id="addAuthor"
            placeholder="Nhแบญp tรชn hoแบทc ฤแป trแปng (แบฉn danh)"
          />
        </div>
        <div class="form-section">
          <label class="checkbox-label">
            <input type="checkbox" id="isAnonymous" />
            <span>Gแปญi แบฉn danh</span>
          </label>
        </div>
        <!-- Withered option moved into the picker so shape + withered flag live together -->
        

        <div class="picker picker-section" id="leafPicker">
          <div class="picker-row">
            <label>Hรฌnh dรกng lรก</label>
            <select id="leafShape">
              <option value="oval">DแบNG 1</option>
              <option value="round">DแบNG 2</option>
              <option value="pointed">DแบNG 3</option>
              <option value="heart">DแบNG 4</option>
              <option value="star">DแบNG 5</option>
              <option value="maple">DแบNG 6</option>
              <option value="willow">DแบNG 7</option>
              <option value="dry_brown">DแบNG 8</option>
            </select>
          </div>

          <div class="picker-row">
            <label style="font-weight: 600">Mรu sแบฏc lรก</label>
            <select id="leafPalette">
              <option value="0">๐ Vรng</option>
              <option value="1">๐ Hแปng</option>
              <option value="2">๐ Xanh lรก</option>
              <option value="3">๐ Xanh dฦฐฦกng</option>
              <option value="4">๐ Tรญm</option>
              <option value="5">โค๏ธ ฤแป</option>
            </select>
          </div>

          <!-- withered checkbox removed (moved/merged previously). -->

          <!-- Size control removed: default scale is applied in script -->

          <div class="picker-row">
            <label>ฤแป xoay</label>
            <div style="display: flex; align-items: center; gap: 8px">
              <input
                type="range"
                id="leafRotation"
                min="0"
                max="360"
                step="5"
                value="0"
                style="flex: 1"
              />
              <span
                id="rotationValue"
                style="
                  min-width: 35px;
                  font-size: 12px;
                  color: var(--text-secondary);
                "
                >0ยฐ</span
              >
            </div>
          </div>

          <div class="preview" id="leafPreview">
            <div class="preview-label">Xem trฦฐแปc:</div>
            <div
              class="preview-leaf"
              style="
                display: flex;
                justify-content: center;
                align-items: center;
                height: 120px;
                padding: 0;
              "
            >
              <!-- Wrap the image so rotation/scale only affects the image itself -->
              <div class="preview-image-wrap" style="position:relative;">
                <img
                  id="previewLeafImage"
                  class="preview-image fill-frame modal-leaf-image"
                  src="assets/leaves/oval/leaf_oval_yellow.png"
                  alt="Preview"
                  width="140"
                  height="140"
                />
              </div>
            </div>
          </div>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 20px">
          <button class="btn primary" id="saveLeaf" style="flex: 1">
            ๐พ Lฦฐu
          </button>
          <button class="btn secondary" id="cancelAdd" style="flex: 1">
            โ Hแปงy
          </button>
        </div>
      </div>
    </div>

    <!-- Help Modal -->
    <div class="modal" id="helpModal" role="dialog" aria-modal="true">
      <div class="sheet">
        <button class="x" id="closeHelpModal" aria-label="ฤรณng hฦฐแปng dแบซn">
          โ
        </button>
        <h3>โ Hฦฐแปng dแบซn sแปญ dแปฅng</h3>
        <div class="help-content">
          <div class="help-section">
            <h4>๐ฟ Cรกch thรชm lรก:</h4>
            <ul>
              <!-- Auto-add feature removed: users should use "Click ฤแป ฤแบทt" or drag mode -->
              <li>
                <strong>Click ฤแป ฤแบทt:</strong> Bแบญt chแบฟ ฤแป nรy vร click vรo cรขy
                ฤแป ฤแบทt lรก chรญnh xรกc
              </li>
            </ul>
          </div>
          <div class="help-section">
            <h4>โ๏ธ Tฦฐฦกng tรกc vแปi lรก:</h4>
            <ul>
              <li>
                <strong>Xem thรดng ฤiแปp:</strong> Click vรo bแบฅt kแปณ chiแบฟc lรก nรo
                ฤแป ฤแปc nแปi dung
              </li>
              <li>
                <strong>Kรฉo thแบฃ:</strong> Bแบญt chแบฟ ฤแป kรฉo thแบฃ vร giแปฏ lรก ฤแป di
                chuyแปn vแป trรญ
              </li>
              <li>
                <strong>Sแปญa nแปi dung:</strong> Trong popup xem lรก, bแบกn cรณ thแป
                chแปnh sแปญa thรดng ฤiแปp
              </li>
            </ul>
          </div>
          <div class="help-section">
            <h4>๐๏ธ Chแบฟ ฤแป chแป xem:</h4>
            <p>
              Bแบญt ฤแป khรณa tแบฅt cแบฃ chแปฉc nฤng chแปnh sแปญa, chแป cho phรฉp xem thรดng
              ฤiแปp.
            </p>
          </div>
          <div class="help-section">
            <h4>๐จ Tรนy chแปnh lรก:</h4>
            <p>
              Khi thรชm lรก mแปi, bแบกn cรณ thแป chแปn hรฌnh dรกng, mรu sแบฏc, kรญch thฦฐแปc vร
              gรณc xoay.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Terms Modal -->
    <div class="modal" id="termsModal" role="dialog" aria-modal="true">
      <div class="sheet">
        <button class="x" id="closeTermsModal" aria-label="ฤรณng ฤiแปu khoแบฃn">
          โ
        </button>
        <h3>๐ ฤiแปu khoแบฃn</h3>
        <div class="help-content">
          <p style="line-height: 1.6; margin-bottom: 16px">
            Trong guแปng quay tแบฅt bแบญt cแปงa cuแปc sแปng, ฤรดi khi chรบng ta quรชn rแบฑng
            hแบกnh phรบc cรณ thแป ฤแบฟn tแปซ nhแปฏng ฤiแปu giแบฃn dแป nhแบฅt. Dแปฑ รกn Peace by
            Piece ra ฤแปi ฤแป gแปญi gแบฏm nhแปฏng lแปi yรชu thฦฐฦกng, ฤแปng viรชn vร hy vแปng โ
            nhฦฐ tแปซng chiแบฟc lรก nhแป mang trong mรฌnh thรดng ฤiแปp bรฌnh yรชn.
          </p>
          <p style="line-height: 1.6">
            Hรฃy ฤแป mแปi nแปฅ cฦฐแปi, mแปi lแปi chia sแบป trแป thรnh mแปt mแบฃnh ghรฉp gรณp phแบงn
            tแบกo nรชn bแปฉc tranh hแบกnh phรบc trแปn vแบนn. ๐
          </p>
        </div>
      </div>
    </div>

    <!-- Project Info Modal -->
    <div class="modal" id="projectInfoModal" role="dialog" aria-modal="true">
      <div class="sheet">
        <button
          class="x"
          id="closeProjectInfoModal"
          aria-label="ฤรณng thรดng tin dแปฑ รกn"
        >
          โ
        </button>
        <h3>๐ฟ Cรขy tinh thแบงn</h3>
        <div class="help-content">
          <p style="line-height: 1.6; margin-bottom: 16px">
            Trong guแปng quay tแบฅt bแบญt cแปงa cuแปc sแปng, ฤรดi khi chรบng ta quรชn rแบฑng
            hแบกnh phรบc cรณ thแป ฤแบฟn tแปซ nhแปฏng ฤiแปu giแบฃn dแป nhแบฅt. Dแปฑ รกn Peace by
            Piece ra ฤแปi ฤแป gแปญi gแบฏm nhแปฏng lแปi yรชu thฦฐฦกng, ฤแปng viรชn vร hy vแปng โ
            nhฦฐ tแปซng chiแบฟc lรก nhแป mang trong mรฌnh thรดng ฤiแปp bรฌnh yรชn.
          </p>
          <p style="line-height: 1.6">
            Hรฃy ฤแป mแปi nแปฅ cฦฐแปi, mแปi lแปi chia sแบป trแป thรnh mแปt mแบฃnh ghรฉp gรณp phแบงn
            tแบกo nรชn bแปฉc tranh hแบกnh phรบc trแปn vแบนn. ๐
          </p>
        </div>
      </div>
    </div>

    <!-- View Modal -->
    <div class="modal" id="modal" role="dialog" aria-modal="true">
      <div class="sheet">
        <button class="x" id="closeModal" aria-label="ฤรณng modal">โ</button>
        <h3>๐ Thรดng ฤiแปp</h3>
        <div class="leaf-card">
          <div class="leaf-preview">
            <img id="modalLeafImage" class="modal-leaf-image" src="" alt="Leaf preview" />
          </div>
          <div class="leaf-text">
            <p id="modalText"></p>
            <p id="modalAuthor"></p>
          </div>
        </div>
        <div class="leaf-actions">
          <div id="encourageSection" style="display: none; margin-bottom: 8px">
            <input
              id="encourageInput"
              type="text"
              placeholder="Gแปญi lแปi ฤแปng viรชn..."
              style="width: 65%; padding: 6px; margin-right: 8px"
            />
            <button
              id="dropLoveBtn"
              class="btn pink"
              style="vertical-align: middle"
            >
              ๐ Thแบฃ yรชu thฦฐฦกng
            </button>
          </div>

          <!-- List of encouragers - only visible to leaf owner -->
          <div id="encouragersList" style="display: none; margin-bottom: 8px;">
            <h4 style="margin:0 0 8px 0; font-size:13px">Nhแปฏng ngฦฐแปi ฤรฃ an แปงi</h4>
            <div id="encouragersItems" style="display:flex;flex-direction:column;gap:6px;max-height:200px;overflow:auto;padding-right:6px"></div>
          </div>

          <div
            id="ownerRecoverSection"
            style="display: none; margin-bottom: 8px"
          >
            <button
              id="ownerRecoverBtn"
              class="btn"
              style="background: #9ae6b4"
            >
              โ Tรดi แปn rแปi
            </button>
          </div>

          <button id="editLeaf" class="btn green">โ๏ธ Sแปญa</button>
          <button id="deleteLeaf" class="btn red" style="display: none">
            ๐๏ธ Xรณa
          </button>
        </div>
      </div>
    </div>

    <!-- Support Floating Button & Modal (HแบบM 202) -->
    <button id="supportFloatingBtn" aria-haspopup="dialog" aria-controls="supportModal" style="position:fixed;right:18px;bottom:20px;z-index:12000;background:#ffb703;color:#082032;border:none;padding:12px 14px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.18);font-weight:700;cursor:pointer;">Hแป trแปฃ</button>

    <div class="modal" id="supportModal" role="dialog" aria-modal="true" style="display:none">
      <div class="sheet" style="max-width:520px;">
        <button class="x" id="supportCloseBtn" aria-label="ฤรณng modal">โ</button>
        <h3>Chรo bแบกn ๐ผ</h3>
        <div id="supportContent" style="line-height:1.5;color:var(--text-secondary);">
          <p>
            Nแบฟu bแบกn vแบซn chฦฐa cแบฃm thแบฅy แปn, vร cรณ nhiแปu ฤiแปu chฦฐa thแป nรณi ra โ ฤแปซng chแปu ฤแปฑng mแปt mรฌnh nhรฉ.. Chรบng mรฌnh sแบฝ giรบp bแบกn kแบฟt nแปi trแปฑc tiแบฟp vแปi HแบบM 202 [ Bแป PHแบฌN Tฦฏ VแบคN TรM Lร TแบI TRฦฏแปNG ฤH FPT TP.HCM]. ฤรขy lร nฦกi bแบกn cรณ thแป thoแบฃi mรกi chia sแบป cแบฃm xรบc cรนng cรกn bแป tรขm lรฝ giรu kinh nghiแปm, luรดn sแบตn sรng lแบฏng nghe vร ฤแปng hรnh cรนng bแบกn.
            ฤแปซng ngแบงn ngแบกi mแป lรฒng nhรฉ โ nhแบฅn vรo nรบt bรชn dฦฐแปi ฤแป bแบฏt ฤแบงu ๐
          </p>
        </div>
        <div style="display:flex;gap:10px;margin-top:18px;">
          <button id="supportYesBtn" class="btn primary" style="flex:1">Cรณ, mรฌnh muแปn ฤฦฐแปฃc kแบฟt nแปi</button>
          <button id="supportNoBtn" class="btn secondary" style="flex:1">Mรฌnh แปn rแปi</button>
        </div>
        <div id="supportFollow" style="display:none;margin-top:16px;">
          <!-- follow-up content inserted by JS -->
        </div>
      </div>
    </div>

    <script src="src/firebase-init.js"></script>
    <script src="src/auth.js"></script>
    <script src="src/auth-guard.js"></script>
    <script src="src/script.js" defer></script>
    <script>
      // EARLY AUTH CHECK - Chแบกy NGAY ฤแป giแบฃm FOUC
      (function () {
        // Inline check ฤแป chแบกy nhanh nhแบฅt cรณ thแป
        const cachedAuthKey = Object.keys(localStorage).find((key) =>
          key.startsWith("firebase:authUser:")
        );

        if (cachedAuthKey) {
          try {
            const cachedUser = JSON.parse(localStorage.getItem(cachedAuthKey));
            if (cachedUser && cachedUser.email) {
              // Update UI ngay lแบญp tแปฉc
              const authLoading = document.getElementById("authLoading");
              const userSection = document.getElementById("userSection");
              const userDisplayName =
                document.getElementById("userDisplayName");

              if (authLoading) authLoading.style.display = "none";
              if (userSection) userSection.style.display = "block";
              if (userDisplayName) {
                userDisplayName.textContent =
                  cachedUser.displayName || cachedUser.email.split("@")[0];
              }
            }
          } catch (e) {
            // Ignore errors
          }
        }
      })();

      // Setup logout button, settings button and auth state management
      document.addEventListener("DOMContentLoaded", () => {
        const logoutBtn = document.getElementById("logoutBtn");
        const settingsBtn = document.getElementById("settingsBtn");

        if (logoutBtn) {
          logoutBtn.addEventListener("click", (e) => {
            e.preventDefault();
            const logoutModal = document.getElementById("logoutModal");
            if (logoutModal) {
              logoutModal.style.display = "grid";
              logoutModal.classList.add("show");
              document.body.style.overflow = "hidden";
            }
          });

          // Modal handlers
          const confirmLogout = document.getElementById("confirmLogout");
          const cancelLogout = document.getElementById("cancelLogout");
          const closeLogoutModal = document.getElementById("closeLogoutModal");
          const logoutModal = document.getElementById("logoutModal");

          const doSignOut = async () => {
            try {
              if (window.AuthHelpers) await window.AuthHelpers.signOut();
            } catch (err) {
              console.warn("Sign out failed:", err);
            } finally {
              // Always reload to reset UI
              window.location.reload();
            }
          };

          if (confirmLogout) confirmLogout.addEventListener("click", doSignOut);
          const closeLogout = () => {
            if (logoutModal) {
              logoutModal.classList.remove("show");
              setTimeout(() => (logoutModal.style.display = "none"), 220);
              document.body.style.overflow = "auto";
            }
          };
          if (cancelLogout) cancelLogout.addEventListener("click", closeLogout);
          if (closeLogoutModal)
            closeLogoutModal.addEventListener("click", closeLogout);
          if (logoutModal)
            logoutModal.addEventListener("click", (ev) => {
              if (ev.target === logoutModal) closeLogout();
            });
        }

        // Settings button - Chuyแปn ฤแบฟn trang profile
        if (settingsBtn) {
          settingsBtn.addEventListener("click", () => {
            navigateToPage("profile.html");
          });
        }
      });
    </script>
    <script>
      // Page transition function
      function navigateToPage(url) {
        document.body.classList.add("page-fade-out");
        setTimeout(() => {
          window.location.href = url;
        }, 250);
      }

      // Single DOMContentLoaded handler
      document.addEventListener("DOMContentLoaded", () => {
        // Add page transition on load
        const mainContent = document.getElementById("main-content");
        if (mainContent) {
          mainContent.classList.add("page-transition");
        }

        const dropdownMenu = document.getElementById("dropdownMenu");

        // Set up dropdown first so elements are accessible
        dropdownMenu.style.display = "block";
        dropdownMenu.style.visibility = "hidden";

        const themeToggle = document.getElementById("themeToggle");
        const helpModalBtn = document.getElementById("helpModalBtn");
        const termsModalBtn = document.getElementById("termsModalBtn");

        // Toggle dropdown menu - hamburger button
        const hamburger = document.getElementById("hamburger");
        if (hamburger) {
          hamburger.addEventListener("click", (e) => {
            e.stopPropagation();
            if (dropdownMenu.classList.contains("show")) {
              dropdownMenu.classList.remove("show");
            } else {
              dropdownMenu.style.visibility = "visible";
              dropdownMenu.classList.add("show");
            }
          });
        }

        // Close dropdown when clicking outside
        document.addEventListener("click", (e) => {
          if (
            !dropdownMenu.contains(e.target) &&
            !e.target.closest(".hamburger")
          ) {
            dropdownMenu.classList.remove("show");
          }
        });

        // Theme toggle functionality
        if (themeToggle) {
          const themeIcon = themeToggle.querySelector(".dropdown-icon");
          const themeText = themeToggle.querySelector(".dropdown-text");

          const updateThemeUI = () => {
            const isDark =
              document.documentElement.getAttribute("data-theme") === "dark";
            if (isDark) {
              if (themeIcon) themeIcon.textContent = "โ๏ธ";
              if (themeText) themeText.textContent = "Chแบฟ ฤแป sรกng";
            } else {
              if (themeIcon) themeIcon.textContent = "๐";
              if (themeText) themeText.textContent = "Chแบฟ ฤแป tแปi";
            }
          };

          // Set initial theme on page load
          const currentTheme = localStorage.getItem("theme");
          if (currentTheme === "dark") {
            document.documentElement.setAttribute("data-theme", "dark");
            document.documentElement.classList.add("theme-night");
            document.documentElement.classList.remove("theme-day");
          } else {
            document.documentElement.removeAttribute("data-theme");
            document.documentElement.classList.add("theme-day");
            document.documentElement.classList.remove("theme-night");
          }
          updateThemeUI();

          themeToggle.addEventListener("click", () => {
            const isDark =
              document.documentElement.getAttribute("data-theme") === "dark";
            if (isDark) {
              document.documentElement.removeAttribute("data-theme");
              document.documentElement.classList.remove("theme-night");
              document.documentElement.classList.add("theme-day");
              localStorage.setItem("theme", "light");
            } else {
              document.documentElement.setAttribute("data-theme", "dark");
              document.documentElement.classList.remove("theme-day");
              document.documentElement.classList.add("theme-night");
              localStorage.setItem("theme", "dark");
            }

            window.dispatchEvent(
              new CustomEvent("theme-change", {
                detail: { theme: isDark ? "light" : "dark" },
              })
            );

            updateThemeUI();
            dropdownMenu.classList.remove("show");
          });
        }

        // Help modal
        if (helpModalBtn) {
          helpModalBtn.addEventListener("click", () => {
            dropdownMenu.classList.remove("show");
            const helpModal = document.getElementById("helpModal");
            if (helpModal) {
              helpModal.style.display = "flex";
              helpModal.classList.add("show");
              document.body.style.overflow = "hidden";
            }
          });
        }

        // Terms modal
        if (termsModalBtn) {
          termsModalBtn.addEventListener("click", () => {
            dropdownMenu.classList.remove("show");
            const termsModal = document.getElementById("termsModal");
            if (termsModal) {
              termsModal.style.display = "flex";
              termsModal.classList.add("show");
              document.body.style.overflow = "hidden";
            }
          });
        }

        // Modal close handlers
        const closeHelp = document.getElementById("closeHelpModal");
        const closeTerms = document.getElementById("closeTermsModal");
        const closeProject = document.getElementById("closeProjectInfoModal");
        const helpModal = document.getElementById("helpModal");
        const termsModal = document.getElementById("termsModal");
        const projectModal = document.getElementById("projectInfoModal");

        if (closeHelp && helpModal) {
          closeHelp.addEventListener("click", () => {
            helpModal.style.display = "none";
            helpModal.classList.remove("show");
            document.body.style.overflow = "auto";
          });
        }

        if (closeTerms && termsModal) {
          closeTerms.addEventListener("click", () => {
            termsModal.style.display = "none";
            termsModal.classList.remove("show");
            document.body.style.overflow = "auto";
          });
        }

        if (closeProject && projectModal) {
          closeProject.addEventListener("click", () => {
            projectModal.style.display = "none";
            projectModal.classList.remove("show");
            document.body.style.overflow = "auto";
          });
        }

        // Close modals when clicking outside
        [helpModal, termsModal, projectModal].forEach((modal) => {
          if (modal) {
            modal.addEventListener("click", (e) => {
              if (e.target === modal) {
                modal.style.display = "none";
                modal.classList.remove("show");
                document.body.style.overflow = "auto";
              }
            });
          }
        });

          // Support floating button (HแบบM 202) handlers
          (function setupSupportFlow(){
            const supportBtn = document.getElementById('supportFloatingBtn');
            const supportModal = document.getElementById('supportModal');
            const supportClose = document.getElementById('supportCloseBtn');
            const supportYes = document.getElementById('supportYesBtn');
            const supportNo = document.getElementById('supportNoBtn');
            const supportFollow = document.getElementById('supportFollow');

            function openSupportModal(){
              if (!supportModal) return;
              supportModal.style.display = 'flex';
              supportModal.classList.add('show');
              document.body.style.overflow = 'hidden';
              // reset follow area
              if (supportFollow) supportFollow.style.display = 'none';
            }

            function closeSupportModal(){
              if (!supportModal) return;
              supportModal.classList.remove('show');
              setTimeout(()=> supportModal.style.display = 'none', 220);
              document.body.style.overflow = 'auto';
            }

            if (supportBtn) supportBtn.addEventListener('click', openSupportModal);
            if (supportClose) supportClose.addEventListener('click', closeSupportModal);

            if (supportYes) supportYes.addEventListener('click', (e)=>{
              // show follow-up message with link
              if (supportFollow) {
                supportFollow.innerHTML = `
                  <h4>Cแบฃm ฦกn bแบกn vรฌ ฤรฃ mแป lรฒng ๐</h4>
                  <p>Dรน bแบกn ฤang trแบฃi qua ฤiแปu gรฌ, chรบng mรฌnh luรดn แป ฤรขy giรบp bแบกn ฤฦฐแปฃc lแบฏng nghe vร ฤแปng hรnh cรนng bแบกn. Bแบกn cรณ thแป bแบฏt ฤแบงu cuแปc trรฒ chuyแปn trแปฑc tiแบฟp vแปi cรกn bแป tฦฐ vแบฅn tรขm lรฝ tแบกi Hแบปm 202 nhรฉ ๐ <a href="https://www.facebook.com/phongtvtlfpthcm" target="_blank" rel="noopener">Link kแบฟt nแปi vแปi Hแบปm</a></p>
                  <p><strong>Hแบปm 202</strong> hoแบกt ฤแปng dฦฐแปi nguyรชn tแบฏc "Thแบฅu hiแปu, tรดn trแปng vร bแบฃo mแบญt". Mแปi cรขu chuyแปn cแปงa bแบกn lร cแปงa bแบกn, chรบng mรฌnh khรดng cรณ quyแปn phรกn xรฉt vร bรฌnh luแบญn.</p>
                  <div style="margin-top:12px;display:flex;gap:8px;"><button class="btn primary" id="supportOpenLink">Mแป liรชn kแบฟt</button><button class="btn secondary" id="supportClose2">ฤรณng</button></div>
                `;
                supportFollow.style.display = 'block';

                // wire the newly created buttons
                const openLinkBtn = document.getElementById('supportOpenLink');
                const close2 = document.getElementById('supportClose2');
                if (openLinkBtn) openLinkBtn.addEventListener('click', ()=> window.open('https://www.facebook.com/phongtvtlfpthcm','_blank'));
                if (close2) close2.addEventListener('click', closeSupportModal);
              }
            });

            if (supportNo) supportNo.addEventListener('click', ()=>{
              if (supportFollow) {
                supportFollow.innerHTML = `<p>Chรบng mรฌnh rแบฅt vui khi biแบฟt bแบกn ฤang cแบฃm thแบฅy แปn hฦกn๐ป. Nแบฟu mแปt lรบc nรo ฤรณ bแบกn cรณ nhแปฏng trฤn trแป hay phiแปn lรฒng, ฤแปซng ngแบงn ngแบกi tรฌm ฤแบฟn chรบng mรฌnh nhรฉ! Chรบng mรฌnh sแบฝ giรบp bแบกn kแบฟt nแปi vแปi cรกn bแป tฦฐ vแบฅn tรขm lรฝ, nฦกi bแบกn luรดn ฤฦฐแปฃc lแบฏng nghe vร ฤแปng hรnh cรนng bแบกn. Chรบng mรฌnh luรดn แป ฤรขy vร sแบตn sรng hแป trแปฃ bแบฅt cแปฉ khi nรo bแบกn cแบงn ๐</p><div style="margin-top:12px;display:flex;gap:8px;"><button class="btn secondary" id="supportClose3">ฤรณng</button></div>`;
                supportFollow.style.display = 'block';
                const close3 = document.getElementById('supportClose3');
                if (close3) close3.addEventListener('click', closeSupportModal);
              }
            });
          })();
      });
    </script>
  </body>
</html>
