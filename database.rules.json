{
  "rules": {
    "users": {
      ".read": "auth !== null && root.child('users').child(auth.uid).child('role').val() === 'admin'",
      ".indexOn": ["role", "createdAt"],
      "$uid": {
        ".read": "$uid === auth.uid",
        ".write": "$uid === auth.uid || root.child('users').child(auth.uid).child('role').val() === 'admin'",
        ".validate": "newData.hasChildren(['email', 'displayName', 'role', 'createdAt'])",
        "uid": {
          ".validate": "newData.val() === $uid"
        },
        "email": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 100"
        },
        "displayName": {
          ".validate": "newData.isString() && newData.val().length <= 50"
        },
        "photoURL": {
          ".validate": "newData.isString() || newData.val() === null"
        },
        "role": {
          ".write": "root.child('users').child(auth.uid).child('role').val() === 'admin'",
          ".validate": "newData.val() === 'user' || newData.val() === 'admin' || newData.val() === 'counselor'"
        },
        "createdAt": {
          ".validate": "newData.isNumber()"
        },
        "lastActive": {
          ".validate": "newData.isNumber()"
        },
        "isOnline": {
          ".validate": "newData.isBoolean()"
        }
      }
    },

    "leaves": {
      ".read": true,
      ".indexOn": ["authorId", "ts"],
      "$leafId": {
        ".write": "auth !== null && ( (!data.exists() && newData.hasChildren(['id', 'text', 'author', 'ts', 'position', 'shapeKey', 'paletteIdx', 'scale', 'rotation']) && newData.child('authorId').val() === auth.uid) || (data.exists() && (data.child('authorId').val() === auth.uid || root.child('users').child(auth.uid).child('role').val() === 'admin')) )",
        ".validate": "newData.hasChildren(['id', 'text', 'author', 'ts', 'position', 'shapeKey', 'paletteIdx', 'scale', 'rotation'])",
        "id": {
          ".validate": "newData.isString() && newData.val().length > 0"
        },
        "text": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 500"
        },
        "author": {
          ".validate": "newData.isString() && newData.val().length <= 50"
        },
        "authorId": {
          ".validate": "newData.val() === auth.uid"
        },
        "ts": {
          ".validate": "newData.isNumber() && newData.val() <= now"
        },
        "position": {
          ".validate": "newData.hasChildren(['x', 'y']) && newData.child('x').isNumber() && newData.child('y').isNumber()"
        },
        "shapeKey": {
          ".validate": "newData.isString()"
        },
        "paletteIdx": {
          ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 10"
        },
        "scale": {
          ".validate": "newData.isNumber() && newData.val() >= 0.1 && newData.val() <= 3"
        },
        "rotation": {
          ".validate": "newData.isNumber() && newData.val() >= -360 && newData.val() <= 360"
        }
      }
    },

    

    "statistics": {
      ".read": "auth !== null",
      ".write": "root.child('users').child(auth.uid).child('role').val() === 'admin'"
    },

    "logs": {
      ".read": "root.child('users').child(auth.uid).child('role').val() === 'admin'",
      ".write": "root.child('users').child(auth.uid).child('role').val() === 'admin'"
    },

    "analytics": {
      "visits": {
        ".read": "auth !== null && root.child('users').child(auth.uid).child('role').val() === 'admin'",
        "$visitKey": {
          ".write": "auth !== null && newData.child('uid').val() === auth.uid",
          ".validate": "newData.hasChildren(['uid', 'timestamp', 'date'])",
          "uid": {
            ".validate": "newData.val() === auth.uid"
          },
          "timestamp": {
            ".validate": "newData.isNumber()"
          },
          "date": {
            ".validate": "newData.isString()"
          }
        }
      }
    },

    "$other": {
      ".read": false,
      ".write": false
    }

    ,
    "encouragements": {
      ".read": true,
      "$leafId": {
        "$encId": {
          ".write": "(!data.exists() && newData.hasChildren(['id','text','author','ts','position']) && (auth !== null ? newData.child('authorId').val() === auth.uid : newData.child('authorId').val() === null)) || (data.exists() && root.child('users').child(auth.uid).child('role').val() === 'admin')",
          ".validate": "newData.hasChildren(['id','text','author','ts','position'])",
          "id": {
            ".validate": "newData.isString() && newData.val().length > 0"
          },
          "text": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 500"
          },
          "author": {
            ".validate": "newData.isString() && newData.val().length <= 50"
          },
          "authorId": {
            ".validate": "newData.val() === null || newData.val() === auth.uid"
          },
          "ts": {
            ".validate": "newData.isNumber() && newData.val() <= now"
          },
          "position": {
            ".validate": "newData.hasChildren(['x','y']) && newData.child('x').isNumber() && newData.child('y').isNumber()"
          }
        }
      }
    }
  }
}