<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Quản trị - Cây Tinh Thần</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/main.css">
  <link rel="stylesheet" href="assets/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* Spinner */
    .ctt-spinner {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 4px solid rgba(0,0,0,0.08);
      border-top-color: #3b82f6;
      animation: ctt-spin 1s linear infinite;
    }

    @keyframes ctt-spin {
      to { transform: rotate(360deg); }
    }

    .admin-container {
      min-height: 100vh;
      background: #f8fafc;
      display: flex;
      flex-direction: column;
    }
    
    .admin-header {
      background: white;
      border-bottom: 1px solid #e2e8f0;
      padding: 20px 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .admin-header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .admin-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .admin-logo h1 {
      font-size: 24px;
      font-weight: 800;
      margin: 0;
      background: linear-gradient(135deg, #10b981, #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .admin-nav {
      display: flex;
      gap: 24px;
      align-items: center;
    }
    
    .admin-nav a {
      text-decoration: none;
      color: #64748b;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .admin-nav a:hover,
    .admin-nav a.active {
      background: #f1f5f9;
      color: #334155;
    }
    
    .user-menu {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981, #3b82f6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }
    
    .logout-btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .logout-btn:hover {
      background: #2563eb;
    }
    
    .admin-content {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 24px;
      width: 100%;
      box-sizing: border-box;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }
    
    .stat-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
    }
    
    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .stat-title {
      font-size: 14px;
      font-weight: 500;
      color: #64748b;
      margin: 0;
    }
    
    .stat-icon {
      font-size: 20px;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 800;
      color: #0f172a;
      margin: 0;
    }
    
    .stat-change {
      font-size: 14px;
      color: #10b981;
      margin-top: 8px;
    }
    
    .admin-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
    }
    
    .admin-section {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
    }
    
    .admin-section.full-width {
      grid-column: 1 / -1;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 16px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #0f172a;
      margin: 0;
    }
    
    .section-count {
      font-size: 14px;
      color: #64748b;
      font-weight: 500;
    }
    
    .section-action {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .section-action:hover {
      background: #2563eb;
    }
    
    /* View mode buttons */
    .view-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .view-mode-btn {
      background: #f1f5f9;
      color: #64748b;
      border: 1px solid #e2e8f0;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .view-mode-btn:hover {
      background: #e2e8f0;
      border-color: #cbd5e1;
    }
    
    .view-mode-btn.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .refresh-btn {
      background: #10b981;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .refresh-btn:hover {
      background: #059669;
    }
    
    .user-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .user-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      transition: all 0.2s ease;
    }
    
    .user-item:hover {
      border-color: #cbd5e1;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981, #3b82f6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 16px;
      flex-shrink: 0;
    }
    
    .user-info {
      flex: 1;
      min-width: 0;
    }
    
    .user-name {
      font-weight: 600;
      color: #0f172a;
      font-size: 14px;
      margin: 0 0 4px 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .user-role {
      font-size: 12px;
      color: #64748b;
      margin: 0 0 2px 0;
    }
    
    .user-status {
      font-size: 11px;
      color: #64748b;
    }
    
    .user-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .btn-edit, .btn-delete {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-edit {
      background: #3b82f6;
      color: white;
    }
    
    .btn-edit:hover {
      background: #2563eb;
    }
    
    .btn-delete {
      background: #ef4444;
      color: white;
    }
    
    .btn-delete:hover {
      background: #dc2626;
    }
    
    /* Leaf items */
    .leaf-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 500px;
      overflow-y: auto;
    }
    
    .leaf-item {
      display: flex;
      align-items: start;
      gap: 12px;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      transition: all 0.2s ease;
      background: white;
    }
    
    .leaf-item:hover {
      border-color: #cbd5e1;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .leaf-icon {
      font-size: 32px;
      flex-shrink: 0;
    }
    
    .leaf-content {
      flex: 1;
      min-width: 0;
    }
    
    .leaf-text {
      font-size: 14px;
      color: #334155;
      margin: 0 0 8px 0;
      line-height: 1.5;
      word-wrap: break-word;
    }
    
    .leaf-meta {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    
    .leaf-author {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #64748b;
    }
    
    .leaf-author-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981, #3b82f6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 11px;
    }
    
    .leaf-time {
      font-size: 12px;
      color: #94a3b8;
    }
    
    .leaf-stats {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: #64748b;
    }
    
    /* Grid view for leaves */
    .leaf-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      max-height: 500px;
      overflow-y: auto;
    }
    
    .leaf-card {
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      background: white;
      transition: all 0.2s ease;
    }
    
    .leaf-card:hover {
      border-color: #cbd5e1;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transform: translateY(-2px);
    }
    
    .leaf-card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }
    
    .leaf-card-text {
      font-size: 14px;
      color: #334155;
      line-height: 1.5;
      margin-bottom: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 20px;
    }
    
    .user-item-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981, #3b82f6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 12px;
    }
    
    .user-item-info {
      flex: 1;
    }
    
    .user-item-name {
      font-weight: 600;
      color: #0f172a;
      font-size: 14px;
      margin: 0 0 4px 0;
    }
    
    .user-item-role {
      font-size: 12px;
      color: #64748b;
      margin: 0;
    }
    
    .user-item-actions {
      display: flex;
      gap: 8px;
    }
    
    .user-action-btn {
      background: #f1f5f9;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .user-action-btn:hover {
      background: #e2e8f0;
    }
    
    .chat-queue {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .chat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
    }
    
    .chat-info {
      flex: 1;
    }
    
    .chat-user {
      font-weight: 600;
      color: #0f172a;
      font-size: 14px;
      margin: 0 0 4px 0;
    }
    
    .chat-time {
      font-size: 12px;
      color: #64748b;
      margin: 0;
    }
    
    .chat-actions {
      display: flex;
      gap: 8px;
    }
    
    .chat-btn {
      background: #10b981;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .chat-btn:hover {
      background: #059669;
    }
    
    .chat-btn.decline {
      background: #ef4444;
    }
    
    .chat-btn.decline:hover {
      background: #dc2626;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      display: block;
    }
    
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    /* Smooth scroll */
    html {
      scroll-behavior: smooth;
      scroll-padding-top: 100px;
    }
    
    /* Dark mode */
    body.dark-mode,
    [data-theme="dark"] body {
      background: #0f172a;
    }
    
    body.dark-mode .admin-container,
    [data-theme="dark"] .admin-container {
      background: #0f172a;
    }
    
    body.dark-mode .admin-header,
    [data-theme="dark"] .admin-header {
      background: #1e293b;
      border-bottom-color: #334155;
    }
    
    body.dark-mode .admin-nav a,
    [data-theme="dark"] .admin-nav a {
      color: #cbd5e1;
    }
    
    body.dark-mode .admin-nav a:hover,
    body.dark-mode .admin-nav a.active,
    [data-theme="dark"] .admin-nav a:hover,
    [data-theme="dark"] .admin-nav a.active {
      background: #334155;
      color: #f1f5f9;
    }
    
    body.dark-mode .stat-card,
    body.dark-mode .admin-section,
    [data-theme="dark"] .stat-card,
    [data-theme="dark"] .admin-section {
      background: #1e293b;
      border-color: #334155;
    }
    
    body.dark-mode .stat-title,
    body.dark-mode .section-count,
    [data-theme="dark"] .stat-title,
    [data-theme="dark"] .section-count {
      color: #94a3b8;
    }
    
    body.dark-mode .stat-value,
    body.dark-mode .section-title,
    body.dark-mode .user-name,
    body.dark-mode .user-item-name,
    body.dark-mode .leaf-text,
    body.dark-mode .leaf-card-text,
    [data-theme="dark"] .stat-value,
    [data-theme="dark"] .section-title,
    [data-theme="dark"] .user-name,
    [data-theme="dark"] .user-item-name,
    [data-theme="dark"] .leaf-text,
    [data-theme="dark"] .leaf-card-text {
      color: #f1f5f9;
    }
    
    body.dark-mode .user-item,
    body.dark-mode .leaf-item,
    body.dark-mode .leaf-card,
    [data-theme="dark"] .user-item,
    [data-theme="dark"] .leaf-item,
    [data-theme="dark"] .leaf-card {
      background: #1e293b;
      border-color: #334155;
    }
    
    body.dark-mode .user-item:hover,
    body.dark-mode .leaf-item:hover,
    body.dark-mode .leaf-card:hover,
    [data-theme="dark"] .user-item:hover,
    [data-theme="dark"] .leaf-item:hover,
    [data-theme="dark"] .leaf-card:hover {
      border-color: #475569;
    }
    
    body.dark-mode .user-role,
    body.dark-mode .user-status,
    body.dark-mode .user-item-role,
    body.dark-mode .leaf-author,
    body.dark-mode .leaf-time,
    [data-theme="dark"] .user-role,
    [data-theme="dark"] .user-status,
    [data-theme="dark"] .user-item-role,
    [data-theme="dark"] .leaf-author,
    [data-theme="dark"] .leaf-time {
      color: #64748b;
    }
    
    body.dark-mode .empty-state,
    [data-theme="dark"] .empty-state {
      color: #64748b;
    }
    
    body.dark-mode .view-mode-btn,
    [data-theme="dark"] .view-mode-btn {
      background: #334155;
      color: #cbd5e1;
      border-color: #475569;
    }
    
    body.dark-mode .view-mode-btn:hover,
    [data-theme="dark"] .view-mode-btn:hover {
      background: #475569;
    }
    
    body.dark-mode .view-mode-btn.active,
    [data-theme="dark"] .view-mode-btn.active {
      background: #3b82f6;
      color: white;
    }
    
    @media (max-width: 768px) {
      .admin-header-content {
        padding: 0 16px;
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
      }
      
      .admin-nav {
        justify-content: center;
      }
      
      .admin-content {
        padding: 20px 16px;
      }
      
      .admin-grid {
        grid-template-columns: 1fr;
        gap: 24px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <header class="admin-header">
      <div class="admin-header-content">
        <div class="admin-logo">
          <span>🌿</span>
          <h1>Quản trị Cây Tinh Thần</h1>
        </div>
        
        <nav class="admin-nav">
          <a href="#dashboard" class="nav-link active" data-section="dashboard">Dashboard</a>
          <a href="#analytics" class="nav-link" data-section="analytics">Thống kê</a>
          <a href="#users" class="nav-link" data-section="users">Người dùng</a>
          <a href="#leaves" class="nav-link" data-section="leaves">Lá cây</a>
        </nav>
        
        <div class="user-menu">
          <div class="user-avatar" id="userAvatar">...</div>
          <span id="userName">Đang tải...</span>
          <button class="logout-btn" id="homeBtnHeader">Trang chủ</button>
        </div>
      </div>
    </header>
    
    <main class="admin-content">
      <!-- Loading overlay -->
      <div id="adminLoadingOverlay" style="position:fixed;inset:0;z-index:9998;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,0.6);backdrop-filter:blur(4px);">
        <div style="background:rgba(255,255,255,0.96);padding:22px 28px;border-radius:12px;display:flex;flex-direction:column;align-items:center;gap:12px;min-width:260px;">
          <div style="font-size:28px;">⏳</div>
          <div style="font-weight:700;">Đang tải dữ liệu quản trị</div>
          <div style="font-size:13px;color:#475569;">Vui lòng đợi — bảng điều khiển đang khởi tạo</div>
        </div>
      </div>
      <!-- Dashboard Stats -->
      <div id="dashboard" class="stats-grid">
        <div class="stat-card">
          <div class="stat-header">
            <h3 class="stat-title">Tổng số lá</h3>
            <span class="stat-icon">🌿</span>
          </div>
          <p class="stat-value" id="totalLeaves">0</p>
        </div>
        
        <div class="stat-card">
          <div class="stat-header">
            <h3 class="stat-title">Người dùng hoạt động</h3>
            <span class="stat-icon">👥</span>
          </div>
          <p class="stat-value" id="activeUsers">0</p>
        </div>
        
        <div class="stat-card">
          <div class="stat-header">
            <h3 class="stat-title">Lá cần an ủi</h3>
            <span class="stat-icon">🍂</span>
          </div>
          <p class="stat-value" id="witheredLeaves">0</p>
          <p class="stat-change">Cần được chú ý</p>
        </div>
      </div>
      
      <div class="admin-grid">
        <!-- User Traffic Analytics -->
        <div id="analytics" class="admin-section full-width">
          <div class="section-header">
            <h2 class="section-title">📊 Thống kê truy cập người dùng</h2>
            <div class="view-controls">
              <button id="analyticsRefreshBtn" class="refresh-btn">
                <span>🔄</span>
                <span>Làm mới</span>
              </button>
              <span class="section-count" id="totalVisitsCount">0 lượt truy cập</span>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="trafficChart"></canvas>
          </div>
        </div>
        
        <!-- User List -->
        <div id="users" class="admin-section full-width">
          <div class="section-header">
            <h2 class="section-title">👥 Danh sách người dùng</h2>
            <div class="view-controls">
              <button id="usersRefreshBtn" class="refresh-btn">
                <span>🔄</span>
                <span>Làm mới</span>
              </button>
              <span class="section-count" id="totalUsersCount">0 người dùng</span>
            </div>
          </div>
          <div class="user-list" id="userList">
            <div class="empty-state">
              <span class="empty-state-icon">👥</span>
              <p>Đang tải...</p>
            </div>
          </div>
        </div>
        
        <!-- Leaves List -->
        <div id="leaves" class="admin-section full-width">
          <div class="section-header">
            <h2 class="section-title">🍃 Danh sách lá cây</h2>
            <div class="view-controls">
              <button class="view-mode-btn active" id="listViewBtn">
                <span>📋</span>
                <span>Danh sách</span>
              </button>
              <button class="view-mode-btn" onclick="switchLeafView('grid')" id="gridViewBtn">
                <span>🎯</span>
                <span>Lưới</span>
              </button>
              <button id="leavesRefreshBtn" class="refresh-btn">
                <span>🔄</span>
                <span>Làm mới</span>
              </button>
              <span class="section-count" id="totalLeavesCount">0 lá cây</span>
            </div>
          </div>
          <div class="leaf-list" id="leafList">
            <div class="empty-state">
              <span class="empty-state-icon">🍃</span>
              <p>Đang tải...</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="src/firebase-init.js"></script>
  <script src="src/auth.js"></script>
  <script src="src/auth-guard.js"></script>
  
  <script>
    // ===== DARK MODE SYNC =====
    
    // Apply dark mode on load
    (function() {
      const theme = localStorage.getItem('theme');
      if (theme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.body.classList.add('dark-mode');
      }
      
      // Listen for theme changes from other pages
      window.addEventListener('storage', (e) => {
        if (e.key === 'theme') {
          if (e.newValue === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.body.classList.add('dark-mode');
          } else {
            document.documentElement.removeAttribute('data-theme');
            document.body.classList.remove('dark-mode');
          }
        }
      });
    })();
    
    // ===== CHỈ LOAD DATA - AUTH-GUARD.JS ĐÃ HANDLE TẤT CẢ AUTH =====
    
    // Load dashboard stats
    function loadDashboard() {
  console.debug('📊 Loading dashboard stats...');
      
      if (!window._firebase) {
        console.error('❌ Firebase not initialized');
        return;
      }
      
      // Load total leaves & withered leaves
      const leavesPromise = window._firebase.ref('leaves').once('value')
        .then((snapshot) => {
          const leaves = snapshot.val() || {};
          const totalLeaves = Object.keys(leaves).length;
          document.getElementById('totalLeaves').textContent = totalLeaves;
          // Đếm số lá bị héo
          let witheredCount = 0;
          Object.values(leaves).forEach(l => {
            if (l && (l.isWithered === true || l.isWithered === '1')) witheredCount++;
          });
          document.getElementById('witheredLeaves').textContent = witheredCount;
          console.debug(`🌿 Total leaves: ${totalLeaves}, 🍂 Withered: ${witheredCount}`);
        })
        .catch(err => {
          document.getElementById('witheredLeaves').textContent = '0';
          console.error('Error loading leaves:', err);
        });

      const usersPromise = window._firebase.ref('users').once('value')
        .then((snapshot) => {
          console.debug('📊 Users snapshot received:', snapshot.val());
          const users = snapshot.val() || {};
          const allUsers = Object.values(users);
          
          console.debug(`📊 Total users found: ${allUsers.length}`);
          
          // Count active users (online or active in last 24h)
          const now = Date.now();
          const activeUsers = allUsers.filter(u => 
            u.isOnline || (u.lastActive && (now - u.lastActive) < 24 * 60 * 60 * 1000)
          ).length;
          
          document.getElementById('activeUsers').textContent = activeUsers;
          console.debug(`👥 Active users: ${activeUsers} / ${allUsers.length}`);
          
          // Load ALL users list (sorted by newest first)
          const sortedUsers = allUsers
            .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
          
          console.debug('📊 Calling loadUsersList with sorted users...');
          loadUsersList(sortedUsers);
        })
        .catch(err => console.error('Error loading users:', err));

      // Return a promise that resolves when both reads finish
      return Promise.allSettled([leavesPromise, usersPromise]);
      
      // Load withered leaves (TODO: implement logic)
      document.getElementById('witheredLeaves').textContent = '0';
    }
    
    // Load users list
    function loadUsersList(users) {
  console.debug('📋 loadUsersList called with:', users);
      const userList = document.getElementById('userList');
      const totalUsersCount = document.getElementById('totalUsersCount');
      
  console.debug('userList element:', userList);
  console.debug('totalUsersCount element:', totalUsersCount);
      
      if (!users || users.length === 0) {
        console.warn('⚠️ No users to display');
        userList.innerHTML = `
          <div class="empty-state">
            <span class="empty-state-icon">👥</span>
            <p>Không có người dùng nào</p>
          </div>
        `;
        if (totalUsersCount) totalUsersCount.textContent = '0 người dùng';
        return;
      }
      
  console.debug(`✅ Rendering ${users.length} users...`);
      
      // Update count
      if (totalUsersCount) {
        totalUsersCount.textContent = `${users.length} người dùng`;
      }
      
  userList.innerHTML = users.map(user => {
        // Determine online status: online in last 5 minutes
        const now = Date.now();
        const isRecentlyActive = user.lastActive && (now - user.lastActive) < 5 * 60 * 1000; // 5 minutes
        const statusText = isRecentlyActive ? '🟢 Online' : '⚫ Offline';
        
        return `
        <div class="user-item" data-uid="${user.uid}">
          <div class="user-avatar">${(user.displayName || user.email || 'U').charAt(0).toUpperCase()}</div>
          <div class="user-info">
            <div class="user-name">${user.displayName || user.email || 'Unknown'}</div>
            <div class="user-role">Role: ${user.role || 'user'}</div>
            <div class="user-status">${statusText}</div>
          </div>
          <div class="user-actions">
            <button class="btn-edit" data-action="edit" data-uid="${user.uid}">✏️ Sửa</button>
            <!-- Delete button removed per admin policy -->
          </div>
        </div>
      `;
      }).join('');

      // attach event listeners to edit/delete buttons (no inline onclicks)
      try {
        userList.querySelectorAll('.btn-edit').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const uid = btn.dataset.uid;
            if (uid) editUser(uid);
          });
        });
      } catch(e) { console.warn('Failed to attach user action listeners', e); }
      
  console.debug(`📋 ✅ Successfully loaded ${users.length} users in list`);
    }
    
    // Load all sections
    function loadUsers() {
  console.debug('📋 Loading all users...');
      const userList = document.getElementById('userList');
      const refreshBtn = document.getElementById('usersRefreshBtn');

      // Show per-section loader and disable button
      if (refreshBtn) refreshBtn.disabled = true;
      const prev = userList.innerHTML;
      userList.innerHTML = `<div class="empty-state"><div class="ctt-spinner"></div><p>Đang tải người dùng...</p></div>`;

      return window._firebase.ref('users').once('value')
        .then((snapshot) => {
          const users = snapshot.val() || {};
          const allUsers = Object.values(users);
          loadUsersList(allUsers);
        })
        .catch(err => {
          console.error('Error loading users:', err);
          userList.innerHTML = `<div class="empty-state"><span class="empty-state-icon">❌</span><p>Không thể tải người dùng</p></div>`;
        })
        .finally(() => {
          if (refreshBtn) refreshBtn.disabled = false;
        });
    }
    
    // Wait for Firebase ready to load data
    window.addEventListener('firebase-ready', () => {
  console.debug('🔥 Firebase ready, loading dashboard data...');
      
      // Update header with current user - with retry
      function updateHeaderUser() {
        const userNameEl = document.getElementById('userName');
        const userAvatarEl = document.getElementById('userAvatar');
        
        if (window._firebase && window._firebase.auth) {
          const currentUser = window._firebase.auth.currentUser;
          if (currentUser) {
            if (userNameEl) {
              const displayName = currentUser.displayName || currentUser.email;
              userNameEl.textContent = displayName;
            }
            if (userAvatarEl) {
              const initial = (currentUser.displayName || currentUser.email).charAt(0).toUpperCase();
              userAvatarEl.textContent = initial;
            }
            console.debug('✅ Header updated with user:', currentUser.email);
            return true;
          } else {
            console.warn('⚠️ No current user yet, will retry...');
            return false;
          }
        }
        return false;
      }
      
      // Try to update immediately
      if (!updateHeaderUser()) {
        // If failed, retry after 500ms
        setTimeout(() => {
          if (!updateHeaderUser()) {
            // If still failed, wait for auth state change
            console.warn('⚠️ Waiting for auth state change...');
          }
        }, 500);
      }
      
      // Also listen for auth state changes
      if (window._firebase && window._firebase.auth) {
        window._firebase.onAuthStateChanged((user) => {
          if (user) {
            console.debug('🔔 Auth state changed in admin, updating header...');
            updateHeaderUser();
          }
        });
      }
      
      // Show admin loading overlay while core data loads
      showAdminLoading();

      // Wrap each loader in a promise so we can await them collectively
      const dashboardPromise = new Promise((resolve) => {
        try {
          const r = loadDashboard();
          // If loadDashboard returns a promise, use it; otherwise resolve after next tick
          if (r && typeof r.then === 'function') r.then(resolve).catch(resolve);
          else setTimeout(resolve, 50);
        } catch (e) { console.warn('loadDashboard failed sync', e); resolve(); }
      });

      const analyticsPromise = new Promise((resolve) => {
        try {
          const r = loadTrafficAnalytics();
          if (r && typeof r.then === 'function') r.then(resolve).catch(resolve);
          else setTimeout(resolve, 50);
        } catch (e) { console.warn('loadTrafficAnalytics failed sync', e); resolve(); }
      });

      const leavesPromise = new Promise((resolve) => {
        try {
          const r = loadLeavesList();
          if (r && typeof r.then === 'function') r.then(resolve).catch(resolve);
          else setTimeout(resolve, 50);
        } catch (e) { console.warn('loadLeavesList failed sync', e); resolve(); }
      });

      // Timeout fallback (10s)
      const timeout = new Promise((resolve) => setTimeout(() => resolve('timeout'), 10000));

      Promise.race([Promise.allSettled([dashboardPromise, analyticsPromise, leavesPromise]), timeout])
        .then(() => {
          // Hide overlay regardless of success or timeout — UI should be responsive
          hideAdminLoading();
        })
        .catch(() => {
          hideAdminLoading();
        });
      
      // Home button handler (legacy fallback)
      const homeBtnHeader = document.getElementById('homeBtnHeader');
      if (homeBtnHeader) {
        homeBtnHeader.addEventListener('click', () => {
          window.location.href = 'index.html';
        });
      }

      // Attach handlers for admin controls that previously used inline onclick
      try {
        const analyticsRefresh = document.getElementById('analyticsRefreshBtn');
        if (analyticsRefresh) analyticsRefresh.addEventListener('click', loadTrafficAnalytics);
      } catch(e){}

      try {
        const usersRefresh = document.getElementById('usersRefreshBtn');
        if (usersRefresh) usersRefresh.addEventListener('click', loadUsers);
      } catch(e){}

      try {
        const listViewBtn = document.getElementById('listViewBtn');
        const gridViewBtn = document.getElementById('gridViewBtn');
        if (listViewBtn) listViewBtn.addEventListener('click', () => switchLeafView('list'));
        if (gridViewBtn) gridViewBtn.addEventListener('click', () => switchLeafView('grid'));
      } catch(e){}

      try {
        const leafRefresh = document.getElementById('leavesRefreshBtn');
        if (leafRefresh) leafRefresh.addEventListener('click', loadLeavesList);
      } catch(e){}
    });
    
    // ===== CRUD FUNCTIONS =====
    
    function editUser(uid) {
  console.debug('Editing user:', uid);
      
      window._firebase.ref(`users/${uid}`).once('value')
        .then((snapshot) => {
          const user = snapshot.val();
          if (!user) {
            alert('Không tìm thấy người dùng!');
            return;
          }
          
          const newRole = prompt(`Đổi role cho ${user.displayName || user.email}:\nNhập 'admin' hoặc 'user'`, user.role || 'user');
          
          if (newRole && (newRole === 'admin' || newRole === 'user')) {
            window._firebase.ref(`users/${uid}`).update({ role: newRole })
              .then(() => {
                alert(`✅ Đã cập nhật role thành: ${newRole}`);
                loadDashboard(); // Reload
              })
              .catch(err => {
                alert('❌ Lỗi: ' + err.message);
              });
          } else if (newRole !== null) {
            alert('Role không hợp lệ! Chỉ nhập "admin" hoặc "user"');
          }
        })
        .catch(err => console.error('Error editing user:', err));
    }
    
    /* deleteUser removed — account deletion must be performed via Firebase Console */
    
    // ===== TRAFFIC ANALYTICS =====
    
    let trafficChart = null;
    
    function loadTrafficAnalytics() {
  console.debug('📊 Loading traffic analytics...');
      
      if (!window._firebase) {
        console.error('❌ Firebase not initialized');
        return;
      }
      
      // Load user visits from DB
      return window._firebase.ref('analytics/visits').once('value')
        .then((snapshot) => {
          const visits = snapshot.val() || {};
          
          // Aggregate by date (last 7 days)
          const last7Days = [];
          const today = new Date();
          for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            last7Days.push(dateStr);
          }
          
          // Count unique users per day
          const dailyVisits = {};
          last7Days.forEach(date => dailyVisits[date] = new Set());
          
          Object.entries(visits).forEach(([visitId, visit]) => {
            const visitDate = new Date(visit.timestamp).toISOString().split('T')[0];
            if (dailyVisits[visitDate]) {
              dailyVisits[visitDate].add(visit.uid);
            }
          });
          
          const labels = last7Days.map(date => {
            const d = new Date(date);
            return `${d.getDate()}/${d.getMonth() + 1}`;
          });
          
          const data = last7Days.map(date => dailyVisits[date].size);
          
          // Total visits count
          const totalVisits = Object.keys(visits).length;
          document.getElementById('totalVisitsCount').textContent = `${totalVisits} lượt truy cập`;
          
          renderTrafficChart(labels, data);
        })
        .catch(err => console.error('Error loading analytics:', err));
    }
    
    function renderTrafficChart(labels, data) {
      const ctx = document.getElementById('trafficChart');
      if (!ctx) return;
      
      // Destroy existing chart
      if (trafficChart) {
        trafficChart.destroy();
      }
      
      trafficChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Người dùng duy nhất',
            data: data,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
      
  console.debug('📈 Chart rendered successfully');
    }
    
    // CRITICAL: Home button MUST work immediately
    document.addEventListener('DOMContentLoaded', () => {
      const homeBtn = document.getElementById('homeBtnHeader');
      if (homeBtn) {
  console.debug('✅ Home button found, attaching listener');
        homeBtn.addEventListener('click', (e) => {
          e.preventDefault();
          console.debug('🏠 Home button clicked, redirecting...');
          window.location.href = 'index.html';
        });
      } else {
        console.error('❌ Home button NOT found!');
      }
      
      // Setup smooth scroll navigation
      setupNavigation();
    });
    
    // Setup navigation with smooth scroll
    function setupNavigation() {
      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          
          // Remove active class from all links
          navLinks.forEach(l => l.classList.remove('active'));
          
          // Add active class to clicked link
          link.classList.add('active');
          
          // Get section ID
          const sectionId = link.getAttribute('data-section');
          const section = document.getElementById(sectionId);
          
          if (section) {
            // Smooth scroll to section
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        });
      });
    }

    // Loading overlay helpers
    function showAdminLoading() {
      const ov = document.getElementById('adminLoadingOverlay');
      if (ov) ov.style.display = 'flex';
    }

    function hideAdminLoading() {
      const ov = document.getElementById('adminLoadingOverlay');
      if (ov) ov.style.display = 'none';
    }
    
    // Load leaves list
    let currentLeafView = 'list';
    
    function loadLeavesList() {
  console.debug('🍃 Loading leaves list...');
      
      const leafList = document.getElementById('leafList');
      if (!leafList) return;
      
      leafList.innerHTML = '<div class="empty-state"><span class="empty-state-icon">⏳</span><p>Đang tải...</p></div>';
      return window._firebase.ref('leaves').once('value')
        .then(async (snapshot) => {
          const leaves = snapshot.val() || {};
          const leafArray = Object.entries(leaves).map(([id, leaf]) => ({
            id,
            ...leaf
          }));
          
          // Sort by timestamp (newest first)
          leafArray.sort((a, b) => (b.ts || 0) - (a.ts || 0));
          
          // Update count
          document.getElementById('totalLeavesCount').textContent = `${leafArray.length} lá cây`;
          
          if (leafArray.length === 0) {
            leafList.innerHTML = '<div class="empty-state"><span class="empty-state-icon">🍃</span><p>Chưa có lá cây nào</p></div>';
            return;
          }
          
          // Load user data for authors
          const usersSnapshot = await window._firebase.ref('users').once('value');
          const users = usersSnapshot.val() || {};
          
          // Render based on current view mode
          if (currentLeafView === 'list') {
            renderLeavesList(leafArray, users);
          } else {
            renderLeavesGrid(leafArray, users);
          }
        })
        .catch(err => {
          console.error('Error loading leaves:', err);
          leafList.innerHTML = '<div class="empty-state"><span class="empty-state-icon">❌</span><p>Không thể tải danh sách lá cây</p></div>';
        });
    }
    
    function renderLeavesList(leaves, users) {
      const leafList = document.getElementById('leafList');
      leafList.className = 'leaf-list';
      
      leafList.innerHTML = leaves.map(leaf => {
        const author = users[leaf.authorId];
        const authorName = author ? (author.displayName || author.email) : leaf.author;
        const authorInitial = authorName.charAt(0).toUpperCase();
        const timeStr = formatTimeAgo(leaf.ts);
        const leafIcon = getLeafIcon(leaf.shapeKey);
        
        return `
          <div class="leaf-item">
            <div class="leaf-icon">${leafIcon}</div>
            <div class="leaf-content">
              <p class="leaf-text">${escapeHtml(leaf.text)}</p>
              <div class="leaf-meta">
                <div class="leaf-author">
                  <div class="leaf-author-avatar">${authorInitial}</div>
                  <span>${authorName}</span>
                </div>
                <span class="leaf-time">${timeStr}</span>
                ${leaf.scale ? `<span class="leaf-stats">Kích thước: ${(leaf.scale * 100).toFixed(0)}%</span>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function renderLeavesGrid(leaves, users) {
      const leafList = document.getElementById('leafList');
      leafList.className = 'leaf-grid';
      
      leafList.innerHTML = leaves.map(leaf => {
        const author = users[leaf.authorId];
        const authorName = author ? (author.displayName || author.email) : leaf.author;
        const authorInitial = authorName.charAt(0).toUpperCase();
        const timeStr = formatTimeAgo(leaf.ts);
        const leafIcon = getLeafIcon(leaf.shapeKey);
        
        return `
          <div class="leaf-card">
            <div class="leaf-card-header">
              <div class="leaf-author">
                <div class="leaf-author-avatar">${authorInitial}</div>
                <span>${authorName}</span>
              </div>
              <span class="leaf-icon">${leafIcon}</span>
            </div>
            <p class="leaf-card-text">${escapeHtml(leaf.text)}</p>
            <div class="leaf-meta">
              <span class="leaf-time">${timeStr}</span>
              ${leaf.scale ? `<span class="leaf-stats">×${leaf.scale.toFixed(1)}</span>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function switchLeafView(mode) {
      currentLeafView = mode;
      
      // Update button states
      const listBtn = document.getElementById('listViewBtn');
      const gridBtn = document.getElementById('gridViewBtn');
      
      if (mode === 'list') {
        listBtn.classList.add('active');
        gridBtn.classList.remove('active');
      } else {
        gridBtn.classList.add('active');
        listBtn.classList.remove('active');
      }
      
      // Reload with new view
      loadLeavesList();
    }
    
    function getLeafIcon(shapeKey) {
      const icons = {
        'heart': '❤️',
        'maple': '🍁',
        'oval': '🌿',
        'pointed': '🍃',
        'round': '🌱',
        'star': '⭐',
        'willow': '🌾',
        'special': '✨'
      };
      return icons[shapeKey] || '🍃';
    }
    
    function formatTimeAgo(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'Vừa xong';
      if (minutes < 60) return `${minutes} phút trước`;
      if (hours < 24) return `${hours} giờ trước`;
      if (days < 30) return `${days} ngày trước`;
      
      const date = new Date(timestamp);
      return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
  <!-- Scroll-to-top button: appears when user scrolls down inside page or admin container -->
  <button id="scrollTopBtn" aria-hidden="true" role="button" title="Lên đầu trang" style="display:none;position:fixed;right:20px!important;bottom:20px!important;top:auto!important;background:#3b82f6;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;box-shadow:0 6px 18px rgba(59,130,246,0.18);font-weight:600;z-index:100000;transition:opacity 220ms ease,transform 220ms ease;opacity:0;transform:translateY(6px);">⬆ Lên đầu</button>

  <script>
    // Robust scroll-to-top behavior with observers & debounce to stabilize visibility when content changes
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('scrollTopBtn');
      if (!btn) return;

      const THRESHOLD = 80; // px scrolled before showing button
      let visible = false;
      let hideTimer = null;

      function isElementScrollable(el) {
        return el && el.scrollHeight > el.clientHeight + 1; // small tolerance
      }

      function getWindowScrollY() {
        return window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
      }

      let isAutoScrolling = false;
      let lastUserScroll = 0;

      function doScrollTop() {
        const adminContent = document.querySelector('.admin-content');
        isAutoScrolling = true;
        try {
          if (adminContent && isElementScrollable(adminContent)) {
            adminContent.scrollTo({ top: 0, behavior: 'smooth' });
          }
        } catch (e) { }

        try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch (e) { window.scrollTo(0, 0); }

        setTimeout(() => { isAutoScrolling = false; debouncedUpdate(); }, 800);
      }

      // delegated click handled later by doScrollTopAll bindings

      function showButton() {
        if (visible) return;
        visible = true;
        try {
          btn.style.display = 'block';
          void btn.offsetWidth;
          btn.style.opacity = '1';
          btn.style.transform = 'translateY(0)';
          btn.style.pointerEvents = 'auto';
        } catch (e) { }
      }

      function hideButton() {
        if (!visible) return;
        visible = false;
        try {
          btn.style.opacity = '0';
          btn.style.transform = 'translateY(12px)';
          btn.style.pointerEvents = 'none';
          clearTimeout(hideTimer);
          hideTimer = setTimeout(() => { try { btn.style.display = 'none'; } catch(e){} }, 300);
        } catch (e) { }
      }

      function updateVisibility() {
        try {
          const now = Date.now();
          const winY = getWindowScrollY();
          const docScrollable = (document.documentElement.scrollHeight - window.innerHeight) > THRESHOLD;
          const adminContent = document.querySelector('.admin-content');

          let adminScrolled = false;
          let adminIsScrollable = false;
          if (adminContent) {
            adminIsScrollable = isElementScrollable(adminContent);
            adminScrolled = adminContent.scrollTop > THRESHOLD;
          }

          const scrolled = winY > THRESHOLD || adminScrolled || adminIsScrollable || docScrollable;

          // Only show when user recently performed a scroll/interaction and not during auto-scroll
          const userActionRecently = (Date.now() - lastUserScroll) < 1200;
          if (scrolled && userActionRecently && !isAutoScrolling) {
            showButton();
          } else {
            hideButton();
          }
        } catch (err) {
          // silent fail
        }
      }

      // Debounce helper
      function debounce(fn, wait) {
        let t = null;
        return function(...args) {
          clearTimeout(t);
          t = setTimeout(() => fn.apply(this, args), wait);
        };
      }

      const debouncedUpdate = debounce(updateVisibility, 120);

      // Track user-initiated interactions so we can show the button only for user scrolls
      function markUserScroll() { lastUserScroll = Date.now(); }
      ['wheel', 'touchstart', 'touchmove', 'keydown', 'pointerdown'].forEach(evt => {
        window.addEventListener(evt, markUserScroll, { passive: true });
      });

      // Initial and event listeners
      updateVisibility();
      window.addEventListener('scroll', debouncedUpdate, { passive: true });
      window.addEventListener('resize', debouncedUpdate);
      document.addEventListener('scroll', debouncedUpdate, { passive: true });

      const adminContent = document.querySelector('.admin-content');
      if (adminContent) {
        adminContent.addEventListener('scroll', debouncedUpdate, { passive: true });

        // Observe size changes in adminContent
        if (window.ResizeObserver) {
          try {
            const ro = new ResizeObserver(debouncedUpdate);
            ro.observe(adminContent);
            ro.observe(document.documentElement);
          } catch (e) { /* ignore */ }
        }

        // Observe DOM changes that may affect scrollability
        if (window.MutationObserver) {
          try {
            const mo = new MutationObserver(debouncedUpdate);
            mo.observe(adminContent, { childList: true, subtree: true, attributes: true });
          } catch (e) { /* ignore */ }
        }
      } else {
        // If adminContent not found yet, watch for it briefly
        const waitFor = setInterval(() => {
          const ac = document.querySelector('.admin-content');
          if (ac) {
            clearInterval(waitFor);
            ac.addEventListener('scroll', debouncedUpdate, { passive: true });
          }
        }, 200);
        setTimeout(() => clearInterval(waitFor), 5000);
      }

      // Also update on full load in case images/fonts change layout
      window.addEventListener('load', debouncedUpdate);
      
      // Fallback: detect wheel/touch events that may not fire scroll listeners on some setups
      window.addEventListener('wheel', (e) => {
        try { debouncedUpdate(); } catch(e){}
      }, { passive: true });
      window.addEventListener('touchmove', (e) => {
        try { debouncedUpdate(); } catch(e){}
      }, { passive: true });

      // Expand click behavior to target multiple possible scroll roots so click always works
      const scrollRoots = () => {
        const roots = [];
        try { if (document.scrollingElement) roots.push(document.scrollingElement); } catch(e){}
        try { if (document.documentElement) roots.push(document.documentElement); } catch(e){}
        try { if (document.body) roots.push(document.body); } catch(e){}
        try { const ac = document.querySelector('.admin-content'); if (ac) roots.push(ac); } catch(e){}
        try {
          // include any overflow:auto descendants inside admin-content
          const els = document.querySelectorAll('.admin-content *');
          els.forEach(el => {
            try {
              const s = window.getComputedStyle(el);
              if (s && (s.overflow === 'auto' || s.overflowY === 'auto' || s.overflowY === 'scroll')) roots.push(el);
            } catch(e){}
          });
        } catch(e){}
        return roots.filter(Boolean);
      };

      const doScrollTopAll = () => {
        isAutoScrolling = true;
        const roots = scrollRoots();
        let did = false;
        for (const r of roots) {
          try {
            if (typeof r.scrollTo === 'function') {
              r.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
              r.scrollTop = 0;
            }
            did = true;
          } catch (e) { try { r.scrollTop = 0; did = true; } catch(e){} }
        }
        // As a final fallback, scroll window directly
        try { window.scrollTo({ top: 0, behavior: 'smooth' }); did = true; } catch(e) { try { window.scrollTo(0,0); did = true; } catch(e){} }
        // If nothing moved, force-set documentElement/body
        if (!did) {
          try { document.documentElement.scrollTop = 0; document.body.scrollTop = 0; } catch(e){}
        }
        // ensure auto-scroll mode clears after short delay
        setTimeout(() => { isAutoScrolling = false; debouncedUpdate(); }, 900);
      };

      // Replace previous direct doScrollTop usage in click handlers by doScrollTopAll
      // Attach delegated click handler to ensure we always call the new function
  btn.removeEventListener && btn.removeEventListener('click', null);
  btn.addEventListener('click', (e) => { e.preventDefault(); doScrollTopAll(); });
      document.removeEventListener && document.removeEventListener('click', null);
      document.addEventListener('click', (e) => {
        const el = e.target && e.target.closest ? e.target.closest('#scrollTopBtn') : null;
        if (el) { e.preventDefault(); doScrollTopAll(); }
      });
    });
  </script>

</body>
</html>